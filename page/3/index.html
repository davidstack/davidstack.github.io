<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"damonyi.cc","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="雾里云里">
<meta property="og:type" content="website">
<meta property="og:title" content="云里雾里">
<meta property="og:url" content="http://damonyi.cc/page/3/index.html">
<meta property="og:site_name" content="云里雾里">
<meta property="og:description" content="雾里云里">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://damonyi.cc/page/3/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<title>云里雾里</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">云里雾里</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">雾里云里</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Kubernetes%E4%B8%AD%E7%9A%84Source-Ip%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Kubernetes%E4%B8%AD%E7%9A%84Source-Ip%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Kubernetes中的Source Ip机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:11:11 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T19:11:11+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>你必须拥有一个正常工作的 Kubernetes 1.5 集群，用来运行本文中的示例。该示例使用一个简单的 nginx webserver 回送它接收到的请求的 HTTP 头中的源 IP 地址。你可以像下面这样创建它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run source-ip-app --image&#x3D;k8s.gcr.io&#x2F;echoserver:1.4</span><br><span class="line">deployment &quot;source-ip-app&quot; created</span><br></pre></td></tr></table></figure>

<h2 id="Type-ClusterIP-类型-Services-的-Source-IP"><a href="#Type-ClusterIP-类型-Services-的-Source-IP" class="headerlink" title="Type=ClusterIP 类型 Services 的 Source IP"></a>Type=ClusterIP 类型 Services 的 Source IP</h2><p>如果你的 kube-proxy 运行在 iptables 模式下，从集群内部发送到 ClusterIP 的包永远不会进行源地址 NAT，这从 Kubernetes 1.2 开始是默认选项。Kube-proxy 通过一个 proxyMode endpoint 暴露它的模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME                           STATUS     AGE     VERSION</span><br><span class="line">kubernetes-minion-group-6jst   Ready      2h      v1.6.0+fff5156</span><br><span class="line">kubernetes-minion-group-cx31   Ready      2h      v1.6.0+fff5156</span><br><span class="line">kubernetes-minion-group-jj1t   Ready      2h      v1.6.0+fff5156</span><br><span class="line">kubernetes-minion-group-6jst $ curl localhost:10249&#x2F;proxyMode</span><br><span class="line">iptables</span><br></pre></td></tr></table></figure>

<p>你可以通过在 source IP 应用上创建一个服务来测试源 IP 保留。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment source-ip-app --name&#x3D;clusterip --port&#x3D;80 --target-port&#x3D;8080</span><br><span class="line">service &quot;clusterip&quot; exposed</span><br><span class="line"></span><br><span class="line">$ kubectl get svc clusterip</span><br><span class="line">NAME         CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">clusterip    10.0.170.92   &lt;none&gt;        80&#x2F;TCP    51s</span><br><span class="line">&#96;&#96;&#96;&#96;&#96;&#96;</span><br><span class="line"></span><br><span class="line">从相同集群中的一个 pod 访问这个 ClusterIP：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>$ kubectl run busybox -it –image=busybox –restart=Never –rm<br>Waiting for pod default/busybox to be running, status is Pending, pod ready: false<br>If you don’t see a command prompt, try pressing enter.<br># ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>3: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1460 qdisc noqueue<br>    link/ether 0a:58:0a:f4:03:08 brd ff:ff:ff:ff:ff:ff<br>    inet 10.244.3.8/24 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::188a:84ff:feb0:26a5/64 scope link<br>       valid_lft forever preferred_lft forever</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p># wget -qO - 10.0.170.92<br>CLIENT VALUES:<br>client_address=10.244.3.8<br>command=GET<br>…</p>
<p>````</p>
<p>如果客户端 pod 和 服务端 pod 在相同的节点上，client_address 就是客户端 pod 的 IP 地址。但是，如果它们在不同的节点上， client_address 将会是客户端 pod 所在节点的 flannel IP 地址。</p>
<h2 id="Type-NodePort-类型-Services-的-Source-IP"><a href="#Type-NodePort-类型-Services-的-Source-IP" class="headerlink" title="Type=NodePort 类型 Services 的 Source IP"></a>Type=NodePort 类型 Services 的 Source IP</h2><p>      对于 Kubernetes 1.5，发送给类型为 Type=NodePort Services 的数据包默认进行源地址 NAT。你可以创建一个 NodePort Service 来进行测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment source-ip-app --name&#x3D;nodeport --port&#x3D;80 --target-port&#x3D;8080 --type&#x3D;NodePort</span><br><span class="line">service &quot;nodeport&quot; exposed</span><br><span class="line">$ NODEPORT&#x3D;$(kubectl get -o jsonpath&#x3D;&quot;&#123;.spec.ports\[0\].nodePort&#125;&quot; services nodeport)</span><br><span class="line">$ NODES&#x3D;$(kubectl get nodes -o jsonpath&#x3D;&#39;&#123; $.items\[\*\].status.addresses\[?(@.type&#x3D;&#x3D;&quot;ExternalIP&quot;)\].address &#125;&#39;)</span><br></pre></td></tr></table></figure>

<p>如果你的集群运行在一个云服务上，你可能需要为上面报告的 nodes:nodeport 开启一条防火墙规则。 现在，你可以通过上面分配的节点端口从外部访问这个 Service。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ for node in $NODES; do curl -s $node:$NODEPORT | grep -i client\_address; done</span><br><span class="line">client\_address&#x3D;10.180.1.1</span><br><span class="line">client\_address&#x3D;10.240.0.5</span><br><span class="line">client\_address&#x3D;10.240.0.3</span><br></pre></td></tr></table></figure>

<p>请注意，这些并不是正确的客户端 IP，它们是集群的内部 IP。这是所发生的事情：</p>
<p>1、客户端发送数据包到 node2:nodePort</p>
<p>2、node2 使用它自己的 IP 地址替换数据包的源 IP 地址（SNAT）</p>
<p>3、node2 使用 pod IP 地址替换数据包的目的 IP 地址</p>
<p>4、数据包被路由到 node 1，然后交给 endpoint</p>
<p>5、Pod 的回复被路由回 node2</p>
<p>6、Pod 的回复被发送回给客户端</p>
<p>形象的：<br> <img src="/2020/09/21/Kubernetes%E4%B8%AD%E7%9A%84Source-Ip%E6%9C%BA%E5%88%B6/1526621848885868.png" alt="avatar"></p>
<p>      为了防止这种情况发生，Kubernetes 提供了一个特性来保留客户端的源 IP 地址(点击此处查看可用特性)。设置 service.spec.externalTrafficPolicy 的值为 Local，请求就只会被代理到本地 endpoints 而不会被转发到其它节点。这样就保留了最初的源 IP 地址。如果没有本地 endpoints，发送到这个节点的数据包将会被丢弃。这样在应用到数据包的任何包处理规则下，你都能依赖这个正确的 source-ip 使数据包通过并到达 endpoint。</p>
<p>   设置 service.spec.externalTrafficPolicy 字段如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch svc nodeport -p &#39;&#123;&quot;spec&quot;:&#123;&quot;externalTrafficPolicy&quot;:&quot;Local&quot;&#125;&#125;&#39;</span><br><span class="line">service &quot;nodeport&quot; patched</span><br></pre></td></tr></table></figure>

<p>现在，重新运行测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ for node in $NODES; do curl --connect-timeout 1 -s $node:$NODEPORT | grep -i client\_address; done</span><br><span class="line">client\_address&#x3D;104.132.1.79</span><br></pre></td></tr></table></figure>

<p>   请注意，你只从 endpoint pod 运行的那个节点得到了一个回复，这个回复有*正确的*客户端 IP。</p>
<p>这是发生的事情：</p>
<p>1、客户端发送数据包到 node2:nodePort，它没有任何 endpoints</p>
<p>2、数据包被丢弃</p>
<p>3、客户端发送数据包到 node1:nodePort，它*有*endpoints</p>
<p>4、node1 使用正确的源 IP 地址将数据包路由到 endpoint</p>
<p>形象的：<br> <img src="/2020/09/21/Kubernetes%E4%B8%AD%E7%9A%84Source-Ip%E6%9C%BA%E5%88%B6/1526622213101501.png" alt="avatar"></p>
<h2 id="Type-LoadBalancer-类型-Services-的-Source-IP"><a href="#Type-LoadBalancer-类型-Services-的-Source-IP" class="headerlink" title="Type=LoadBalancer 类型 Services 的 Source IP"></a>Type=LoadBalancer 类型 Services 的 Source IP</h2><p>      对于 Kubernetes 1.5，发送给类型为 Type=LoadBalancer Services 的数据包默认进行源地址 NAT，这是由于所有处于 Ready 状态的 Kubernetes 节点对于负载均衡的流量都是符合条件的。所以如果数据包到达一个没有 endpoint 的节点，系统将把这个包代理到有 endpoint 的节点，并替换数据包的源 IP 为节点的 IP（如前面章节所述）。</p>
<p>    你可以通过在一个 loadbalancer 上暴露这个 source-ip-app 来进行测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment source-ip-app --name&#x3D;loadbalancer --port&#x3D;80 --target-port&#x3D;8080 --type&#x3D;LoadBalancer</span><br><span class="line">service &quot;loadbalancer&quot; exposed</span><br><span class="line">$ kubectl get svc loadbalancer</span><br><span class="line">NAME           CLUSTER-IP    EXTERNAL-IP       PORT(S)   AGE</span><br><span class="line">loadbalancer   10.0.65.118   104.198.149.140   80&#x2F;TCP    5m</span><br><span class="line">$ curl 104.198.149.140</span><br><span class="line">CLIENT VALUES:</span><br><span class="line">client\_address&#x3D;10.240.0.5</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>      然而，如果你的集群运行在 Google Kubernetes Engine/GCE 上，设置 service.spec.externalTrafficPolicy 字段值为 Local 可以强制使没有 endpoints 的节点把他们自己从负载均衡流量的可选节点名单中删除。这是通过故意使它们健康检查失败达到的。</p>
<p>形象的：<br> <img src="/2020/09/21/Kubernetes%E4%B8%AD%E7%9A%84Source-Ip%E6%9C%BA%E5%88%B6/1526622380157076.png" alt="avatar"></p>
<p>你可以设置 annotation 来进行测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch svc loadbalancer -p &#39;&#123;&quot;spec&quot;:&#123;&quot;externalTrafficPolicy&quot;:&quot;Local&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>你应该能够立即看到 Kubernetes 分配的 service.spec.healthCheckNodePort 字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc loadbalancer -o yaml | grep -i healthCheckNodePort</span><br><span class="line">  healthCheckNodePort: 32122</span><br></pre></td></tr></table></figure>

<p>service.spec.healthCheckNodePort 字段指向每个节点在 /healthz 路径上提供的用于健康检查的端口。你可以这样测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o wide -l run&#x3D;source-ip-app</span><br><span class="line">NAME                            READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line">source-ip-app-826191075-qehz4   1&#x2F;1       Running   0          20h       10.180.1.136   kubernetes-minion-group-6jst</span><br><span class="line">kubernetes-minion-group-6jst $ curl localhost:32122&#x2F;healthz</span><br><span class="line">1 Service Endpoints found</span><br><span class="line">kubernetes-minion-group-jj1t $ curl localhost:32122&#x2F;healthz</span><br><span class="line">No Service Endpoints Found</span><br></pre></td></tr></table></figure>

<p>    主节点运行的 service 控制器负责分配 cloud loadbalancer。在这样做的同时，它也会分配指向每个节点的 HTTP 健康检查的 port/path。等待大约 10 秒钟之后，没有 endpoints 的两个节点的健康检查会失败，然后 curl 负载均衡器的 ip：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl 104.198.149.140</span><br><span class="line">CLIENT VALUES:</span><br><span class="line">client\_address&#x3D;104.132.1.79</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="跨平台支持"><a href="#跨平台支持" class="headerlink" title="跨平台支持"></a>跨平台支持</h2><p>     由于 Kubernetes 1.5 在类型为 Type=LoadBalancer 的 Services 中支持源 IP 保存的特性仅在 cloudproviders 的子集中实现（GCP and Azure）。你的集群运行的 cloudprovider 可能以某些不同的方式满足 loadbalancer 的要求：</p>
<p>1、使用一个代理终止客户端连接并打开一个到你的 nodes/endpoints 的新连接。在这种情况下，源 IP 地址将永远是云负载均衡器的地址而不是客户端的。</p>
<p>2、使用一个包转发器，因此从客户端发送到负载均衡器 VIP 的请求在拥有客户端源 IP 地址的节点终止，而不被中间代理。</p>
<p>      第一类负载均衡器必须使用一种它和后端之间约定的协议来和真实的客户端 IP 通信，例如 HTTP X-FORWARDED-FOR 头，或者 proxy 协议。 第二类负载均衡器可以通过简单的在保存于 Service 的 service.spec.healthCheckNodePort 字段上创建一个 HTTP 健康检查点来使用上面描述的特性。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Kubernetes-%E8%AF%A6%E8%A7%A3-%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Kubernetes-%E8%AF%A6%E8%A7%A3-%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">Kubernetes 详解--简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:10:25 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T19:10:25+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>K8s 开源平台：跨集群主机的自动化部署、伸缩、应用管理，提供以容器为中心的基础设施。</p>
<p>1、迅速部署应用或者定时部署</p>
<p>2、伸缩应用</p>
<p>3、无缝升级回滚应用</p>
<p>4、最大化利用硬件资源（每个应用只分配它所需要的资源）</p>
<p>容器相对于虚拟机的优势：</p>
<p>1、应用的敏捷创建和部署：得益于容器镜像的轻量级</p>
<p>2、持续的部署、集成、部署：提供可靠搞笑的容器镜像制作和部署，易于回滚(基于镜像部署时，镜像并不会改变)</p>
<p>3、Dev和ops 分离：在编译发布阶段创建容器镜像，而不是在部署阶段。能够将应用的运行和基础设施分离</p>
<p>4、开发、测试、生产三种场景，可以在笔记本也可以在公有云</p>
<p>5、不感知操作系统：Centos、Ubuntu，各种容器引擎，都可以。</p>
<p>6、以应用为中心的管理：不感知底层资源（基于虚拟机还是物理机）</p>
<p>7、松散，分布式、弹性、无约束的微服务</p>
<p>8、资源隔离：应用性能可以预测</p>
<p>9、资源利用率：高效率和密集度的资源利用</p>
<p>Kubernets可以将运行在物理或者虚拟机集群，可以将应用从主机架构的基础设施迁移到以容器为中心的基础设施。Kubernets 主要是构建以容器为中心的基础设施。Kubernets满足了将应用运行到生产环境的大部分需求：</p>
<p>1、容器级别的进程协作:组合复杂应用，同时保留 一个应用一个容器的模型，参考Kubernets POD的概念</p>
<p>2、挂载存储</p>
<p>3、密钥管理</p>
<p>4、应用健康检查</p>
<p>5、水平弹性伸缩</p>
<p>6、命名和服务发现</p>
<p>7、负载均衡</p>
<p>8、滚动升级</p>
<p>9、资源监控</p>
<p>10、日志收集</p>
<p>11、<a target="_blank" rel="noopener" href="http://kubernetes.io/docs/user-guide/introspection-and-debugging/">support for introspection and debugging</a></p>
<p>12、认证和权限控制</p>
<p>l  Kubernets 不是一个传统的，全部包含的Paas。K8s不限制运行在k8s的应用运行环境，不区分应用和服务这两个概念。K8s目标是能够支持极端多样的负载，包含无状态、有状态、数据处理流。如果一个应用能够运行在Container，那么它就能够运行在K8s</p>
<p>l  K8s不提供中间件服务，消息中间件，数据处理框架、数据库，不提供集群存储并不会内置到K8s，但是这些服务可以运行到K8s</p>
<p>l  K8s 不提供一键部署的Service Market</p>
<p>l  K8s 不会部署源码，不会build 应用。CI因人而已</p>
<p>l  K8s 允许用户选择日志，监控，告警</p>
<p>l  K8s 没有提供，也没有强制一个综合的应用管理系统</p>
<p>l  K8s 没有提供也没有采用任何复杂的集群配置、维护、管理、自愈系统</p>
<p>K8s主要进行应用级别的管理，提供一些通用的应用管理特性：部署、扩容、负载均衡、日志、监控。然而k8s并不是单一的整理，这些默认的解决方案都是可选，可插拔的</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Kubernetes%E8%AF%A6%E8%A7%A3-Pod/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Kubernetes%E8%AF%A6%E8%A7%A3-Pod/" class="post-title-link" itemprop="url">Kubernetes详解--Pod</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:08:27 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T19:08:27+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="（题外话：之前研究了好多开源软件，但是每当研究开源软件的时候，感觉了解的都不是很透彻，这次尝试研究官方文档，看看效果如何，下面的资料，是按照官方文档翻译的，比较笨，但是了解更深入了，希望能坚持下来-）"><a href="#（题外话：之前研究了好多开源软件，但是每当研究开源软件的时候，感觉了解的都不是很透彻，这次尝试研究官方文档，看看效果如何，下面的资料，是按照官方文档翻译的，比较笨，但是了解更深入了，希望能坚持下来-）" class="headerlink" title="（题外话：之前研究了好多开源软件，但是每当研究开源软件的时候，感觉了解的都不是很透彻，这次尝试研究官方文档，看看效果如何，下面的资料，是按照官方文档翻译的，比较笨，但是了解更深入了，希望能坚持下来**）**"></a><strong>（题外话：之前研究了好多开源软件，但是每当研究开源软件的时候，感觉了解的都不是很透彻，这次尝试研究官方文档，看看效果如何，下面的资料，是按照官方文档翻译的，比较笨，但是了解更深入了，希望能坚持下来**</strong>）**</h3><h3 id="1-1-1-POD"><a href="#1-1-1-POD" class="headerlink" title="1.1.1 POD"></a>1.1.1 POD</h3><p>一组容器（一个或者多个Container），共享存储，以相同的方式运行、Pods的容器位于同一节点，被一起调度，同时部署，启动、重启、删除，伸缩，运行在相同的Context。POD的模型对应 应用专属的逻辑主机，他包含一个或多个相对紧耦合的应用容器。PS：在使用容器之前，这些应用可能需要部署在相同的物理机或者虚拟机。</p>
<p>POD内Container共享的上下文包括：Linux Namespace、cgroups等（Docker相关的隔离策略），在POD的上下文中，每个应用可能会有深层次的隔离</p>
<p>POD内的容器共享一个IP和PORT空间，容器可以通过localhost 互相发现，容器也可以通过标准的内部进程进行交互（System V semaphores 或者Posix 共享内存），不同POD内的容器具有不同的IP，无法通过IPC进行交互</p>
<p> POD内的容器可以访问共享卷，可以被挂载到每个应用的文件系统。</p>
<p>当POD所在节点挂掉后，该POD不会被重新调度到其他节点，而是一个新的POD在其他节点创建，uuid不同（将来版本，可能会提供迁移POD的功能），与POD同生命周期的概念，具体是指和该uuid pod的生命周期相同。</p>
<h3 id="1-1-2-POD-产生原因"><a href="#1-1-2-POD-产生原因" class="headerlink" title="1.1.2 POD 产生原因"></a>1.1.2 POD 产生原因</h3><p>l  管理，POD的模型可以理解为：由多个可以组成一个服务的协作进程的集合。这种模式提供了比Container更高一层的抽象，从而简化了部署和管理。POD作为部署、水平伸缩，副本的执行单元。POD内的Container统一调度、拥有一样的生命周期、一致的副本，资源共享、统一的依赖管理</p>
<p>l  资源共享和通信：POD资源Containers的资源共享和通信。POD中的Container的host name 和POD的name相同</p>
<p>POD虽然也可以部署一组垂直的容器，例如LAMP，但是POD的主要目的是用于以下程序:</p>
<p>1、 content management systems, file and data loaders, local cache managers, etc.</p>
<p>2、 log and checkpoint backup, compression, rotation, snapshotting, etc.</p>
<p>3、 data change watchers, log tailers, logging and monitoring adapters, event publishers, etc.</p>
<p>4、 proxies, bridges, and adapters</p>
<p>5、 controllers, managers, configurators, and updaters</p>
<h3 id="1-1-3-POD-删除"><a href="#1-1-3-POD-删除" class="headerlink" title="1.1.3 POD 删除"></a>1.1.3 POD 删除</h3><p>POD 代表一组运行的进程，所以应该能够优雅的终止这些进程（让这些进程能够执行一些数据清理，而不是直接kill），用户应能够请求删除POD，并指导什么时候该POD会被删除，并且能够确保POD内的进程最终被删除。当用户请求删除POD时，系统会记录可以允许该POD多久进行自我删除，超过该时间，TERM信号就会发送到POD内的全部容器。当POD正在删除过程中，Kubelete或者容器被重启，终止进程将会重新开始删除Pod（with full grace period）</p>
<p>一个删除流程的例子：</p>
<p>1．用户请求删除POD，默认的 grace period 是30s</p>
<p>2．API server更新该POD应该被删除的时间</p>
<p>3．当查询POD时，显示该POD “Terminating”</p>
<p>4．与第三步同步，当Kubelet发现Pod被标记为Terminating，kubelet开始关闭进程。</p>
<p>5．若Pod定义了 preStop hook，那么该hook会被激活，若该hook的运行时间超过了grace period，会再次执行第二步，grace period会变为30s+2s</p>
<p>6．发送TERM 信号到Pod内的进程</p>
<p>7．与第三步同时，POD将会从Service 的endpoint列表移除，但是关闭比较慢的POD 仍然可以进行服务访问（前提是svc没有被删除）</p>
<p>8．当grace period后，POD内仍然运行的进程都会收到SIGKILL信号</p>
<p>9．Kubelet在API server中设置grace period 为0 代表已经删除完成</p>
<p>默认情况下，POD会在30s内被删除，但是可以命令行设置该事件 通过 –grace-period=<seconds> ,0表示立即删除POD（这样该POD的名称可以尽快重复使用，但是该POD仍然会有一段比较小的grace period）</seconds></p>
<h3 id="1-1-4-Pod-的Privileged-模式"><a href="#1-1-4-Pod-的Privileged-模式" class="headerlink" title="1.1.4 Pod 的Privileged 模式"></a>1.1.4 Pod 的Privileged 模式</h3><p>K8s 1.1 版本以后，可以为Pod中的Container设置privileged模式，通过设置<strong>SecurityContext</strong> <strong>参数</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Kubernetes-%E8%AF%A6%E8%A7%A3-Replica-Sets-%E5%92%8CService/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Kubernetes-%E8%AF%A6%E8%A7%A3-Replica-Sets-%E5%92%8CService/" class="post-title-link" itemprop="url">Kubernetes 详解-Replica Sets 和Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:07:03 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T19:07:03+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-1-Replica-Sets"><a href="#1-1-Replica-Sets" class="headerlink" title="1.1 Replica Sets"></a>1.1 Replica Sets</h2><p>下一代的Replication Controller，两者的区别主要在选择器selector,Replica 支持集合级别的选择器，而前期的Replication Controller，支持在等号描述的选择器，kubectl命令支持使用replica sets （目前kubectl命令中的rolling-update 还不支持），目前replica sets主要用于deployment中</p>
<p>Replica Sets 能够确保在某个时间点上，一定数量的Pod在运行。然而Deployment 是Replica Sets更高一层的抽象，用于更新Pods 以及其他一些特性。推荐使用Deployment而不是直接使用Replica Set进行编排Pods。</p>
<h2 id="1-2-Service"><a href="#1-2-Service" class="headerlink" title="1.2 Service"></a>1.2 Service</h2><p>由于Pod的IP会变化，提供某些功能的POD如果IP发生变化，会导致其他Pod无法发现这些功能，因此 引入了Service的功能。</p>
<p>Service是一组逻辑Pod的抽象，定义了一个访问这些Pod的策略（或者叫做微服务），这些Service 通常通过Label Selector指向这些Pod。</p>
<p>举个例子：一个提供镜像处理的后端有三个运行的副本，这些副本是可以取代的，但是前端并不需要感知，这时就需要Service作为抽象</p>
<p>对于可以部署在K8s内部应用，K8s通过Endpoints Api更新Service对应的Pod集合，对于那些没K8s外部的应用，K8s提供了虚拟IP桥接到Service，然后Service重定向到Pod集合。</p>
<h3 id="1-2-1-Service-定义"><a href="#1-2-1-Service-定义" class="headerlink" title="1.2.1 Service 定义"></a>1.2.1 Service 定义</h3><p><strong>{</strong></p>
<p> <strong>“kind”**</strong>:**  <strong>“Service”**</strong>,**</p>
<p> <strong>“apiVersion”**</strong>:**  <strong>“v1”**</strong>,**</p>
<p> <strong>“metadata”**</strong>:**  <strong>{</strong></p>
<p> <strong>“name”**</strong>:**  <strong>“my-service”</strong></p>
<p> <strong>},</strong></p>
<p> <strong>“spec”**</strong>:**  <strong>{</strong></p>
<p> <strong>“selector”**</strong>:**  <strong>{</strong></p>
<p> <strong>“app”**</strong>:**  <strong>“MyApp”</strong></p>
<p> <strong>},</strong></p>
<p> <strong>“ports”**</strong>:**  <strong>[</strong></p>
<p> <strong>{</strong></p>
<p> <strong>“protocol”**</strong>:**  <strong>“TCP”**</strong>,**</p>
<p> <strong>“port”**</strong>:**  <strong>80**</strong>,**</p>
<p> <strong>“targetPort”**</strong>:**  <strong>9376</strong></p>
<p> <strong>}</strong></p>
<p> <strong>]</strong></p>
<p> <strong>}</strong></p>
<p><strong>}</strong></p>
<p>该Service 对应的Pod集合：带有label app=Myapp，对外暴露端口9376</p>
<p>Service 能将任意的流入Port 重定向到targetPort,默认情况下，targetPort和Port为相同值，不同的Pod 可以对应不同的端口号（例如，在你应用的下一个版本中会使用不同的端口号，但是并不应用之前版本的使用）</p>
<p>Service 支持UDP和TCP，默认是TCP</p>
<h3 id="1-2-2-Service-without-selector"><a href="#1-2-2-Service-without-selector" class="headerlink" title="1.2.2 Service without selector"></a>1.2.2 Service without selector</h3><p>Service可以抽象访问Pod集群，同时 Service也可以抽象其他后端</p>
<p>1、 在生产环境中使用外部数据库，在测试环境中使用自己的数据库</p>
<p>2、 将自己的Service指向其他集群或者其他命名空间的Service</p>
<p>3、 迁移应用到k8s，但是还是有些应用运行在k8s之外</p>
<p>通过定义不包含selector的Service实现</p>
<p><strong>{</strong></p>
<p> <strong>“kind”**</strong>:**  <strong>“Service”**</strong>,**</p>
<p> <strong>“apiVersion”**</strong>:**  <strong>“v1”**</strong>,**</p>
<p> <strong>“metadata”**</strong>:**  <strong>{</strong></p>
<p> <strong>“name”**</strong>:**  <strong>“my-service”</strong></p>
<p> <strong>},</strong></p>
<p> <strong>“spec”**</strong>:**  <strong>{</strong></p>
<p> <strong>“ports”**</strong>:**  <strong>[</strong></p>
<p> <strong>{</strong></p>
<p> <strong>“protocol”**</strong>:**  <strong>“TCP”**</strong>,**</p>
<p> <strong>“port”**</strong>:**  <strong>80**</strong>,**</p>
<p> <strong>“targetPort”**</strong>:**  <strong>9376</strong></p>
<p> <strong>}</strong></p>
<p><strong>]</strong></p>
<p> <strong>}</strong></p>
<p><strong>}</strong></p>
<p>Service 没有Selector，K8s不会创建Endpoints，你可以通过手动创建Endpoint指向自己的endpoint</p>
<p><strong>{</strong></p>
<p> <strong>“kind”**</strong>:**  <strong>“Endpoints”**</strong>,**</p>
<p> <strong>“apiVersion”**</strong>:**  <strong>“v1”**</strong>,**</p>
<p> <strong>“metadata”**</strong>:**  <strong>{</strong></p>
<p> <strong>“name”**</strong>:**  <strong>“my-service”</strong></p>
<p> <strong>},</strong></p>
<p> <strong>“subsets”**</strong>:**  <strong>[</strong></p>
<p> <strong>{</strong></p>
<p> <strong>“addresses”**</strong>:**  <strong>[</strong></p>
<p> <strong>{</strong>  <strong>“ip”**</strong>:**  <strong>“1.2.3.4”</strong>  <strong>}</strong></p>
<p> <strong>],</strong></p>
<p> <strong>“ports”**</strong>:**  <strong>[</strong></p>
<p> <strong>{</strong>  <strong>“port”**</strong>:**  <strong>9376</strong>  <strong>}</strong></p>
<p> <strong>]</strong></p>
<p> <strong>}</strong></p>
<p> <strong>]</strong></p>
<p><strong>}</strong></p>
<p>Endpoint的IP不能是loopback（127.0.0.1/8），link-local（169.254.0.0/16）, link-local multicast (224.0.0.0/24).</p>
<p>访问不含有selector的Service和访问含有Selector的Service 方式一样，都会讲流向重定向的endpoint</p>
<p> 其他命名空间的服务是一个特例，他不会定义ports和endpoint，他只是返回一个访问外部服务的别名</p>
<p><strong>{</strong></p>
<p> <strong>“kind”**</strong>:**  <strong>“Service”**</strong>,**</p>
<p> <strong>“apiVersion”**</strong>:**  <strong>“v1”**</strong>,**</p>
<p> <strong>“metadata”**</strong>:**  <strong>{</strong></p>
<p> <strong>“name”**</strong>:**  <strong>“my-service”**</strong>,**</p>
<p> <strong>“namespace”**</strong>:**  <strong>“prod”</strong></p>
<p> <strong>},</strong></p>
<p> <strong>“spec”**</strong>:**  <strong>{</strong></p>
<p> <strong>“type”**</strong>:**  <strong>“ExternalName”**</strong>,**</p>
<p> <strong>“externalName”**</strong>:**  <strong>“my.database.example.com”</strong></p>
<p> <strong>}</strong></p>
<p><strong>}</strong></p>
<p>当你访问服务<strong>my-service.prod.svc.CLUSTER**</strong>时，**<strong>cluster**</strong>的**<strong>dns**</strong>服务会返回记录**<strong>my.database.example.com</strong> <strong>的**</strong>CNAME**<strong>，这个重定向是发生在**</strong>dns**<strong>解析阶段。</strong></p>
<h3 id="1-2-3-虚拟IP-和服务代理"><a href="#1-2-3-虚拟IP-和服务代理" class="headerlink" title="1.2.3 虚拟IP 和服务代理"></a>1.2.3 虚拟IP 和服务代理</h3><h4 id="1-2-3-1-代理"><a href="#1-2-3-1-代理" class="headerlink" title="1.2.3.1 代理"></a>1.2.3.1 代理</h4><p>K8s集群内每个节点都会运行kube-proxy，负责实现服务的虚拟机IP（不是externalName）。1.0版本的代理模式在是userspace，1.1增加了iptables proxy，从1.2开始 iptables 代理是默认的模式</p>
<p>K8s 1.0的service是四层（TCP/UDP），从k8s1.1开始，增加了Ingress，实现七层（HTTP）服务</p>
<p><strong>用户空间的代理模式</strong></p>
<p>Kube-proxy监控k8s master节点来发现Service、Endpointd的增加和删除，对于Service，在本地打开一个随机端口作为代理端口，任何访问改代理端口的连接都会被指向Service对象的Pod集合，最终指向哪个Pod取决于Service的SessionAffinity，最后，他会配置iptables，捕获流向Service 的Cluster IP 和Port的连接，并重定向到这个代理端口。</p>
<p>最终结果，任何到Service Cluster Ip 和port的流量都会指向合适的Pod</p>
<p>默认情况下，都是轮训算法选择后端，也可以通过设置service.spec.sessionAffinity 为ClientIP，将选择算法改为Client-IP based session affinity</p>
<p><strong>Iptables**</strong>的代理模式**</p>
<p>该模式与userspace模式类似，只是没有这个代理端口</p>
<p>比userspace方式更快更可靠，然后与userspace方式不同，当选择的pod异常时，该方式无法自动尝试选择其他Pod。</p>
<p>1、userspace模式只不适合大规模集群使用（数千个服务）</p>
<p>2、userspace模式隐藏了访问服务的源IP，iptables模式虽然没有隐藏源IP，但是也是通过负载均衡或者nodeport 影响了客户端输入</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Kubernetes-Dashboard%E5%BC%80%E5%8F%91%E8%AF%B4%E6%98%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Kubernetes-Dashboard%E5%BC%80%E5%8F%91%E8%AF%B4%E6%98%8E/" class="post-title-link" itemprop="url">Kubernetes Dashboard开发说明</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 18:53:53 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T18:53:53+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  部门准备做一个Kuberentes的发行版，研究了一下Dashboard这个项目，以及这个项目应该如何开发，把一些总结写下。</p>
<h1 id="Dashboard-源码说明"><a href="#Dashboard-源码说明" class="headerlink" title="Dashboard 源码说明"></a>Dashboard 源码说明</h1><p>    dashboard 项目分为backend和frontend两部分，可以通过执行gulp serve进行调试运行，执行gulp build 进行编译<br> <img src="/2020/09/21/Kubernetes-Dashboard%E5%BC%80%E5%8F%91%E8%AF%B4%E6%98%8E/1504234553698022.png" alt="avatar"></p>
<p>       dashboard的backend项目封装了k8s API，heapster API 做了一层封装，包括封装分页查询、界面元数据重新组合等（这里的dashboard backend项目类似一个API 网关，可以集成多个项目的API，提供统一的接口给front项目使用，我们自己就在dashboard的基础上，增加了对tiller的调用）</p>
<p>      dashboard的front项目是基于angular js 实现，（个人对于这块也不是很熟悉，照葫芦画瓢了），封装了不少css，component，还是很好的模仿进行开发的，我在此基础增加了基于Chart创建应用</p>
<p> <img src="/2020/09/21/Kubernetes-Dashboard%E5%BC%80%E5%8F%91%E8%AF%B4%E6%98%8E/1504235671108490.png" alt="avatar"><br>###后端代码</p>
<p>   backend项目是一个golang 项目，main函数在dashboard.go 文件，我们开发的时候，主要是在backend/handler/apihandler.go 文件中增加访问路由，以及访问路由的处理函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiV1Ws.Route(</span><br><span class="line">   apiV1Ws.GET(&quot;&#x2F;chart&quot;).</span><br><span class="line">      To(apiHandler.handleGetChartList).</span><br><span class="line">      Writes(helm.ChartListWeb&#123;&#125;))</span><br><span class="line">      </span><br><span class="line">&#x2F;&#x2F;get app template list</span><br><span class="line">func (apiHandler \*APIHandler) handleGetChartList(request \*restful.Request, response \*restful.Response) &#123;</span><br><span class="line">   namespace :&#x3D; parseNamespacePathParameter(request)</span><br><span class="line">   dataSelect :&#x3D; parseDataSelectPathParameter(request)</span><br><span class="line">   result, err :&#x3D; chart.GetChartList(namespace,&quot;&quot;, dataSelect)</span><br><span class="line">   if err !&#x3D; nil &#123;</span><br><span class="line">      handleInternalError(response, err)</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   response.WriteHeaderAndEntity(http.StatusOK, result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    函数的实现思路可以参考dashboard中的查询pod的思路开发，其中做了分页查询，只要熟悉golang，基本没什么难度</p>
<p>###前端代码</p>
<p>此处略。。完全模仿，让以后的js高手写吧。。  </p>
<p>###翻译</p>
<p>dashboard 的翻译比较麻烦，使用的是google的开源项目。我们要增加自己的字段进行翻译的话，不需要手动在i18中的xtb文件中添加字段，只需要执行一下gulp build，在i18n文件夹中会自动添加我们使用到的字段，然后在xtb文件中进行翻译就好了。具体参考官方说明。<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/devel/localization.md">Locaization Guide</a></p>
<p>###DashBoard 扩展架构</p>
<p> 目前我们把dashboard 进行了扩展，包括镜像管理、模板仓库、监控告警、认证授权 ，具体的组件架构如下：<br><img src="/2020/09/21/Kubernetes-Dashboard%E5%BC%80%E5%8F%91%E8%AF%B4%E6%98%8E/1517796478876012.png" alt="avatar"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Kubernets-%E8%AF%A6%E8%A7%A3-Volume/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Kubernets-%E8%AF%A6%E8%A7%A3-Volume/" class="post-title-link" itemprop="url">Kubernets 详解--Volume</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 18:52:09 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T18:52:09+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-1-Volume"><a href="#1-1-Volume" class="headerlink" title="1.1 Volume"></a>1.1 Volume</h2><p>容器内的磁盘都是临时的，Volume引入的原因:</p>
<p>1、当一个容器宕机后，kubelet会重启改容器，但是容器内的文件就会丢失</p>
<p>2、一个Pod内的多个容器需要共享数据</p>
<h3 id="1-1-1-背景"><a href="#1-1-1-背景" class="headerlink" title="1.1.1 背景"></a>1.1.1 背景</h3><p>Docker中也有Volume的概念Docker中的Volume只是简单的一个磁盘目录或者其他Container中的目录，管理比较简单，虽然目前支持了volume driver，但是单个容器只支持使用一个volume driver。</p>
<p>   K8s中的Volume，有着明确的生命周期，与Pod的生命周期相同，Volume独立于Pod内的Container，在Container重启过程中，Volume保持不变。当然，让一个Pod停止退出时，Volume也会停止退出。除此之外，一个POD可以同时使用任意数量的，任意类型的卷。</p>
<p>Pod中的Container必须明确指定卷的挂载点</p>
<h3 id="1-1-2-卷类型"><a href="#1-1-2-卷类型" class="headerlink" title="1.1.2 卷类型"></a>1.1.2 卷类型</h3><h4 id="1-1-2-1-emptyDir"><a href="#1-1-2-1-emptyDir" class="headerlink" title="1.1.2.1 emptyDir"></a>1.1.2.1 emptyDir</h4><p>当使用emptyDir卷的Pod在节点创建时，会在该节点创建一个新的空目录，只要改Pod运行在该节点，该目录会一直存在，Pod内的容器可以将改目录挂载到不同的挂载点，但都可以读写emptyDir内的文件。当Pod不论什么原因被删除，emptyDir的数据都会永远被删除（一个Container Crash 并不会在该节点删除Pod，因此在Container crash时，数据不会丢失）</p>
<p>使用场景</p>
<p>1、 临时空间，例如基于磁盘空间做合并排序</p>
<p>2、 检测一个比较长的计算任务，能够让改计算任务从crash 恢复</p>
<p>3、 保存 内容管理Container 获取的文件，webserver 容器处理这些数据</p>
<p>默认情况下，emptyDir支持任何类型的后端存储：disk、ssd、网络存储。也可以通过设置 emptyDir.medium 为Memory，K8s会默认mount一个tmpfs（RAM-backed filesystem），因为是RAM Backed,因此tmpfs 通常很快。但是会在容器重启或者crash时，数据丢失。</p>
<h4 id="1-1-2-2-hostPath"><a href="#1-1-2-2-hostPath" class="headerlink" title="1.1.2.2 hostPath"></a>1.1.2.2 hostPath</h4><p>挂载Node节点以及存在的文件或者目录，不太常用，一下场景</p>
<p>1、 运行的容器需要访问宿主机的Docker 内部信息 例如/var/lib/docker 目录</p>
<p>2、 容器内运行cadvisor，需要访问 /dev/cgroups</p>
<p>使用该类型的卷，需要注意以下几个方面：</p>
<p>1、 使用同一个模板创建的Pod，由于不同的节点有不同的目录信息，可能会导致不同的结果</p>
<p>2、 如果K8s增加了已知资源的调度，该调度不会考虑hostPath使用的资源</p>
<p>3、 如果宿主机目录上已经存在的目录，只可以被root可以写，所以容器需要root权限访问该目录，或者修改目录权限</p>
<h4 id="1-1-2-3-gcePersistentDisk"><a href="#1-1-2-3-gcePersistentDisk" class="headerlink" title="1.1.2.3 gcePersistentDisk"></a>1.1.2.3 gcePersistentDisk</h4><p>GCE提供的存储</p>
<h4 id="1-1-2-4-awsElasticBlockStore"><a href="#1-1-2-4-awsElasticBlockStore" class="headerlink" title="1.1.2.4 awsElasticBlockStore"></a>1.1.2.4 awsElasticBlockStore</h4><p>AWS提供的块存储</p>
<h4 id="1-1-2-5-NFS"><a href="#1-1-2-5-NFS" class="headerlink" title="1.1.2.5 NFS"></a>1.1.2.5 NFS</h4><p>与emptyDir不同，基于NFs的卷，在Pod删除时，卷并不会清除，只是与容器解绑。NFS支持同时读写。</p>
<p>NFS Server 需要单独搭建</p>
<h4 id="1-1-2-6-Iscsi"><a href="#1-1-2-6-Iscsi" class="headerlink" title="1.1.2.6 Iscsi"></a>1.1.2.6 Iscsi</h4><p>iScSi提供卷，在Pod删除时，卷并不会清除，只是与容器解绑</p>
<p>iSCSI Server 必须自己搭建</p>
<p>使用iscsi的一个特性，多个容器挂载卷时，可以指定挂载类型为read-only，但是有个缺点，iscsi卷只能同时被一个Container挂载为读写模式，不支持多个Container同时读写。</p>
<h4 id="1-1-2-7-Flocker"><a href="#1-1-2-7-Flocker" class="headerlink" title="1.1.2.7 Flocker"></a>1.1.2.7 Flocker</h4><p>开源，容器集群 卷管理，支持管理和编排多种存储后端的数据卷</p>
<p>一个flocker volume 允许挂载一个flocker dataset 到一个Pod</p>
<h4 id="1-1-2-8-Glusterfs"><a href="#1-1-2-8-Glusterfs" class="headerlink" title="1.1.2.8 Glusterfs"></a>1.1.2.8 Glusterfs</h4><p>支持多容器同时写</p>
<h4 id="1-1-2-9-RBD"><a href="#1-1-2-9-RBD" class="headerlink" title="1.1.2.9 RBD"></a>1.1.2.9 RBD</h4><p>Rados Block Device voluem 挂载到Pod</p>
<p>Rbd特点：可以被同时挂载为Read-Only。但是只能同时被一个Container 挂载为读写模式</p>
<h4 id="1-1-2-10-Cephfs"><a href="#1-1-2-10-Cephfs" class="headerlink" title="1.1.2.10 Cephfs"></a>1.1.2.10 Cephfs</h4><p>支持多容器同时写</p>
<h4 id="1-1-2-11-Gitrepo"><a href="#1-1-2-11-Gitrepo" class="headerlink" title="1.1.2.11 Gitrepo"></a>1.1.2.11 Gitrepo</h4><p>可以类似一个卷插件，挂载一个空目录，clone git上的仓库到该目录，Pod可以使用该仓库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">**apiVersion****:** **v1**</span><br><span class="line"></span><br><span class="line">**kind****:** **Pod**</span><br><span class="line"></span><br><span class="line">**metadata****:**</span><br><span class="line"></span><br><span class="line"> **name****:** **server**</span><br><span class="line"></span><br><span class="line">**spec****:**</span><br><span class="line"></span><br><span class="line"> **containers****:**</span><br><span class="line"></span><br><span class="line">**-** **image****:** **nginx**</span><br><span class="line"></span><br><span class="line"> **name****:** **nginx**</span><br><span class="line"></span><br><span class="line"> **volumeMounts****:**</span><br><span class="line"></span><br><span class="line">**-** **mountPath****:** **&#x2F;mypath**</span><br><span class="line"></span><br><span class="line"> **name****:** **git-volume**</span><br><span class="line"></span><br><span class="line"> **volumes****:**</span><br><span class="line"></span><br><span class="line">**-** **name****:** **git-volume**</span><br><span class="line"></span><br><span class="line"> **gitRepo****:**</span><br><span class="line"></span><br><span class="line"> **repository****:** **&quot;git@somewhere:me&#x2F;my-git-repository.git&quot;**</span><br><span class="line"></span><br><span class="line"> **revision****:** **&quot;22f1d8406d464b0c0874075539c1f2e96c253775&quot;**</span><br></pre></td></tr></table></figure>
<h4 id="1-1-2-12-secret"><a href="#1-1-2-12-secret" class="headerlink" title="1.1.2.12 secret"></a>1.1.2.12 secret</h4><p>存放敏感信息的卷，具体可以参考K8s的Secret介绍</p>
<h4 id="1-1-2-13-其他"><a href="#1-1-2-13-其他" class="headerlink" title="1.1.2.13 其他"></a>1.1.2.13 其他</h4><p>PersistentVolumeClain</p>
<p>dowanwardAPI</p>
<p>AzureFileVolume</p>
<p>AzureDiskVolume</p>
<p>vsphereVolume</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Linux%E6%89%A7%E8%A1%8Cdf%E5%92%8Cdu%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E6%97%B6%E5%8D%A0%E7%94%A8%E7%BB%93%E6%9E%9C%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Linux%E6%89%A7%E8%A1%8Cdf%E5%92%8Cdu%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E6%97%B6%E5%8D%A0%E7%94%A8%E7%BB%93%E6%9E%9C%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/" class="post-title-link" itemprop="url">Linux执行df和du查看磁盘时占用结果不一致的解决办法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 18:47:04 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T18:47:04+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>526</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>问题现象</strong> </p>
<p>1、执行 df -h 查看 ECS Linux 实例文件系统使用率，可以看到 /dev/xvdb1 磁盘占用了约27G，挂载目录为 /opt 。</p>
<p><img src="http://p3.pstatp.com/large/pgc-image/1531049590662f3fa303a98" alt="Linux 执行 df 和 du 查看磁盘时占用结果不一致的解决办法"></p>
<p>2、进入到 /opt 目录执行 du -sh ，显示空间总占用量约 2.4 G，即df 和du查看到的结果不一致。</p>
<p><img src="http://p1.pstatp.com/large/pgc-image/1531049590682d3db0a9740" alt="Linux 执行 df 和 du 查看磁盘时占用结果不一致的解决办法"></p>
<p><strong>原因分析</strong></p>
<ul>
<li><p>du 命令对统计文件逐个进行 fstat 系统调用，获取文件大小。它的数据是基于文件获取，可以跨多个分区操作。</p>
</li>
<li><p>df 命令使用 statfs 系统调用，直接读取分区的超级块信息获取分区使用情况。它的数据基于分区元数据，只能针对整个分区。</p>
</li>
<li><p>用户删除了大量的文件后，du 就不会在文件系统目录中统计这些文件。如果此时还有运行中的进程持有这个已经被删除的文件句柄，那么这个文件就不会真正在磁盘中被删除，分区超级块中的信息也就不会更改，df 仍会统计这个被删除的文件。</p>
</li>
<li><p>通过 lsof 查询处于 deleted 状态的文件，被删除的文件在系统中被标记为 deleted 。如果系统有大量 deleted 状态的文件，会导致 du 和 df 统计结果不一致。</p>
</li>
</ul>
<p>##解决方案<br>  1、根据 lsof 列出的 pid，kill 相应进程或者重启相应的服务，如：#kill -9 692。 </p>
<p>  2、重启服务器。重启服务器系统会退出现有的进程，开机后重新加载，过程中会释放调用的 deleted 文件的句柄。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Nginx%E4%BB%A3%E7%90%86%E7%AB%AF%E5%8F%A3%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Nginx%E4%BB%A3%E7%90%86%E7%AB%AF%E5%8F%A3%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">Nginx代理端口丢失问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 18:45:39 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T18:45:39+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>970</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>     Kubernetes环境中在使用Nginx进行代理，在进行端口代理时，总是出现端口丢失的问题，例如访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">http:&#x2F;&#x2F;10.10.70.58:32007&#x2F;demo</span><br></pre></td></tr></table></figure>

<p>地址会跳转到 <a target="_blank" rel="noopener" href="http://10.10.70.58:32007/demo"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.10.70.58:32007&#x2F;demo</span><br></pre></td></tr></table></figure>

<p>查看代理配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream archdemo &#123;</span><br><span class="line">        server 10.10.70.61:32007;</span><br><span class="line">        server 10.10.70.62:32007;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    listen 32007;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy\_pass         http:&#x2F;&#x2F;archdemo; </span><br><span class="line">        server\_name\_in\_redirect off;</span><br><span class="line">        proxy\_set\_header X-Real-IP $remote\_addr;</span><br><span class="line">        proxy\_set\_header REMOTE-HOST $remote\_addr;</span><br><span class="line">        proxy\_set\_header X-Forwarded-For $proxy\_add\_x\_forwarded\_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里经过“面向搜索引擎的编程“，解决该问题，在进行代理配置是需要使用以下配置  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream archdemo &#123;</span><br><span class="line">        server 10.10.70.61:32007;</span><br><span class="line">        server 10.10.70.62:32007;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    listen 32007;</span><br><span class="line">        server\_name\_in\_redirect off;</span><br><span class="line">        proxy\_set\_header Host $host:$server\_port;</span><br><span class="line">        proxy\_set\_header X-Real-IP $remote\_addr;</span><br><span class="line">        proxy\_set\_header REMOTE-HOST $remote\_addr;</span><br><span class="line">        proxy\_set\_header X-Forwarded-For $proxy\_add\_x\_forwarded\_for;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy\_pass         http:&#x2F;&#x2F;archdemo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/OpenShift%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E5%92%8C%E9%AA%8C%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/OpenShift%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E5%92%8C%E9%AA%8C%E8%AF%81/" class="post-title-link" itemprop="url">OpenShift基础功能测试和验证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 18:36:48 / 修改时间：19:23:08" itemprop="dateCreated datePublished" datetime="2020-09-21T18:36:48+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>43k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>39 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="OpenShift"><a href="#OpenShift" class="headerlink" title="OpenShift"></a>OpenShift</h1><h2 id="OpenShift-分布式部署"><a href="#OpenShift-分布式部署" class="headerlink" title="OpenShift 分布式部署"></a>OpenShift 分布式部署</h2><h3 id="OpenShift-Slave节点配置"><a href="#OpenShift-Slave节点配置" class="headerlink" title="OpenShift Slave节点配置"></a>OpenShift Slave节点配置</h3><p>0、 节点ssh互信设置</p>
<p>Maste节点执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"># for host in master.example.com \\</span><br><span class="line">    node1.example.com \\</span><br><span class="line">    node2.example.com; \\</span><br><span class="line">    do ssh-copy-id -i ~&#x2F;.ssh&#x2F;id\_rsa.pub $host; \\</span><br><span class="line">    done</span><br></pre></td></tr></table></figure>

<p>1、 每个节点都需要安装docker，手动安装</p>
<p>2、设置每个节点的docker 存储，使用数据盘做为docker的存储</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">\[root@origin-master member\]# cat &#x2F;etc&#x2F;sysconfig&#x2F;docker-storage-setup</span><br><span class="line"> Edit this file to override any configuration options specified in</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;docker-storage-setup&#x2F;docker-storage-setup.</span><br><span class="line"></span><br><span class="line">For more details refer to &quot;man docker-storage-setup&quot;</span><br><span class="line">DEVS&#x3D;&#x2F;dev&#x2F;vdb</span><br><span class="line">VG&#x3D;docker-vg</span><br><span class="line"> </span><br><span class="line">docker-storage-setup</span><br><span class="line"> </span><br><span class="line">systemctl stop docker</span><br><span class="line">rm -rf &#x2F;var&#x2F;lib&#x2F;docker&#x2F;\*</span><br><span class="line">systemctl restart docker</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>3、</p>
<p>设置每个节点的docker 可信镜像地址/etc/sysconfig/docker（这一操作，可以在部署完成openshift后，进行修改，其中172.30.0.0/16为ansible配置，10.110.17.138:5000为外部的docker镜像源）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS&#x3D;&#39;--insecure-registry&#x3D;10.110.17.138:5000 --insecure-registry&#x3D;172.30.0.0&#x2F;16    &#39;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>





<p>4、在DNS为每个Node的配置</p>
<p> A记录参考配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@origin-dns:&#x2F;etc&#x2F;bind# cat &#x2F;etc&#x2F;bind&#x2F;named.conf.local</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Do any local configuration here</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Consider adding the 1918 zones here, if they are not used in your</span><br><span class="line">&#x2F;&#x2F; organization</span><br><span class="line">&#x2F;&#x2F;include &quot;&#x2F;etc&#x2F;bind&#x2F;zones.rfc1918&quot;;</span><br><span class="line">zone &quot;novalocal&quot; &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;&#x2F;etc&#x2F;bind&#x2F;db.novalocal&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">root@origin-dns:&#x2F;etc&#x2F;bind# cat db.novalocal</span><br><span class="line">$TTL    604800</span><br><span class="line">@       IN      SOA     novalocal. root.novalocal. (</span><br><span class="line">                              1         ; Serial</span><br><span class="line">                         604800         ; Refresh</span><br><span class="line">                          86400         ; Retry</span><br><span class="line">                        2419200         ; Expire</span><br><span class="line">                          86400 )       ; Negative Cache TTL</span><br><span class="line">;</span><br><span class="line">@       IN      NS      novalocal.</span><br><span class="line">@       IN      A       192.168.10.143</span><br><span class="line">origin-master  IN      A       192.168.10.143</span><br><span class="line">origin-slave1  IN      A       192.168.10.149</span><br><span class="line">origin-slave2  IN      A       192.168.10.145</span><br><span class="line">origin-slave3  IN      A       192.168.10.147</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="OpenShift-Master节点配置"><a href="#OpenShift-Master节点配置" class="headerlink" title="OpenShift Master节点配置"></a>OpenShift Master节点配置</h3><p>1、ansible-openshift 的配置文件/etc/ansible/hosts 增加一下配置，完成OpenShift节点的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[OSEv3:children]</span><br><span class="line">masters</span><br><span class="line">nodes</span><br><span class="line">[OSEv3:vars]</span><br><span class="line">ansible_ssh_user&#x3D;root</span><br><span class="line">deployment_type&#x3D;origin</span><br><span class="line">openshift\_master\_identity\_providers&#x3D;\[&#123;&#39;name&#39;: &#39;htpasswd\_auth&#39;, &#39;login&#39;: &#39;true&#39;, &#39;challenge&#39;: &#39;true&#39;, &#39;kind&#39;: &#39;HTPasswdPasswordIdentityProvider&#39;, &#39;filename&#39;: &#39;&#x2F;etc&#x2F;origin&#x2F;htpasswd&#39;&#125;\]</span><br><span class="line">os\_sdn\_network\_plugin\_name&#x3D;redhat&#x2F;openshift-ovs-multitenant</span><br><span class="line">openshift\_master\_portal\_net&#x3D;172.30.0.0&#x2F;16</span><br><span class="line">openshift\_master\_session\_name&#x3D;ssn</span><br><span class="line">openshift\_master\_session\_max\_seconds&#x3D;3600</span><br><span class="line">openshift\_master\_session\_auth\_secrets&#x3D;\[&#39;DONT+USE+THIS+SECRET+b4NV+pmZNSO&#39;\]</span><br><span class="line">openshift\_master\_session\_encryption\_secrets&#x3D;\[&#39;DONT+USE+THIS+SECRET+b4NV+pmZNSO&#39;\]</span><br><span class="line"> </span><br><span class="line">\[masters\]</span><br><span class="line">origin-master.novalocal openshift\_public\_ip&#x3D;10.110.17.139 openshift\_public\_hostname&#x3D;origin-master.novalocal</span><br><span class="line">\[nodes\]</span><br><span class="line">origin-slave1.novalocal openshift\_node\_labels&#x3D;&quot;&#123;&#39;region&#39;: &#39;primary&#39;, &#39;zone&#39;: &#39;east&#39;&#125;&quot;</span><br><span class="line">origin-slave2.novalocal openshift\_node\_labels&#x3D;&quot;&#123;&#39;region&#39;: &#39;primary&#39;, &#39;zone&#39;: &#39;east&#39;&#125;&quot;</span><br><span class="line">origin-slave3.novalocal openshift\_node\_labels&#x3D;&quot;&#123;&#39;region&#39;: &#39;primary&#39;, &#39;zone&#39;: &#39;east&#39;&#125;&quot;</span><br><span class="line">origin-master.novalocal openshift\_node\_labels&#x3D;&quot;&#123;&#39;region&#39;:&#39;infra&#39;,&#39;zone&#39;:&#39;default&#39;&#125;&quot; openshift\_schedulable&#x3D;false</span><br></pre></td></tr></table></figure>



<p>2、</p>
<p>搭建NFS服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">\[root@oc-master ~\]yum install nfs-utils</span><br><span class="line">\[root@oc-master ~\]cat &#x2F;etc&#x2F;exports</span><br><span class="line">&#x2F;opt&#x2F;docker-registry 192.168.10.0&#x2F;24(rw,sync,no\_root\_squash,no\_all\_squash)</span><br><span class="line">&#96;&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">配置服务端访问策略：</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;&#96;(python)</span><br><span class="line">cat  &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.10.0&#x2F;24 --dport 111 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p tcp -s 192.168.10.0&#x2F;24 --dport 111 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p tcp -s 192.168.10.0&#x2F;24 --dport 20048 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.6.0&#x2F;24 --dport 20048 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.6.0&#x2F;24 --dport 2049 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p tcp -s 192.168.6.0&#x2F;24 --dport 2049 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p tcp -s 192.168.6.0&#x2F;24 --dport 20048 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.6.0&#x2F;24 --dport 20048 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.6.0&#x2F;24 --dport 49493 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p tcp -s 192.168.6.0&#x2F;24 --dport 49493 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.6.0&#x2F;24 --dport 54932 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p tcp -s 192.168.6.0&#x2F;24 --dport 46120 -j ACCEPT</span><br><span class="line">-A OS\_FIREWALL\_ALLOW -m state --state NEW  -p udp -s 192.168.6.0&#x2F;24 --dport 37588 -j ACCEPT</span><br></pre></td></tr></table></figure>



<p>重启NFS服务 systemctl restart nfs-server.service</p>
<p>客户端挂载</p>
<p>mount -t nfs 192.168.6.7:/opt/docker-registry/ /opt/docker-registry/</p>
<h3 id="执行安装"><a href="#执行安装" class="headerlink" title="执行安装"></a>执行安装</h3><p>在master节点操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1、执行安装：ansible-playbook ~&#x2F;openshift-ansible&#x2F;playbooks&#x2F;byo&#x2F;config.yml</span><br></pre></td></tr></table></figure>

<p>2、执行卸载：ansible-playbook openshift-ansible/playbooks/adhoc/uninstall.yml</p>
<h3 id="部署Docker-Registry"><a href="#部署Docker-Registry" class="headerlink" title="部署Docker-Registry"></a>部署Docker-Registry</h3><p>Master节点配置nfs</p>
<p>注意：部署完成docker-registry后，不能再讲该服务进行删除，因为服务地址已经更新到etcd，该地址目前看来，无法实时更新</p>
<p>在master节点操作</p>
<p>oadm registry –config=/etc/origin/master/admin.kubeconfig  –credentials=/etc/origin/master/openshift-registry.kubeconfig –service-account=registry  –mount-host=/opt/docker-registry</p>
<h3 id="部署监控metrics"><a href="#部署监控metrics" class="headerlink" title="部署监控metrics"></a>部署监控metrics</h3><p>1 使用 openshift-infra工程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc project openshift-infra</span><br></pre></td></tr></table></figure>
<p>2、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc secrets new metrics-deployer nothing&#x3D;&#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>

<p>3、<br>oc process -f metrics-deployer.yaml -v HAWKULAR_METRICS_HOSTNAME=hawkular-metrics.devops.inspur,USE_PERSISTENT_STORAGE=false | oc create -f –</p>
<p>参考demo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#</span><br><span class="line"># Copyright 2014-2015 Red Hat, Inc. and&#x2F;or its affiliates</span><br><span class="line"># and other contributors as indicated by the @author tags.</span><br><span class="line">#</span><br><span class="line"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"># you may not use this file except in compliance with the License.</span><br><span class="line"># You may obtain a copy of the License at</span><br><span class="line">#</span><br><span class="line">#    http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># Unless required by applicable law or agreed to in writing, software</span><br><span class="line"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"># See the License for the specific language governing permissions and</span><br><span class="line"># limitations under the License.</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">apiVersion: &quot;v1&quot;</span><br><span class="line">kind: &quot;Template&quot;</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-deployer-template</span><br><span class="line">  annotations:</span><br><span class="line">    description: &quot;Template for deploying the required Metrics integration. Requires cluster-admin &#39;metrics-deployer&#39; service account and &#39;metrics-deployer&#39; secret.&quot;</span><br><span class="line">    tags: &quot;infrastructure&quot;</span><br><span class="line">labels:</span><br><span class="line">  metrics-infra: deployer</span><br><span class="line">  provider: openshift</span><br><span class="line">  component: deployer</span><br><span class="line">objects:</span><br><span class="line">-</span><br><span class="line">  apiVersion: v1</span><br><span class="line">  kind: Pod</span><br><span class="line">  metadata:</span><br><span class="line">    generateName: metrics-deployer-</span><br><span class="line">  spec:</span><br><span class="line">    containers:</span><br><span class="line">    - image: $&#123;IMAGE\_PREFIX&#125;metrics-deployer:$&#123;IMAGE\_VERSION&#125;</span><br><span class="line">      name: deployer</span><br><span class="line">      volumeMounts:</span><br><span class="line">      - name: secret</span><br><span class="line">        mountPath: &#x2F;secret</span><br><span class="line">        readOnly: true</span><br><span class="line">      - name: empty</span><br><span class="line">        mountPath: &#x2F;etc&#x2F;deploy</span><br><span class="line">      env:</span><br><span class="line">        - name: PROJECT</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: IMAGE\_PREFIX</span><br><span class="line">          value: $&#123;IMAGE\_PREFIX&#125;</span><br><span class="line">        - name: IMAGE\_VERSION</span><br><span class="line">          value: $&#123;IMAGE\_VERSION&#125;</span><br><span class="line">        - name: MASTER\_URL</span><br><span class="line">          value: $&#123;MASTER\_URL&#125;</span><br><span class="line">        - name: REDEPLOY</span><br><span class="line">          value: $&#123;REDEPLOY&#125;</span><br><span class="line">        - name: USE\_PERSISTENT\_STORAGE</span><br><span class="line">          value: $&#123;USE\_PERSISTENT\_STORAGE&#125;</span><br><span class="line">        - name: HAWKULAR\_METRICS\_HOSTNAME</span><br><span class="line">          value: $&#123;HAWKULAR\_METRICS\_HOSTNAME&#125;</span><br><span class="line">        - name: CASSANDRA\_NODES</span><br><span class="line">          value: $&#123;CASSANDRA\_NODES&#125;</span><br><span class="line">        - name: CASSANDRA\_PV\_SIZE</span><br><span class="line">          value: $&#123;CASSANDRA\_PV\_SIZE&#125;</span><br><span class="line">        - name: METRIC\_DURATION</span><br><span class="line">          value: $&#123;METRIC\_DURATION&#125;</span><br><span class="line">    dnsPolicy: ClusterFirst</span><br><span class="line">    restartPolicy: Never</span><br><span class="line">    serviceAccount: metrics-deployer</span><br><span class="line">    volumes:</span><br><span class="line">    - name: empty</span><br><span class="line">      emptyDir: &#123;&#125;</span><br><span class="line">    - name: secret</span><br><span class="line">      secret:</span><br><span class="line">        secretName: metrics-deployer</span><br><span class="line">parameters:</span><br><span class="line">-</span><br><span class="line">  description: &#39;Specify prefix for metrics components; e.g. for &quot;openshift&#x2F;origin-metrics-deployer:latest&quot;, set prefix &quot;openshift&#x2F;origin-&quot;&#39;</span><br><span class="line">  name: IMAGE\_PREFIX</span><br><span class="line">  value: &quot;10.110.17.138:5000&#x2F;library&#x2F;origin-&quot;</span><br><span class="line">-</span><br><span class="line">  description: &#39;Specify version for metrics components; e.g. for &quot;openshift&#x2F;origin-metrics-deployer:latest&quot;, set version &quot;latest&quot;&#39;</span><br><span class="line">  name: IMAGE\_VERSION</span><br><span class="line">  value: &quot;latest&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;Internal URL for the master, for authentication retrieval&quot;</span><br><span class="line">  name: MASTER\_URL</span><br><span class="line">  value: &quot;https:&#x2F;&#x2F;oc-master.novalocal:8443&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;External hostname where clients will reach Hawkular Metrics&quot;</span><br><span class="line">  name: HAWKULAR\_METRICS\_HOSTNAME</span><br><span class="line">  required: true</span><br><span class="line">  value: &quot;hawkular-metrics.devops.inspur&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;If set to true the deployer will try and delete all the existing components before trying to redeploy.&quot;</span><br><span class="line">  name: REDEPLOY</span><br><span class="line">  value: &quot;false&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;Set to true for persistent storage, set to false to use non persistent storage&quot;</span><br><span class="line">  name: USE\_PERSISTENT\_STORAGE</span><br><span class="line">  value: &quot;false&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;The number of Cassandra Nodes to deploy for the initial cluster&quot;</span><br><span class="line">  name: CASSANDRA\_NODES</span><br><span class="line">  value: &quot;1&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;The persistent volume size for each of the Cassandra nodes&quot;</span><br><span class="line">  name: CASSANDRA\_PV\_SIZE</span><br><span class="line">  value: &quot;10Gi&quot;</span><br><span class="line">-</span><br><span class="line">  description: &quot;How many days metrics should be stored for.&quot;</span><br><span class="line">  name: METRIC\_DURATION</span><br><span class="line">  value: &quot;7&quot;</span><br></pre></td></tr></table></figure>



<p>当pod运行成功后，还需要修改/etc/origin/master/master-config.yaml文件，增加metric配置</p>
<p>通过浏览器访问控制台时，也会出现无法访问监控信息的情况，需要确认</p>
<p>（1） 浏览器能够解析hawkular-metrics.devops.inspur地址</p>
<p>（2） 使用浏览器访问改地址<a target="_blank" rel="noopener" href="https://hawkular-metrics.devops.inspur/hawkular/metrics%EF%BC%8C%E5%8A%A0%E8%BD%BDhttps%E8%AF%81%E4%B9%A6">https://hawkular-metrics.devops.inspur/hawkular/metrics，加载https证书</a></p>
<h3 id="部署Route"><a href="#部署Route" class="headerlink" title="部署Route"></a>部署Route</h3><p>在master节点操作</p>
<p>oadm router haproxy-router –replicas=1 –credentials=/etc/origin/master/openshift-router.kubeconfig –service-account=router</p>
<p>增加用户：htpasswd /etc/origin/htpasswd admin</p>
<p>普通用户登录;oc login</p>
<p>系统管理员登录：</p>
<p>export KUBECONFIG=/etc/origin/master/admin.kubeconfig</p>
<p>oc login -u system:admin -n default</p>
<p>此时，整个环境搭建完成，</p>
<h2 id="外部Docker-Registry搭建"><a href="#外部Docker-Registry搭建" class="headerlink" title="外部Docker-Registry搭建"></a>外部Docker-Registry搭建</h2><p>搭建一个V2版本的docker-registry</p>
<p>使用一台新的虚拟机，部署docker,部署docker registry</p>
<p>docker run -d -p 5000:5000 –name registry registry:2</p>
<p>注意：在该registry上传镜像时，需要制定子目录：例如例如10.110.17.138:5000/library/postgresql</p>
<h2 id="管理OpenShift"><a href="#管理OpenShift" class="headerlink" title="管理OpenShift"></a>管理OpenShift</h2><h3 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h3><p>导入的镜像都存放到了 openshift的内部镜像</p>
<h4 id="1、从第三方仓库导入镜像"><a href="#1、从第三方仓库导入镜像" class="headerlink" title="1、从第三方仓库导入镜像"></a>1、从第三方仓库导入镜像</h4><p>从第三方仓库导入的镜像，只是在OpenShift的内部镜像仓库中，保存了索引信息，真正使用的时候，还是要去第三方仓库下载，将外部镜像导入到OpenShift，可以指定命名空间进行导入</p>
<p>进行导入：oc create <strong>-**f image-streams-centos7-python-postgresql</strong>.**json **-**n demo</p>
<p>导入镜像使用的文件参考参考image-streams-centos7-python-postgresql.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;ImageStreamList&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;items&quot;: \[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;ImageStream&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;python&quot;,</span><br><span class="line">          &quot;annotations&quot;: &#123;</span><br><span class="line">               &quot;openshift.io&#x2F;image.insecureRepository&quot;: &quot;true&quot;</span><br><span class="line">             &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">         &quot;dockerImageRepository&quot;: &quot;10.110.17.138:5000&#x2F;library&#x2F;python&quot;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;ImageStream&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">       &quot;metadata&quot;: &#123;</span><br><span class="line">           &quot;name&quot;: &quot;postgresql&quot;,</span><br><span class="line">           &quot;annotations&quot;: &#123;</span><br><span class="line">               &quot;openshift.io&#x2F;image.insecureRepository&quot;: &quot;true&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">       &quot;spec&quot;: &#123;</span><br><span class="line">          &quot;dockerImageRepository&quot;: &quot;10.110.17.138:5000&#x2F;library&#x2F;postgresql&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;\]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意：外部的私有docker-registry 的镜像存储目录必须有子目录：例如10.110.17.138:5000/library/postgresql</p>
<h4 id="2、登录OpenShift-内部docker-registry，导入镜像"><a href="#2、登录OpenShift-内部docker-registry，导入镜像" class="headerlink" title="2、登录OpenShift 内部docker-registry，导入镜像"></a>2、登录OpenShift 内部docker-registry，导入镜像</h4><p>  1、在master节点获取，docker-registry服务的service ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> \[root@origin-master image-streams\]# oc get svc</span><br><span class="line">NAME              CLUSTER\_IP      EXTERNAL\_IP   PORT(S)                 SELECTOR                  AGE</span><br><span class="line">docker-registry   172.30.90.102   &lt;none&gt;        5000&#x2F;TCP                docker-registry&#x3D;default   20h</span><br><span class="line">haproxy-router    172.30.95.6     &lt;none&gt;        80&#x2F;TCP                  router&#x3D;haproxy-router     20h</span><br><span class="line">kubernetes        172.30.0.1      &lt;none&gt;        443&#x2F;TCP,53&#x2F;UDP,53&#x2F;TCP   &lt;none&gt;                    22h</span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<p>2、查看OpenShift内部docker-registry所在的节点，并登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  root@origin-slave3 ~\]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                                                                                           COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">40a2a7f9c5f0        openshift&#x2F;origin-docker-registry:v1.1.0.1                                                                       &quot;&#x2F;bin&#x2F;sh -c &#39;REGISTRY&quot;   5 hours ago         Up 5 hours                              k8s\_registry.afeb0b36\_docker-registry-1-2wsvm\_default\_fa5e59e4-af5a-11e5-8632-fa163efe8294\_4fbf4ffa</span><br><span class="line">b29287d1a00c        10.110.17.138:5000&#x2F;library&#x2F;postgresql@sha256:11dbc16d7d84da0dfb42782ff1f64b0e263d9f8686fe4347f2d02a665582e945   &quot;container-entrypoint&quot;   5 hours ago         Up 5 hours                              k8s\_postgresql.5134f420\_postgresql-1-eun94\_demo\_7e990eb5-af62-11e5-8632-fa163efe8294\_155dadb8</span><br><span class="line">c217ccc5c319        openshift&#x2F;origin-pod:v1.1.0.1                                                                                   &quot;&#x2F;pod&quot;                   5 hours ago         Up 5 hours                              k8s\_POD.18d9fe1e\_postgresql-1-eun94\_demo\_7e990eb5-af62-11e5-8632-fa163efe8294\_257ba619</span><br><span class="line">bbc34e05ca92        openshift&#x2F;origin-pod:v1.1.0.1                                                                                   &quot;&#x2F;pod&quot;                   5 hours ago         Up 5 hours                              k8s\_POD.7c1fe15\_docker-registry-1-2wsvm\_default\_fa5e59e4-af5a-11e5-8632-fa163efe8294\_7a1bd148</span><br></pre></td></tr></table></figure>



<p>3、 以普通用户登录openshift，获取tocker</p>
<p><strong>[**root@origin</strong>-<strong>slave</strong>3** ~**]**# oc whoami **-**t</p>
<p>YAiqVCwCIhMT6FoVXfhpnga4UBiud0Mwzz84-sW3Om8</p>
<p>4、</p>
<p><strong>[**root@origin</strong>-<strong>slave</strong>3** ~<strong>]**# docker login **-**u admin **-**e admin@inspur</strong>.<strong>com **-**p YAiqVCwCIhMT6FoVXfhpnga4UBiud0Mwzz84-sW3Om8 **172.30.90.102:5000</strong></p>
<p>WARNING**:** login credentials saved in <strong>/**root</strong>/.<strong>docker</strong>/config.**json</p>
<p>Login Succeeded</p>
<p>5、 上传镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">\[root@origin-slave3 ~\]# docker tag 10.110.17.138:5000&#x2F;library&#x2F;hello-openshift 172.30.90.102:5000&#x2F;demo&#x2F;hello-openshift</span><br><span class="line">\[root@origin-slave3 ~\]# docker push 172.30.90.102:5000&#x2F;demo&#x2F;hello-openshift</span><br><span class="line">The push refers to a repository \[172.30.90.102:5000&#x2F;demo&#x2F;hello-openshift\] (len: 1)</span><br><span class="line">bcfa6006862b: Pushed</span><br><span class="line">bbc202431232: Pushed</span><br><span class="line">eb19dbec24c6: Pushed</span><br><span class="line">0055f04883dd: Pushed</span><br><span class="line">latest: digest: sha256:724411548d3c1ea88402288b2045275cd3fd0488f6d6500f4f6974b278f27f39 size: 6982</span><br></pre></td></tr></table></figure>

<h3 id="部署Template"><a href="#部署Template" class="headerlink" title="部署Template"></a>部署Template</h3><p>Template定义了一套部署应用的完成流程，包含打包、发布等，供开发者使用</p>
<p>部署template</p>
<p>oc create-f django-postgres.json -n openshif</p>
<p>Template 参考文件django-postgres.json，特别注意镜像的使用方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Template&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">    &quot;annotations&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;An example Django application with a PostgreSQL database&quot;,</span><br><span class="line">      &quot;tags&quot;: &quot;instant-app,python,django,postgresql&quot;,</span><br><span class="line">      &quot;iconClass&quot;: &quot;icon-python&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;labels&quot;: &#123;</span><br><span class="line">    &quot;template&quot;: &quot;django-psql-example&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;objects&quot;: \[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;Service&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">          &quot;description&quot;: &quot;Exposes and load balances the application pods&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">        &quot;ports&quot;: \[</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;name&quot;: &quot;web&quot;,</span><br><span class="line">            &quot;port&quot;: 8080,</span><br><span class="line">            &quot;targetPort&quot;: 8080</span><br><span class="line">          &#125;</span><br><span class="line">        \],</span><br><span class="line">        &quot;selector&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;django-psql-example&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;Route&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;django-psql-example&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">        &quot;host&quot;: &quot;$&#123;APPLICATION\_DOMAIN&#125;&quot;,</span><br><span class="line">        &quot;to&quot;: &#123;</span><br><span class="line">          &quot;kind&quot;: &quot;Service&quot;,</span><br><span class="line">          &quot;name&quot;: &quot;django-psql-example&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;ImageStream&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">          &quot;description&quot;: &quot;Keeps track of changes in the application image&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;BuildConfig&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">          &quot;description&quot;: &quot;Defines how to build the application&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">        &quot;source&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Git&quot;,</span><br><span class="line">          &quot;git&quot;: &#123;</span><br><span class="line">            &quot;uri&quot;: &quot;$&#123;SOURCE\_REPOSITORY\_URL&#125;&quot;,</span><br><span class="line">            &quot;ref&quot;: &quot;$&#123;SOURCE\_REPOSITORY\_REF&#125;&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;contextDir&quot;: &quot;$&#123;CONTEXT\_DIR&#125;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;strategy&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Source&quot;,</span><br><span class="line">          &quot;sourceStrategy&quot;: &#123;</span><br><span class="line">            &quot;from&quot;: &#123;</span><br><span class="line">              &quot;kind&quot;: &quot;ImageStreamTag&quot;,</span><br><span class="line">              &quot;namespace&quot;: &quot;openshift&quot;,</span><br><span class="line">              &quot;name&quot;: &quot;python&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;output&quot;: &#123;</span><br><span class="line">          &quot;to&quot;: &#123;</span><br><span class="line">            &quot;kind&quot;: &quot;ImageStreamTag&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;django-psql-example:latest&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;triggers&quot;: \[</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ImageChange&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ConfigChange&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;GitHub&quot;,</span><br><span class="line">            &quot;github&quot;: &#123;</span><br><span class="line">              &quot;secret&quot;: &quot;$&#123;GITHUB\_WEBHOOK\_SECRET&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        \]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;DeploymentConfig&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">          &quot;description&quot;: &quot;Defines how to deploy the application server&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">        &quot;strategy&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Rolling&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;triggers&quot;: \[</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ImageChange&quot;,</span><br><span class="line">            &quot;imageChangeParams&quot;: &#123;</span><br><span class="line">              &quot;automatic&quot;: true,</span><br><span class="line">              &quot;containerNames&quot;: \[</span><br><span class="line">                &quot;django-psql-example&quot;</span><br><span class="line">              \],</span><br><span class="line">              &quot;from&quot;: &#123;</span><br><span class="line">                &quot;kind&quot;: &quot;ImageStreamTag&quot;,</span><br><span class="line">                &quot;name&quot;: &quot;django-psql-example:latest&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ConfigChange&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        \],</span><br><span class="line">        &quot;replicas&quot;: 1,</span><br><span class="line">        &quot;selector&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;django-psql-example&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;template&quot;: &#123;</span><br><span class="line">          &quot;metadata&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">            &quot;labels&quot;: &#123;</span><br><span class="line">              &quot;name&quot;: &quot;django-psql-example&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;spec&quot;: &#123;</span><br><span class="line">            &quot;containers&quot;: \[</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;name&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">                &quot;image&quot;: &quot;django-psql-example&quot;,</span><br><span class="line">                &quot;ports&quot;: \[</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;containerPort&quot;: 8080</span><br><span class="line">                  &#125;</span><br><span class="line">                \],</span><br><span class="line">                &quot;env&quot;: \[</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;DATABASE\_SERVICE\_NAME&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;DATABASE\_ENGINE&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_ENGINE&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;DATABASE\_NAME&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_NAME&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;DATABASE\_USER&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_USER&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;DATABASE\_PASSWORD&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_PASSWORD&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;APP\_CONFIG&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;APP\_CONFIG&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;DJANGO\_SECRET\_KEY&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DJANGO\_SECRET\_KEY&#125;&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                \]</span><br><span class="line">              &#125;</span><br><span class="line">            \]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;Service&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;,</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">          &quot;description&quot;: &quot;Exposes the database server&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">        &quot;ports&quot;: \[</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;name&quot;: &quot;postgresql&quot;,</span><br><span class="line">            &quot;port&quot;: 5432,</span><br><span class="line">            &quot;targetPort&quot;: 5432</span><br><span class="line">          &#125;</span><br><span class="line">        \],</span><br><span class="line">        &quot;selector&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;kind&quot;: &quot;DeploymentConfig&quot;,</span><br><span class="line">      &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">      &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;,</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">          &quot;description&quot;: &quot;Defines how to deploy the database&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spec&quot;: &#123;</span><br><span class="line">        &quot;strategy&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Recreate&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;triggers&quot;: \[</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ImageChange&quot;,</span><br><span class="line">            &quot;imageChangeParams&quot;: &#123;</span><br><span class="line">              &quot;automatic&quot;: false,</span><br><span class="line">              &quot;containerNames&quot;: \[</span><br><span class="line">                &quot;postgresql&quot;</span><br><span class="line">              \],</span><br><span class="line">              &quot;from&quot;: &#123;</span><br><span class="line">                &quot;kind&quot;: &quot;ImageStreamTag&quot;,</span><br><span class="line">                &quot;namespace&quot;: &quot;openshift&quot;,</span><br><span class="line">                &quot;name&quot;: &quot;postgresql&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ConfigChange&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        \],</span><br><span class="line">        &quot;replicas&quot;: 1,</span><br><span class="line">        &quot;selector&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;template&quot;: &#123;</span><br><span class="line">          &quot;metadata&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;,</span><br><span class="line">            &quot;labels&quot;: &#123;</span><br><span class="line">              &quot;name&quot;: &quot;$&#123;DATABASE\_SERVICE\_NAME&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;spec&quot;: &#123;</span><br><span class="line">            &quot;containers&quot;: \[</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;name&quot;: &quot;postgresql&quot;,</span><br><span class="line">                &quot;image&quot;: &quot;postgresql&quot;,</span><br><span class="line">                &quot;ports&quot;: \[</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;containerPort&quot;: 5432</span><br><span class="line">                  &#125;</span><br><span class="line">                \],</span><br><span class="line">                &quot;env&quot;: \[</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;POSTGRESQL\_USER&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_USER&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;POSTGRESQL\_PASSWORD&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_PASSWORD&#125;&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;name&quot;: &quot;POSTGRESQL\_DATABASE&quot;,</span><br><span class="line">                    &quot;value&quot;: &quot;$&#123;DATABASE\_NAME&#125;&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                \]</span><br><span class="line">              &#125;</span><br><span class="line">            \]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  \],</span><br><span class="line">  &quot;parameters&quot;: \[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;SOURCE\_REPOSITORY\_URL&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;The URL of the repository with your application source code&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;https:&#x2F;&#x2F;github.com&#x2F;openshift&#x2F;django-ex.git&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;SOURCE\_REPOSITORY\_REF&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Set this to a branch name, tag or other ref of your repository if you are not using the default branch&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;CONTEXT\_DIR&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Set this to the relative path to your project if it is not in the root of your repository&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;APPLICATION\_DOMAIN&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;The exposed hostname that will route to the Django service, if left blank a value will be defaulted.&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;GITHUB\_WEBHOOK\_SECRET&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;A secret string used to configure the GitHub webhook&quot;,</span><br><span class="line">      &quot;generate&quot;: &quot;expression&quot;,</span><br><span class="line">      &quot;from&quot;: &quot;\[a-zA-Z0-9\]&#123;40&#125;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;DATABASE\_SERVICE\_NAME&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Database service name&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;postgresql&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;DATABASE\_ENGINE&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Database engine: postgresql, mysql or sqlite (default)&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;postgresql&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;DATABASE\_NAME&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Database name&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;default&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;DATABASE\_USER&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Database user name&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;django&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;DATABASE\_PASSWORD&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Database user password&quot;,</span><br><span class="line">      &quot;generate&quot;: &quot;expression&quot;,</span><br><span class="line">      &quot;from&quot;: &quot;\[a-zA-Z0-9\]&#123;16&#125;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;APP\_CONFIG&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Relative path to Gunicorn configuration file (optional)&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;DJANGO\_SECRET\_KEY&quot;,</span><br><span class="line">      &quot;description&quot;: &quot;Set this to a long random string&quot;,</span><br><span class="line">      &quot;generate&quot;: &quot;expression&quot;,</span><br><span class="line">      &quot;from&quot;: &quot;\[\\\\w\]&#123;50&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  \]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>应用管理：</p>
<p>创建应用：基于源码（首先将源码build成镜像），基于镜像，基于模板</p>
<p>基于源码创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oc new-app myproject&#x2F;my-ruby~https:&#x2F;&#x2F;github.com&#x2F;openshift&#x2F;ruby-hello-world.git （failed）</span><br><span class="line"> oc new-app &#x2F;home&#x2F;user&#x2F;code&#x2F;myapp --strategy&#x3D;docker</span><br></pre></td></tr></table></figure>
<p>基于镜像创建：</p>
<p>使用本地镜像创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc new-app 10.110.17.138:5000&#x2F;centos  --insecure-registry&#x3D;true</span><br></pre></td></tr></table></figure>
<p>ImageStreamTag</p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>文件定义一个部署，例如，可以使用内部的镜像，也可以使用外部的镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: frontend-1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    name: frontend</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: frontend</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: 172.30.90.102:5000&#x2F;demo&#x2F;hello-openshift</span><br><span class="line">        name: helloworld</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">      restartPolicy: Always</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="持久化存储-PersistentVolume"><a href="#持久化存储-PersistentVolume" class="headerlink" title="持久化存储 PersistentVolume "></a>持久化存储 PersistentVolume </h3><p>搭建NFS服务器，只支持NFSV4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**\[**root@oc**\-**master example**\]**\# cat **&#x2F;**etc**&#x2F;**exports</span><br><span class="line"></span><br><span class="line">**&#x2F;**opt**&#x2F;**docker-registry **192.168.6.0&#x2F;**24**(**rw**,**sync**,**no\_root\_squash**,**no\_all\_squash**)**</span><br><span class="line"></span><br><span class="line">**&#x2F;**openshift-pv **\*(**rw**,**all\_squash**)**</span><br><span class="line"></span><br><span class="line">**\[**root@oc**\-**master example**\]**\# mkdir **&#x2F;**openshift-pv</span><br><span class="line"></span><br><span class="line">**\[**root@oc**\-**master example**\]**\# chown **\-**R nfsnobody**:**nfsnobody &#x2F;openshift-pv</span><br><span class="line"></span><br><span class="line">**\[**root@oc**\-**master example**\]**\# chmod **777** **&#x2F;**opt**&#x2F;**openshift-pv**&#x2F;**</span><br></pre></td></tr></table></figure>

<p>创建PV:persistentvolume</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">**&#123;**</span><br><span class="line"></span><br><span class="line">  &quot;apiVersion&quot;**:** &quot;v1&quot;**,**</span><br><span class="line"></span><br><span class="line">  &quot;kind&quot;**:** &quot;PersistentVolume&quot;**,**</span><br><span class="line"></span><br><span class="line">  &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">    &quot;name&quot;**:** &quot;jenkins&quot;</span><br><span class="line"></span><br><span class="line">  **&#125;,**</span><br><span class="line"></span><br><span class="line">  &quot;spec&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">    &quot;capacity&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;storage&quot;**:** &quot;5Gi&quot;</span><br><span class="line"></span><br><span class="line">    **&#125;,**</span><br><span class="line"></span><br><span class="line">    &quot;accessModes&quot;**: \[** &quot;ReadWriteOnce&quot; **\],**</span><br><span class="line"></span><br><span class="line">    &quot;nfs&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;path&quot;**:** &quot;&#x2F;openshit-pv&quot;**,**</span><br><span class="line"></span><br><span class="line">        &quot;server&quot;**:** &quot;192.168.6.7&quot;</span><br><span class="line"></span><br><span class="line">    **&#125;,**</span><br><span class="line"></span><br><span class="line">    &quot;persistentVolumeReclaimPolicy&quot;**:** &quot;Recycle&quot;</span><br><span class="line"></span><br><span class="line">  **&#125;**</span><br><span class="line"></span><br><span class="line">**&#125;**</span><br></pre></td></tr></table></figure>
<p>举例：jenkins使用创建的PV</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line">**&#123;**</span><br><span class="line"></span><br><span class="line">  &quot;kind&quot;**:** &quot;Template&quot;**,**</span><br><span class="line"></span><br><span class="line">  &quot;apiVersion&quot;**:** &quot;v1&quot;**,**</span><br><span class="line"></span><br><span class="line">  &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">    &quot;name&quot;**:** &quot;jenkins-persistent&quot;**,**</span><br><span class="line"></span><br><span class="line">    &quot;creationTimestamp&quot;**:** null**,**</span><br><span class="line"></span><br><span class="line">    &quot;annotations&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">      &quot;description&quot;**:** &quot;Jenkins service, with persistent storage.&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;iconClass&quot;**:** &quot;icon-jenkins&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;tags&quot;**:** &quot;instant-app,jenkins&quot;</span><br><span class="line"></span><br><span class="line">    **&#125;**</span><br><span class="line"></span><br><span class="line">  **&#125;,**</span><br><span class="line"></span><br><span class="line">  &quot;objects&quot;**: \[**</span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;kind&quot;**:** &quot;Service&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;apiVersion&quot;**:** &quot;v1&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;**,**</span><br><span class="line"></span><br><span class="line">        &quot;creationTimestamp&quot;**:** null</span><br><span class="line"></span><br><span class="line">      **&#125;,**</span><br><span class="line"></span><br><span class="line">      &quot;spec&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;ports&quot;**: \[**</span><br><span class="line"></span><br><span class="line">          **&#123;**</span><br><span class="line"></span><br><span class="line">            &quot;name&quot;**:** &quot;web&quot;**,**</span><br><span class="line"></span><br><span class="line">            &quot;protocol&quot;**:** &quot;TCP&quot;**,**</span><br><span class="line"></span><br><span class="line">            &quot;port&quot;**:** **8080,**</span><br><span class="line"></span><br><span class="line">            &quot;targetPort&quot;**:** **8080,**</span><br><span class="line"></span><br><span class="line">            &quot;nodePort&quot;**:** **0**</span><br><span class="line"></span><br><span class="line">          **&#125;**</span><br><span class="line"></span><br><span class="line">        **\],**</span><br><span class="line"></span><br><span class="line">        &quot;selector&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">        **&#125;,**</span><br><span class="line"></span><br><span class="line">        &quot;portalIP&quot;**:** &quot;&quot;**,**</span><br><span class="line"></span><br><span class="line">        &quot;type&quot;**:** &quot;ClusterIP&quot;**,**</span><br><span class="line"></span><br><span class="line">        &quot;sessionAffinity&quot;**:** &quot;None&quot;</span><br><span class="line"></span><br><span class="line">      **&#125;**</span><br><span class="line"></span><br><span class="line">    **&#125;,**</span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;kind&quot;**:** &quot;Route&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;apiVersion&quot;**:** &quot;v1&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;name&quot;**:** &quot;jenkins&quot;**,**</span><br><span class="line"></span><br><span class="line">        &quot;creationTimestamp&quot;**:** null</span><br><span class="line"></span><br><span class="line">      **&#125;,**</span><br><span class="line"></span><br><span class="line">      &quot;spec&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;to&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;kind&quot;**:** &quot;Service&quot;**,**</span><br><span class="line"></span><br><span class="line">          &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">        **&#125;,**</span><br><span class="line"></span><br><span class="line">        &quot;tls&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;termination&quot;**:** &quot;edge&quot;**,**</span><br><span class="line"></span><br><span class="line">          &quot;certificate&quot;**:** &quot;-----BEGIN CERTIFICATE-----**\\n**MIIDIjCCAgqgAwIBAgIBATANBgkqhkiG9w0BAQUFADCBoTELMAkGA1UEBhMCVVMx**\\n**CzAJBgNVBAgMAlNDMRUwEwYDVQQHDAxEZWZhdWx0IENpdHkxHDAaBgNVBAoME0Rl**\\n**ZmF1bHQgQ29tcGFueSBMdGQxEDAOBgNVBAsMB1Rlc3QgQ0ExGjAYBgNVBAMMEXd3**\\n**dy5leGFtcGxlY2EuY29tMSIwIAYJKoZIhvcNAQkBFhNleGFtcGxlQGV4YW1wbGUu**\\n**Y29tMB4XDTE1MDExMjE0MTk0MVoXDTE2MDExMjE0MTk0MVowfDEYMBYGA1UEAwwP**\\n**d3d3LmV4YW1wbGUuY29tMQswCQYDVQQIDAJTQzELMAkGA1UEBhMCVVMxIjAgBgkq**\\n**hkiG9w0BCQEWE2V4YW1wbGVAZXhhbXBsZS5jb20xEDAOBgNVBAoMB0V4YW1wbGUx**\\n**EDAOBgNVBAsMB0V4YW1wbGUwgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMrv**\\n**gu6ZTTefNN7jjiZbS&#x2F;xvQjyXjYMN7oVXv76jbX8gjMOmg9m0xoVZZFAE4XyQDuCm**\\n**47VRx5Qrf&#x2F;YLXmB2VtCFvB0AhXr5zSeWzPwaAPrjA4ebG+LUo24ziS8KqNxrFs1M**\\n**mNrQUgZyQC6XIe1JHXc9t+JlL5UZyZQC1IfaJulDAgMBAAGjDTALMAkGA1UdEwQC**\\n**MAAwDQYJKoZIhvcNAQEFBQADggEBAFCi7ZlkMnESvzlZCvv82Pq6S46AAOTPXdFd**\\n**TMvrh12E1sdVALF1P1oYFJzG1EiZ5ezOx88fEDTW+Lxb9anw5&#x2F;KJzwtWcfsupf1m**\\n**V7J0D3qKzw5C1wjzYHh9&#x2F;Pz7B1D0KthQRATQCfNf8s6bbFLaw&#x2F;dmiIUhHLtIH5Qc**\\n**yfrejTZbOSP77z8NOWir+BWWgIDDB2&#x2F;&#x2F;3AkDIQvT20vmkZRhkqSdT7et4NmXOX&#x2F;j**\\n**jhPti4b2Fie0LeuvgaOdKjCpQQNrYthZHXeVlOLRhMTSk3qUczenkKTOhvP7IS9q**\\n**+Dzv5hqgSfvMG392KWh5f8xXfJNs4W5KLbZyl901MeReiLrPH3w&#x3D;**\\n**\-----END CERTIFICATE-----&quot;**,**</span><br><span class="line"></span><br><span class="line">          &quot;key&quot;**:** &quot;-----BEGIN PRIVATE KEY-----**\\n**MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBAMrvgu6ZTTefNN7j**\\n**jiZbS&#x2F;xvQjyXjYMN7oVXv76jbX8gjMOmg9m0xoVZZFAE4XyQDuCm47VRx5Qrf&#x2F;YL**\\n**XmB2VtCFvB0AhXr5zSeWzPwaAPrjA4ebG+LUo24ziS8KqNxrFs1MmNrQUgZyQC6X**\\n**Ie1JHXc9t+JlL5UZyZQC1IfaJulDAgMBAAECgYEAnxOjEj&#x2F;vrLNLMZE1Q9H7PZVF**\\n**WdP&#x2F;JQVNvQ7tCpZ3ZdjxHwkvf&#x2F;&#x2F;aQnuxS5yX2Rnf37BS&#x2F;TZu+TIkK4373CfHomSx**\\n**UTAn2FsLmOJljupgGcoeLx5K5nu7B7rY5L1NHvdpxZ4YjeISrRtEPvRakllENU5y**\\n**gJE8c2eQOx08ZSRE4TkCQQD7dws2&#x2F;FldqwdjJucYijsJVuUdoTqxP8gWL6bB251q**\\n**elP2&#x2F;a6W2elqOcWId28560jG9ZS3cuKvnmu&#x2F;4LG88vZFAkEAzphrH3673oTsHN+d**\\n**uBd5uyrlnGjWjuiMKv2TPITZcWBjB8nJDSvLneHF59MYwejNNEof2tRjgFSdImFH**\\n**mi995wJBAMtPjW6wiqRz0i41VuT9ZgwACJBzOdvzQJfHgSD9qgFb1CU&#x2F;J&#x2F;hpSRIM**\\n**kYvrXK9MbvQFvG6x4VuyT1W8mpe1LK0CQAo8VPpffhFdRpF7psXLK&#x2F;XQ&#x2F;0VLkG3O**\\n**KburipLyBg&#x2F;u9ZkaL0Ley5zL5dFBjTV2Qkx367Ic2b0u9AYTCcgi2DsCQQD3zZ7B**\\n**v7BOm7MkylKokY2MduFFXU0Bxg6pfZ7q3rvg8gqhUFbaMStPRYg6myiDiW&#x2F;JfLhF**\\n**TcFT4touIo7oriFJ**\\n**\-----END PRIVATE KEY-----&quot;**,**</span><br><span class="line"></span><br><span class="line">          &quot;caCertificate&quot;**:** &quot;-----BEGIN CERTIFICATE-----**\\n**MIIEFzCCAv+gAwIBAgIJALK1iUpF2VQLMA0GCSqGSIb3DQEBBQUAMIGhMQswCQYD**\\n**VQQGEwJVUzELMAkGA1UECAwCU0MxFTATBgNVBAcMDERlZmF1bHQgQ2l0eTEcMBoG**\\n**A1UECgwTRGVmYXVsdCBDb21wYW55IEx0ZDEQMA4GA1UECwwHVGVzdCBDQTEaMBgG**\\n**A1UEAwwRd3d3LmV4YW1wbGVjYS5jb20xIjAgBgkqhkiG9w0BCQEWE2V4YW1wbGVA**\\n**ZXhhbXBsZS5jb20wHhcNMTUwMTEyMTQxNTAxWhcNMjUwMTA5MTQxNTAxWjCBoTEL**\\n**MAkGA1UEBhMCVVMxCzAJBgNVBAgMAlNDMRUwEwYDVQQHDAxEZWZhdWx0IENpdHkx**\\n**HDAaBgNVBAoME0RlZmF1bHQgQ29tcGFueSBMdGQxEDAOBgNVBAsMB1Rlc3QgQ0Ex**\\n**GjAYBgNVBAMMEXd3dy5leGFtcGxlY2EuY29tMSIwIAYJKoZIhvcNAQkBFhNleGFt**\\n**cGxlQGV4YW1wbGUuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA**\\n**w2rK1J2NMtQj0KDug7g7HRKl5jbf0QMkMKyTU1fBtZ0cCzvsF4CqV11LK4BSVWaK**\\n**rzkaXe99IVJnH8KdOlDl5Dh&#x2F;+cJ3xdkClSyeUT4zgb6CCBqg78ePp+nN11JKuJlV**\\n**IG1qdJpB1J5O&#x2F;kCLsGcTf7RS74MtqMFo96446Zvt7YaBhWPz6gDaO&#x2F;TUzfrNcGLA**\\n**EfHVXkvVWqb3gqXUztZyVex&#x2F;gtP9FXQ7gxTvJml7UkmT0VAFjtZnCqmFxpLZFZ15**\\n**+qP9O7Q2MpsGUO&#x2F;4vDAuYrKBeg1ZdPSi8gwqUP2qWsGd9MIWRv3thI2903BczDc7**\\n**r8WaIbm37vYZAS9G56E4+wIDAQABo1AwTjAdBgNVHQ4EFgQUugLrSJshOBk5TSsU**\\n**ANs4+SmJUGwwHwYDVR0jBBgwFoAUugLrSJshOBk5TSsUANs4+SmJUGwwDAYDVR0T**\\n**BAUwAwEB&#x2F;zANBgkqhkiG9w0BAQUFAAOCAQEAaMJ33zAMV4korHo5aPfayV3uHoYZ**\\n**1ChzP3eSsF+FjoscpoNSKs91ZXZF6LquzoNezbfiihK4PYqgwVD2+O0&#x2F;Ty7UjN4S**\\n**qzFKVR4OS&#x2F;6lCJ8YncxoFpTntbvjgojf1DEataKFUN196PAANc3yz8cWHF4uvjPv**\\n**WkgFqbIjb+7D1YgglNyovXkRDlRZl0LD1OQ0ZWhd4Ge1qx8mmmanoBeYZ9+DgpFC**\\n**j9tQAbS867yeOryNe7sEOIpXAAqK&#x2F;DTu0hB6+ySsDfMo4piXCc2aA&#x2F;eI2DCuw08e**\\n**w17Dz9WnupZjVdwTKzDhFgJZMLDqn37HQnT6EemLFqbcR0VPEnfyhDtZIQ&#x3D;&#x3D;**\\n**\-----END CERTIFICATE-----&quot;</span><br><span class="line"></span><br><span class="line">        **&#125;**</span><br><span class="line"></span><br><span class="line">      **&#125;**</span><br><span class="line"></span><br><span class="line">    **&#125;,**</span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;kind&quot;**:** &quot;PersistentVolumeClaim&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;apiVersion&quot;**:** &quot;v1&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">      **&#125;,**</span><br><span class="line"></span><br><span class="line">      &quot;spec&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;accessModes&quot;**: \[**</span><br><span class="line"></span><br><span class="line">          &quot;ReadWriteOnce&quot;</span><br><span class="line"></span><br><span class="line">        **\],**</span><br><span class="line"></span><br><span class="line">        &quot;resources&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;requests&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">            &quot;storage&quot;**:** &quot;$&#123;VOLUME\_CAPACITY&#125;&quot;</span><br><span class="line"></span><br><span class="line">          **&#125;**</span><br><span class="line"></span><br><span class="line">        **&#125;**</span><br><span class="line"></span><br><span class="line">      **&#125;**</span><br><span class="line"></span><br><span class="line">    **&#125;,**   </span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;kind&quot;**:** &quot;DeploymentConfig&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;apiVersion&quot;**:** &quot;v1&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;**,**</span><br><span class="line"></span><br><span class="line">        &quot;creationTimestamp&quot;**:** null</span><br><span class="line"></span><br><span class="line">      **&#125;,**</span><br><span class="line"></span><br><span class="line">      &quot;spec&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">        &quot;strategy&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;type&quot;**:** &quot;Recreate&quot;**,**</span><br><span class="line"></span><br><span class="line">          &quot;resources&quot;**: &#123;&#125;**</span><br><span class="line"></span><br><span class="line">        **&#125;,**</span><br><span class="line"></span><br><span class="line">        &quot;triggers&quot;**: \[**</span><br><span class="line"></span><br><span class="line">          **&#123;**</span><br><span class="line"></span><br><span class="line">            &quot;type&quot;**:** &quot;ImageChange&quot;**,**</span><br><span class="line"></span><br><span class="line">            &quot;imageChangeParams&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">              &quot;automatic&quot;**:** **true,**</span><br><span class="line"></span><br><span class="line">              &quot;containerNames&quot;**: \[**</span><br><span class="line"></span><br><span class="line">                &quot;jenkins&quot;</span><br><span class="line"></span><br><span class="line">              **\],**</span><br><span class="line"></span><br><span class="line">              &quot;from&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">                &quot;kind&quot;**:** &quot;ImageStreamTag&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;name&quot;**:** &quot;jenkins-1-centos7:latest&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;namespace&quot;**:** &quot;openshift&quot;</span><br><span class="line"></span><br><span class="line">              **&#125;,**</span><br><span class="line"></span><br><span class="line">              &quot;lastTriggeredImage&quot;**:** &quot;&quot;</span><br><span class="line"></span><br><span class="line">            **&#125;**</span><br><span class="line"></span><br><span class="line">          **&#125;,**</span><br><span class="line"></span><br><span class="line">          **&#123;**</span><br><span class="line"></span><br><span class="line">            &quot;type&quot;**:** &quot;ConfigChange&quot;</span><br><span class="line"></span><br><span class="line">          **&#125;**</span><br><span class="line"></span><br><span class="line">        **\],**</span><br><span class="line"></span><br><span class="line">        &quot;replicas&quot;**:** **1,**</span><br><span class="line"></span><br><span class="line">        &quot;selector&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">        **&#125;,**</span><br><span class="line"></span><br><span class="line">        &quot;template&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">          &quot;metadata&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">            &quot;creationTimestamp&quot;**:** null**,**</span><br><span class="line"></span><br><span class="line">            &quot;labels&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">              &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">            **&#125;**</span><br><span class="line"></span><br><span class="line">          **&#125;,**</span><br><span class="line"></span><br><span class="line">          &quot;spec&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">            &quot;containers&quot;**: \[**</span><br><span class="line"></span><br><span class="line">              **&#123;**</span><br><span class="line"></span><br><span class="line">                &quot;name&quot;**:** &quot;jenkins&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;image&quot;**:** &quot;$&#123;JENKINS\_IMAGE&#125;&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;env&quot;**: \[**</span><br><span class="line"></span><br><span class="line">                  **&#123;**</span><br><span class="line"></span><br><span class="line">                    &quot;name&quot;**:** &quot;JENKINS\_PASSWORD&quot;**,**</span><br><span class="line"></span><br><span class="line">                    &quot;value&quot;**:** &quot;$&#123;JENKINS\_PASSWORD&#125;&quot;</span><br><span class="line"></span><br><span class="line">                  **&#125;**</span><br><span class="line"></span><br><span class="line">                **\],**</span><br><span class="line"></span><br><span class="line">                &quot;resources&quot;**: &#123;&#125;,**</span><br><span class="line"></span><br><span class="line">                &quot;volumeMounts&quot;**: \[**</span><br><span class="line"></span><br><span class="line">                  **&#123;**</span><br><span class="line"></span><br><span class="line">                    &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;-data&quot;**,**</span><br><span class="line"></span><br><span class="line">                    &quot;mountPath&quot;**:** &quot;&#x2F;var&#x2F;lib&#x2F;jenkins&quot;</span><br><span class="line"></span><br><span class="line">                  **&#125;**</span><br><span class="line"></span><br><span class="line">                **\],**</span><br><span class="line"></span><br><span class="line">                &quot;terminationMessagePath&quot;**:** &quot;&#x2F;dev&#x2F;termination-log&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;imagePullPolicy&quot;**:** &quot;IfNotPresent&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;capabilities&quot;**: &#123;&#125;,**</span><br><span class="line"></span><br><span class="line">                &quot;securityContext&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">                  &quot;capabilities&quot;**: &#123;&#125;,**</span><br><span class="line"></span><br><span class="line">                  &quot;privileged&quot;**:** **false**</span><br><span class="line"></span><br><span class="line">                **&#125;**</span><br><span class="line"></span><br><span class="line">              **&#125;**</span><br><span class="line"></span><br><span class="line">            **\],**</span><br><span class="line"></span><br><span class="line">            &quot;volumes&quot;**: \[**</span><br><span class="line"></span><br><span class="line">              **&#123;**</span><br><span class="line"></span><br><span class="line">                &quot;name&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;-data&quot;**,**</span><br><span class="line"></span><br><span class="line">                &quot;persistentVolumeClaim&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">                  &quot;claimName&quot;**:** &quot;$&#123;JENKINS\_SERVICE\_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">                **&#125;**</span><br><span class="line"></span><br><span class="line">              **&#125;**</span><br><span class="line"></span><br><span class="line">            **\],**</span><br><span class="line"></span><br><span class="line">            &quot;restartPolicy&quot;**:** &quot;Always&quot;**,**</span><br><span class="line"></span><br><span class="line">            &quot;dnsPolicy&quot;**:** &quot;ClusterFirst&quot;</span><br><span class="line"></span><br><span class="line">          **&#125;**</span><br><span class="line"></span><br><span class="line">        **&#125;**</span><br><span class="line"></span><br><span class="line">      **&#125;**</span><br><span class="line"></span><br><span class="line">    **&#125;**</span><br><span class="line"></span><br><span class="line">  **\],**</span><br><span class="line"></span><br><span class="line">  &quot;parameters&quot;**: \[**</span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;name&quot;**:** &quot;JENKINS\_SERVICE\_NAME&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;description&quot;**:** &quot;Jenkins service name&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;value&quot;**:** &quot;jenkins&quot;</span><br><span class="line"></span><br><span class="line">    **&#125;,**</span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;name&quot;**:** &quot;JENKINS\_PASSWORD&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;description&quot;**:** &quot;Password for the Jenkins user&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;generate&quot;**:** &quot;expression&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;value&quot;**:** &quot;password&quot;</span><br><span class="line"></span><br><span class="line">    **&#125;,**</span><br><span class="line"></span><br><span class="line">    **&#123;**</span><br><span class="line"></span><br><span class="line">      &quot;name&quot;**:** &quot;VOLUME\_CAPACITY&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;description&quot;**:** &quot;Volume space available for data, e.g. 512Mi, 2Gi&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;value&quot;**:** &quot;512Mi&quot;**,**</span><br><span class="line"></span><br><span class="line">      &quot;required&quot;**:** **true**</span><br><span class="line"></span><br><span class="line">    **&#125;**</span><br><span class="line"></span><br><span class="line">  **\],**</span><br><span class="line"></span><br><span class="line">  &quot;labels&quot;**: &#123;**</span><br><span class="line"></span><br><span class="line">    &quot;template&quot;**:** &quot;jenkins-persistent-template&quot;</span><br><span class="line"></span><br><span class="line">  **&#125;**</span><br><span class="line"></span><br><span class="line">**&#125;**</span><br></pre></td></tr></table></figure>
<h3 id="Route使用"><a href="#Route使用" class="headerlink" title="Route使用"></a>Route使用</h3><p>Route提供了外部访问服务的能力，此时需要外部dns的支持，dns的进行地址解析需要配置到haproxy-rouer所在的node节点IP</p>
<p>登录到haproxy-route所在的容器查看配置信息，确认是将每个应用的pod的IP地址配置到了haproxy的配置文件，完成负载均衡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">backend be\_http\_demo\_django-psql-example</span><br><span class="line"></span><br><span class="line">  mode http</span><br><span class="line"></span><br><span class="line">  option redispatch</span><br><span class="line"></span><br><span class="line">  option forwardfor</span><br><span class="line"></span><br><span class="line">  balance leastconn</span><br><span class="line"></span><br><span class="line">  timeout check **5000**ms</span><br><span class="line"></span><br><span class="line">  http-request set-header X-Forwarded-Host **%\[**req**.**hdr**(**host**)\]**</span><br><span class="line"></span><br><span class="line">  http-request set-header X-Forwarded-Port **%\[**dst\_port**\]**</span><br><span class="line"></span><br><span class="line">  http-request set-header X-Forwarded-Proto https if **&#123;** ssl\_fc **&#125;**</span><br><span class="line"></span><br><span class="line">    cookie OPENSHIFT\_demo\_django-psql-example\_SERVERID insert indirect nocache httponly</span><br><span class="line"></span><br><span class="line">    http-request set-header X-Forwarded-Proto http</span><br><span class="line"></span><br><span class="line">  http-request set-header Forwarded for**\&#x3D;%\[**src**\],**host**\&#x3D;%\[**req**.**hdr**(**host**)\],**proto**\&#x3D;%\[**req**.**hdr**(**X-Forwarded-Proto**)\]**</span><br><span class="line"></span><br><span class="line">  server **10.1.0.3:8080 10.1.0.3:8080** check inter **5000**ms cookie **10.1.0.3:8080**</span><br><span class="line"></span><br><span class="line">backend be\_http\_demo\_jenkins</span><br><span class="line"></span><br><span class="line">  mode http</span><br><span class="line"></span><br><span class="line">  option redispatch</span><br><span class="line"></span><br><span class="line">  option forwardfor</span><br><span class="line"></span><br><span class="line">  balance leastconn</span><br><span class="line"></span><br><span class="line">  timeout check **5000**ms</span><br><span class="line"></span><br><span class="line">  http-request set-header X-Forwarded-Host **%\[**req**.**hdr**(**host**)\]**</span><br><span class="line"></span><br><span class="line">  http-request set-header X-Forwarded-Port **%\[**dst\_port**\]**</span><br><span class="line"></span><br><span class="line">  http-request set-header X-Forwarded-Proto https if **&#123;** ssl\_fc **&#125;**</span><br><span class="line"></span><br><span class="line">    cookie OPENSHIFT\_demo\_jenkins\_SERVERID insert indirect nocache httponly</span><br><span class="line"></span><br><span class="line">    http-request set-header X-Forwarded-Proto http</span><br><span class="line"></span><br><span class="line">  http-request set-header Forwarded for**\&#x3D;%\[**src**\],**host**\&#x3D;%\[**req**.**hdr**(**host**)\],**proto**\&#x3D;%\[**req**.**hdr**(**X-Forwarded-Proto**)\]**</span><br><span class="line"></span><br><span class="line">  server **10.1.1.20:8080 10.1.1.20:8080** check inter **5000**ms cookie **10.1.1.20:8080**</span><br></pre></td></tr></table></figure>
<h4 id="DNS-配置"><a href="#DNS-配置" class="headerlink" title="DNS 配置"></a>DNS 配置</h4><p>DNS是基于ubuntu14.04 部署了bind9，参考配置：192.168.10.149为haproxy-router所在的节点IP（运行haproxy-router的容器所在的节点IP）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">root@origin**\-**dns**:&#x2F;**etc**&#x2F;**bind# cat **&#x2F;**etc**&#x2F;**bind**&#x2F;**named**.**conf**.**local</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Do any local configuration here</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Consider adding the 1918 zones here, if they are not used in your</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; organization</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;include &quot;&#x2F;etc&#x2F;bind&#x2F;zones.rfc1918&quot;;</span><br><span class="line"></span><br><span class="line">zone &quot;novalocal&quot; **&#123;**</span><br><span class="line"></span><br><span class="line">        **type** master**;**</span><br><span class="line"></span><br><span class="line">        file &quot;&#x2F;etc&#x2F;bind&#x2F;db.novalocal&quot;**;**</span><br><span class="line"></span><br><span class="line">**&#125;;**</span><br><span class="line"></span><br><span class="line">zone  &quot;devops.inspur&quot; **&#123;** </span><br><span class="line"></span><br><span class="line">     **type** master**;** </span><br><span class="line"></span><br><span class="line">     file &quot;&#x2F;etc&#x2F;bind&#x2F;db.devops.inspur&quot;**;** </span><br><span class="line"></span><br><span class="line">**&#125;;** </span><br><span class="line"></span><br><span class="line">zone  &quot;10.168.192.in-addr.arpa&quot; **&#123;** </span><br><span class="line"></span><br><span class="line">     **type** master**;** </span><br><span class="line"></span><br><span class="line">     file &quot;&#x2F;etc&#x2F;bind&#x2F;db.17.110.10&quot;**;** </span><br><span class="line"></span><br><span class="line">**&#125;;**</span><br><span class="line"></span><br><span class="line">cat db**.**devops**.**inspur</span><br><span class="line"></span><br><span class="line">**;** </span><br><span class="line"></span><br><span class="line">**;** BIND data file for dev sites </span><br><span class="line"></span><br><span class="line">**;** </span><br><span class="line"></span><br><span class="line">$TTL    **604800** </span><br><span class="line"></span><br><span class="line">@       IN      SOA     devops**.**inspur**.** root**.**devops**.**inspur**. (** </span><br><span class="line"></span><br><span class="line">                              **3**         **;** Serial </span><br><span class="line"></span><br><span class="line">                         **604800**         **;** Refresh </span><br><span class="line"></span><br><span class="line">                          **86400**         **;** Retry  </span><br><span class="line"></span><br><span class="line">                        **2419200**         **;** Expire </span><br><span class="line"></span><br><span class="line">                         **604800** **)       ;** Negative Cache TTL </span><br><span class="line"></span><br><span class="line">**;** </span><br><span class="line"></span><br><span class="line">@       IN      NS      devops**.**inspur**.** </span><br><span class="line"></span><br><span class="line">@       IN      A       **10.110.17.131**</span><br><span class="line"></span><br><span class="line">**\*.**devops**.**inspur**.**  **14400**   IN      A       **10.110.17.131**</span><br><span class="line"></span><br><span class="line">root@origin**\-**dns**:&#x2F;**etc**&#x2F;**bind# cat db.17.110.10</span><br><span class="line"></span><br><span class="line">**;** </span><br><span class="line"></span><br><span class="line">**;** BIND reverse data file for dev domains </span><br><span class="line"></span><br><span class="line">**;** </span><br><span class="line"></span><br><span class="line">$TTL    **604800** </span><br><span class="line"></span><br><span class="line">@       IN      SOA     dev**.** root**.**dev**. (** </span><br><span class="line"></span><br><span class="line">                              **3**         **;** Serial </span><br><span class="line"></span><br><span class="line">                         **604800**         **;** Refresh </span><br><span class="line"></span><br><span class="line">                          **86400**         **;** Retry </span><br><span class="line"></span><br><span class="line">                        **2419200**         **;** Expire </span><br><span class="line"></span><br><span class="line">                         **604800** **)       ;** Negative Cache TTL </span><br><span class="line"></span><br><span class="line">**;** </span><br><span class="line"></span><br><span class="line">@        IN      NS      devops**.**inspur**.** </span><br><span class="line"></span><br><span class="line">**149**      IN      PTR     devops**.**inspur**.**</span><br></pre></td></tr></table></figure>

<p>获取部署的应用对应的Router</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">**\[**root@origin**\-**master image-streams**\]**\# oc get route **\-**n demo</span><br><span class="line"></span><br><span class="line">NAME               HOST**&#x2F;**PORT                            PATH      SERVICE            LABELS                      INSECURE POLICY   TLS TERMINATION</span><br><span class="line"></span><br><span class="line">django-psql-test   www**.**django-psql-test**.**devops**.**inspur             django-psql-test   template**\&#x3D;**django-psql-test</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>windows或者linux配置dns地址就可以访问该应用</p>
<h2 id="S2I"><a href="#S2I" class="headerlink" title="S2I"></a>S2I</h2><p>参考（<a target="_blank" rel="noopener" href="https://github.com/openshift/source-to-image%EF%BC%89">https://github.com/openshift/source-to-image）</a></p>
<p>简单了解了S2I的思路，类似CloudFoundry的BuildPack，S2I基于build image+source code，使用脚本将源码打入build image，作为应用的docker image。这里的build image 类似CloudFoundry的buildpack，build image里面内置了应用的运行环境例如tomcat、jre、nginx</p>
<p>例如运行python程序的buil image</p>
<p><a target="_blank" rel="noopener" href="https://github.com/openshift/sti-python/tree/master/2.7">https://github.com/openshift/sti-python/tree/master/2.7</a></p>
<p><img src="file://C:/Users/wangd/AppData/Local/Temp/msohtmlclip1/01/clip_image005.jpg"></p>
<p>制作Build Image的DockerFile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">FROM openshift**&#x2F;**base-centos7</span><br><span class="line"></span><br><span class="line">\# This image provides a Python **2.7** environment you can use to run your Python</span><br><span class="line"></span><br><span class="line">\# applications**.**</span><br><span class="line"></span><br><span class="line">MAINTAINER SoftwareCollections**.**org **&lt;**sclorg@redhat**.**com**\&gt;**</span><br><span class="line"></span><br><span class="line">EXPOSE **8080**</span><br><span class="line"></span><br><span class="line">ENV PYTHON\_VERSION**\&#x3D;****2.7** \\</span><br><span class="line"></span><br><span class="line">    PATH**\&#x3D;**$HOME**&#x2F;.**local**&#x2F;**bin**&#x2F;:**$PATH</span><br><span class="line"></span><br><span class="line">LABEL io**.**k8s**.****description****\&#x3D;**&quot;Platform for building and running Python 2.7 applications&quot; \\</span><br><span class="line"></span><br><span class="line">      io**.**k8s**.**display-name**\&#x3D;**&quot;Python 2.7&quot; \\</span><br><span class="line"></span><br><span class="line">      io**.**openshift**.**expose-services**\&#x3D;**&quot;8080:http&quot; \\</span><br><span class="line"></span><br><span class="line">      io**.**openshift**.**tags**\&#x3D;**&quot;builder,python,python27,rh-python27&quot;</span><br><span class="line"></span><br><span class="line">RUN yum install **\-**y centos-release-scl **&amp;&amp;** \\</span><br><span class="line"></span><br><span class="line">    yum install **\-**y **\--**setopt**\&#x3D;**tsflags**\&#x3D;**nodocs **\--**enablerepo**\&#x3D;**centosplus python27 python27-python-devel python27-python-setuptools python27-python-pip epel-release **&amp;&amp;** \\</span><br><span class="line"></span><br><span class="line">    yum install **\-**y **\--**setopt**\&#x3D;**tsflags**\&#x3D;**nodocs install nss\_wrapper **&amp;&amp;** \\</span><br><span class="line"></span><br><span class="line">    yum clean all **\-**y</span><br><span class="line"></span><br><span class="line">\# Copy the S2I scripts from the specific language image to $STI\_SCRIPTS\_PATH</span><br><span class="line"></span><br><span class="line">COPY **.&#x2F;**s2i**&#x2F;**bin**&#x2F;** $STI\_SCRIPTS\_PATH</span><br><span class="line"></span><br><span class="line">\# Each language image can have &#39;contrib&#39; a directory with extra files needed to</span><br><span class="line"></span><br><span class="line">\# run and build the applications**.**</span><br><span class="line"></span><br><span class="line">COPY **.&#x2F;**contrib**&#x2F; &#x2F;**opt**&#x2F;**app-root</span><br><span class="line"></span><br><span class="line">RUN chown **\-**R **1001:0** **&#x2F;**opt**&#x2F;**app-root **&amp;&amp;** chmod **\-**R og**+**rwx **&#x2F;**opt**&#x2F;**app-root</span><br><span class="line"></span><br><span class="line">USER **1001**</span><br><span class="line"></span><br><span class="line">\# Set the **default** CMD to print the usage of the language image</span><br><span class="line"></span><br><span class="line">CMD $STI\_SCRIPTS\_PATH**&#x2F;**usage</span><br></pre></td></tr></table></figure>
<p>不同开发环境需要提供不同的build image，如果同一开发环境下，应用对运行环境需求不同，也需要开发不同的build image。</p>
<p>S2I 虽然简化了应用部署的流程，但是增加了更多的定制化过程。</p>
<p>建议使用场景：平台提供固定的几种build image。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/15/OpenStack-%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84OSLO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/15/OpenStack-%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84OSLO/" class="post-title-link" itemprop="url">OpenStack 源码中的OSLO</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-15 21:03:27 / 修改时间：21:07:15" itemprop="dateCreated datePublished" datetime="2020-09-15T21:03:27+08:00">2020-09-15</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Oslo"><a href="#Oslo" class="headerlink" title="Oslo"></a>Oslo</h3><p>在RYU的目录下可以找到cfg.py文件，这个文件中import了oslo的相关模块，以便调用时减少引用数目。从文件中可以发现oslo.config.cfg文件是关键文件，其在系统中的文件位置在：/usr/local/lib/python2.7/dist-packages/oslo/config/cfg.py。想查看源码的读者可以自行查看。在该cfg.py文件中 定义了ConfigOpts类，包含了_opts, _groups等成员变量。该类完成了命令行和配置参数的解析。</p>
<p>如果要快速学习某一个知识，最好的办法就是把它用起来。所以首先我会介绍一个入门的教程。如果你没有看懂，可以去看原始的<a target="_blank" rel="noopener" href="http://www.giantflyingsaucer.com/blog/?p=4822">教程</a>。</p>
<p>首先安装<a target="_blank" rel="noopener" href="https://virtualenv.pypa.io/en/latest/virtualenv.html">python-virtualenv</a>，此python库可以用于创建一个虚拟的，与外界隔离的运行环境，听起来和docker好像有点像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-virtualenv</span><br><span class="line">virtualenv example-app</span><br><span class="line">cd example-app</span><br><span class="line">source bin&#x2F;activate</span><br><span class="line">pip install oslo.config</span><br><span class="line">touch app.py</span><br><span class="line">touch app.conf</span><br></pre></td></tr></table></figure>



<p>然后修改app.conf。添加了两个group:simple和morestuff。simple组中有一个BoolOpt:enable。morestuff组有StrOpt, ListOpt, DictOpt, IntOpt,和FloatOpt。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[simple]</span><br><span class="line">enable &#x3D; True</span><br><span class="line">[morestuff]</span><br><span class="line"># StrOpt</span><br><span class="line">message &#x3D; Hello World</span><br><span class="line"># ListOpt</span><br><span class="line">usernames &#x3D; [&#39;Licheng&#39;, &#39;Muzixing&#39;, &#39;Distance&#39;]</span><br><span class="line"># DictOpt</span><br><span class="line">jobtitles &#x3D; &#123;&#39;Licheng&#39;: &#39;Manager&#39;, &#39;Muzixing&#39;: &#39;CEO&#39;, &#39;Distance&#39;: &#39;Security Guard&#39;&#125;</span><br><span class="line"># IntOpt</span><br><span class="line">payday &#x3D; 20</span><br><span class="line"># FloatOpt</span><br><span class="line">pi &#x3D; 3.14</span><br></pre></td></tr></table></figure>



<p>修改app.py文件。首先定义两个group，再对两个group的option进行定义。最后使用register_group和register_opts函数来完成group和option的注册。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import print_function</span><br><span class="line">from oslo.config import cfg</span><br><span class="line">opt_simple_group &#x3D; cfg.OptGroup(name&#x3D;&#39;simple&#39;,</span><br><span class="line">                         title&#x3D;&#39;A Simple Example&#39;)</span><br><span class="line">opt_morestuff_group &#x3D; cfg.OptGroup(name&#x3D;&#39;morestuff&#39;,</span><br><span class="line">                         title&#x3D;&#39;A More Complex Example&#39;)</span><br><span class="line">simple_opts &#x3D; [</span><br><span class="line">    cfg.BoolOpt(&#39;enable&#39;, default&#x3D;False,</span><br><span class="line">                help&#x3D;(&#39;True enables, False disables&#39;))</span><br><span class="line">]</span><br><span class="line">morestuff_opts &#x3D; [</span><br><span class="line">    cfg.StrOpt(&#39;message&#39;, default&#x3D;&#39;No data&#39;,</span><br><span class="line">               help&#x3D;(&#39;A message&#39;)),</span><br><span class="line">    cfg.ListOpt(&#39;usernames&#39;, default&#x3D;None,</span><br><span class="line">                help&#x3D;(&#39;A list of usernames&#39;)),</span><br><span class="line">    cfg.DictOpt(&#39;jobtitles&#39;, default&#x3D;None,</span><br><span class="line">                help&#x3D;(&#39;A dictionary of usernames and job titles&#39;)),</span><br><span class="line">    cfg.IntOpt(&#39;payday&#39;, default&#x3D;30,</span><br><span class="line">                help&#x3D;(&#39;Default payday monthly date&#39;)),</span><br><span class="line">    cfg.FloatOpt(&#39;pi&#39;, default&#x3D;0.0,</span><br><span class="line">                help&#x3D;(&#39;The value of Pi&#39;))</span><br><span class="line">]</span><br><span class="line">CONF &#x3D; cfg.CONF</span><br><span class="line">CONF.register_group(opt_simple_group)</span><br><span class="line">CONF.register_opts(simple_opts, opt_simple_group)</span><br><span class="line">CONF.register_group(opt_morestuff_group)</span><br><span class="line">CONF.register_opts(morestuff_opts, opt_morestuff\_group)</span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    CONF(default_config_files&#x3D;[&#39;app.conf&#39;])</span><br><span class="line">    print(&#39;(simple) enable: &#123;&#125;&#39;.format(CONF.simple.enable))</span><br><span class="line">    print(&#39;(morestuff) message :&#123;&#125;&#39;.format(CONF.morestuff.message))</span><br><span class="line">    print(&#39;(morestuff) usernames: &#123;&#125;&#39;.format(CONF.morestuff.usernames))</span><br><span class="line">    print(&#39;(morestuff) jobtitles: &#123;&#125;&#39;.format(CONF.morestuff.jobtitles))</span><br><span class="line">    print(&#39;(morestuff) payday: &#123;&#125;&#39;.format(CONF.morestuff.payday))</span><br><span class="line">    print(&#39;(morestuff) pi: &#123;&#125;&#39;.format(CONF.morestuff.pi))</span><br></pre></td></tr></table></figure>




<p>完成之后，运行app.py文件。可以查看到相关输出。</p>
<p>回到RYU中，之前一篇<a target="_blank" rel="noopener" href="http://www.muzixing.com/pages/2014/12/10/ryuxue-xi-eventlet.html">博客</a>介绍了RYU的main函数。在ryu/ryu/cmd/manager.py文件中我们可以看到如下的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONF.register_cli_opts([</span><br><span class="line">    cfg.ListOpt(&#39;app-lists&#39;, default&#x3D;[],</span><br><span class="line">                help&#x3D;&#39;application module name to run&#39;),</span><br><span class="line">    cfg.MultiStrOpt(&#39;app&#39;, positional&#x3D;True, default&#x3D;[],</span><br><span class="line">                    help&#x3D;&#39;application module name to run&#39;),</span><br><span class="line">    cfg.StrOpt(&#39;pid-file&#39;, default&#x3D;None, help&#x3D;&#39;pid file name&#39;),</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">以上的注册了三个Option，其中的app-lists和app参数是运行ryu-manager时的参数，即APP的名称。在以下的main函数中，我们可以看到首先获取了输入的参数，若参数为空，则默认开启ofp\_handler应用。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def main(args&#x3D;None, prog&#x3D;None):</span><br><span class="line">    try:</span><br><span class="line">        CONF(args&#x3D;args, prog&#x3D;prog,</span><br><span class="line">             project&#x3D;&#39;ryu&#39;, version&#x3D;&#39;ryu-manager %s&#39; % version,</span><br><span class="line">             default_config_files&#x3D;[&#39;&#x2F;usr&#x2F;local&#x2F;etc&#x2F;ryu&#x2F;ryu.conf&#39;])</span><br><span class="line">    except cfg.ConfigFilesNotFoundError:</span><br><span class="line">        CONF(args&#x3D;args, prog&#x3D;prog,</span><br><span class="line">             project&#x3D;&#39;ryu&#39;, version&#x3D;&#39;ryu-manager %s&#39; % version)</span><br><span class="line"></span><br><span class="line">    log.init_log()</span><br><span class="line"></span><br><span class="line">    if CONF.pid_file:</span><br><span class="line">        import os</span><br><span class="line">        with open(CONF.pid_file, &#39;w&#39;) as pid\_file:</span><br><span class="line">            pid_file.write(str(os.getpid()))</span><br><span class="line"></span><br><span class="line">    app_lists &#x3D; CONF.app_lists + CONF.app</span><br><span class="line">    # keep old behaivor, run ofp if no application is specified.</span><br><span class="line">    if not app_lists:</span><br><span class="line">        app_lists &#x3D; [&#39;ryu.controller.ofp_handler&#39;]</span><br></pre></td></tr></table></figure>



<p>oslo模块使用能够使得整个工程的不同模块可以使用同一个配置文件，从而减少了命令冲突的可能，此外，oslo提供的模板，可以让命令解析更方便。在oslo.config之外，还有oslo.db,oslo.messaging等。</p>
<p>  针对OpenStack 多个组件，OpenStack社区开发了不少公共组件OSOL：<a target="_blank" rel="noopener" href="https://github.com/openstack/?query=oslo">https://github.com/openstack/?query=oslo</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">205k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:06</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>

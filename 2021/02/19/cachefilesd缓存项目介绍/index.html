<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="c5YHonM6Ek6i_dIKMceKoszIqEtrVddsax9qcaoQfR4" />








  <meta name="baidu-site-verification" content="code-NBGBY3mVBb" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/robot-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/robot-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="原文引自这里 FS CacheFS-Cache是一种内核功能，网络文件系统或其他文件系统可以通过它来缓存数据到本地磁盘空间，减少网络传输的数据，从而提升性能。这在网络速度比较慢时会得到比较好的效果。 FS-Cache 可以被任何希望添加本地缓存的文件系统使用，例如：AFS、NFS、CIFS和Isofs。 FS-Cache 对于客户端文件系统是透明存在的，当这项功能开启的时候，透过缓存请求文件对于客">
<meta property="og:type" content="article">
<meta property="og:title" content="cachefilesd缓存项目介绍">
<meta property="og:url" content="https://damonyi.cc/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/index.html">
<meta property="og:site_name" content="云里雾里">
<meta property="og:description" content="原文引自这里 FS CacheFS-Cache是一种内核功能，网络文件系统或其他文件系统可以通过它来缓存数据到本地磁盘空间，减少网络传输的数据，从而提升性能。这在网络速度比较慢时会得到比较好的效果。 FS-Cache 可以被任何希望添加本地缓存的文件系统使用，例如：AFS、NFS、CIFS和Isofs。 FS-Cache 对于客户端文件系统是透明存在的，当这项功能开启的时候，透过缓存请求文件对于客">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://damonyi.cc/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/1.png">
<meta property="og:image" content="https://damonyi.cc/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/2.png">
<meta property="og:image" content="https://damonyi.cc/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/3.png">
<meta property="article:published_time" content="2021-02-19T01:33:17.000Z">
<meta property="article:modified_time" content="2021-02-22T02:03:56.572Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://damonyi.cc/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>

<script data-ad-client="ca-pub-1404859281731123" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>



  <link rel="canonical" href="https://damonyi.cc/2021/02/19/cachefilesd缓存项目介绍/"/>


<script data-ad-client="ca-pub-1404859281731123" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>



  <title>cachefilesd缓存项目介绍 | 云里雾里</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">云里雾里</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://damonyi.cc/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">cachefilesd缓存项目介绍</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T09:33:17+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.5k字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  22分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>原文引自<a href="https://www.kernel.org/doc/html/latest/filesystems/caching/cachefiles.html" target="_blank" rel="noopener">这里</a></p>
<h2 id="FS-Cache"><a href="#FS-Cache" class="headerlink" title="FS Cache"></a>FS Cache</h2><p>FS-Cache是一种内核功能，网络文件系统或其他文件系统可以通过它来缓存数据到本地磁盘空间，减少网络传输的数据，从而提升性能。这在网络速度比较慢时会得到比较好的效果。</p>
<p>FS-Cache 可以被任何希望添加本地缓存的文件系统使用，例如：AFS、NFS、CIFS和Isofs。</p>
<p>FS-Cache 对于客户端文件系统是透明存在的，当这项功能开启的时候，透过缓存请求文件对于客户端是无感知的。可以参考下图，FS-Cache可以认为是网络文件系统和缓存后端的中间介质:<br><img src="/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/1.png" alt="avatar"></p>
<p>看一个更详细的图，FS-Cache为网络文件系统提供了一个缓存工具，从而让缓存对用户无感知<br><img src="/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/2.png" alt="avatar"></p>
<p>FS-Cache并不遵循在允许访问之前将所有完全打开的每个netfs文件完全加载到高速缓存中，主要有以下几个原因：</p>
<ol>
<li>没有Cache 也应该能够正常操作</li>
<li>被访问的文件的大小不应该受限于Cache的空间大小</li>
<li>所有已经打开的文件大小不应该受限于Cache的空间大小</li>
<li>不应该强制用户为了一个文件操作（访问文件的一小部分）将整个文件全部进行下载缓存</li>
</ol>
<p>FS-Cache提供的能力如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. More than one cache can be used at once. Caches can be selected explicitly by use of tags. 一次可以使用多个Cache，不同的Cache使用不同的tag区分</span><br><span class="line">2. Caches can be added &#x2F; removed at any time. Cache可以在任何时间被移除或者添加</span><br><span class="line">3. The netfs is provided with an interface that allows either party to withdraw caching facilities from a file (required for (2)). 网络文件系统提供接口，能够允许其他方删除文件cache相关的能力</span><br><span class="line">4. The interface to the netfs returns as few errors as possible, preferring rather to let the netfs remain oblivious. 网络文件系统尽量不要返回错误</span><br><span class="line">5. Cookies are used to represent indices, files and other objects to the netfs. The simplest cookie is just a NULL pointer - indicating nothing cached there. 使用cookie表示文件系统的目录、文件、其他对象</span><br><span class="line">6. The netfs is allowed to propose - dynamically - any index hierarchy it desires, though it must be aware that the index search function is recursive, stack space is limited, and indices can only be children of indices.</span><br><span class="line">7. Data I&#x2F;O is done direct to and from the netfs’s pages. The netfs indicates that page A is at index B of the data-file represented by cookie C, and that it should be read or written. The cache backend may or may not start I&#x2F;O on that page, but if it does, a netfs callback will be invoked to indicate completion. The I&#x2F;O may be either synchronous or asynchronous.</span><br><span class="line">8. Cookies can be “retired” upon release. At this point FS-Cache will mark them as obsolete and the index hierarchy rooted at that point will get recycled.</span><br><span class="line">9. The netfs provides a “match” function for index searches. In addition to saying whether a match was made or not, this can also specify that an entry should be updated or deleted.</span><br><span class="line">10. As much as possible is done asynchronously.</span><br></pre></td></tr></table></figure>

<p>FS-Cache维护了一个网络文件系统数据的全部索引，该信息可以位于一个或者多个cache中，如下图所示：</p>
<p><img src="/2021/02/19/cachefilesd%E7%BC%93%E5%AD%98%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/3.png" alt="avatar"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In the example above, you can see two netfs’s being backed: NFS and AFS. These have different index hierarchies:</span><br><span class="line"></span><br><span class="line">* The NFS primary index contains per-server indices. Each server index is indexed by NFS file handles to get data file objects. Each data file objects can have an array of pages, but may also have further child objects, such as extended attributes and directory entries. Extended attribute objects themselves have page-array contents.</span><br><span class="line">* The AFS primary index contains per-cell indices. Each cell index contains per-logical-volume indices. Each of volume index contains up to three indices for the read-write, read-only and backup mirrors of those volumes. Each of these contains vnode data file objects, each of which contains an array of pages.</span><br></pre></td></tr></table></figure>
<h2 id="Kernel-内部的Cache-管理"><a href="#Kernel-内部的Cache-管理" class="headerlink" title="Kernel 内部的Cache 管理"></a>Kernel 内部的Cache 管理</h2><p>FS-Cache维护类内核形态的网络文件感兴趣的对象，这些对象使用fscache_cookie 结构体来表示，以cookie的方式被引用。</p>
<p>FS-Cache 也单独维护了内核形态的 缓存后端正在使用的对象cache</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">FS-Cache maintains an in-kernel representation of each object that a netfs is currently interested in. Such objects are represented by the fscache_cookie struct and are referred to as cookies.</span><br><span class="line"></span><br><span class="line">FS-Cache also maintains a separate in-kernel representation of the objects that a cache backend is currently actively caching. Such objects are represented by the fscache_object struct. The cache backends allocate these upon request, and are expected to embed them in their own representations. These are referred to as objects.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">There is a 1:N relationship between cookies and objects. A cookie may be represented by multiple objects - an index may exist in more than one cache - or even by no objects (it may not be cached).</span><br><span class="line"></span><br><span class="line">Furthermore, both cookies and objects are hierarchical. The two hierarchies correspond, but the cookies tree is a superset of the union of the object trees of multiple caches:</span><br><span class="line"></span><br><span class="line">    NETFS INDEX TREE               :      CACHE 1     :      CACHE 2</span><br><span class="line">                                   :                  :</span><br><span class="line">                                   :   +-----------+  :</span><br><span class="line">                          +-----------&gt;|  IObject  |  :</span><br><span class="line">      +-----------+       |        :   +-----------+  :</span><br><span class="line">      |  ICookie  |-------+        :         |        :</span><br><span class="line">      +-----------+       |        :         |        :   +-----------+</span><br><span class="line">            |             +------------------------------&gt;|  IObject  |</span><br><span class="line">            |                      :         |        :   +-----------+</span><br><span class="line">            |                      :         V        :         |</span><br><span class="line">            |                      :   +-----------+  :         |</span><br><span class="line">            V             +-----------&gt;|  IObject  |  :         |</span><br><span class="line">      +-----------+       |        :   +-----------+  :         |</span><br><span class="line">      |  ICookie  |-------+        :         |        :         V</span><br><span class="line">      +-----------+       |        :         |        :   +-----------+</span><br><span class="line">            |             +------------------------------&gt;|  IObject  |</span><br><span class="line">      +-----+-----+                :         |        :   +-----------+</span><br><span class="line">      |           |                :         |        :         |</span><br><span class="line">      V           |                :         V        :         |</span><br><span class="line">+-----------+     |                :   +-----------+  :         |</span><br><span class="line">|  ICookie  |-------------------------&gt;|  IObject  |  :         |</span><br><span class="line">+-----------+     |                :   +-----------+  :         |</span><br><span class="line">      |           V                :         |        :         V</span><br><span class="line">      |     +-----------+          :         |        :   +-----------+</span><br><span class="line">      |     |  ICookie  |--------------------------------&gt;|  IObject  |</span><br><span class="line">      |     +-----------+          :         |        :   +-----------+</span><br><span class="line">      V           |                :         V        :         |</span><br><span class="line">+-----------+     |                :   +-----------+  :         |</span><br><span class="line">|  DCookie  |-------------------------&gt;|  DObject  |  :         |</span><br><span class="line">+-----------+     |                :   +-----------+  :         |</span><br><span class="line">                  |                :                  :         |</span><br><span class="line">          +-------+-------+        :                  :         |</span><br><span class="line">          |               |        :                  :         |</span><br><span class="line">          V               V        :                  :         V</span><br><span class="line">    +-----------+   +-----------+  :                  :   +-----------+</span><br><span class="line">    |  DCookie  |   |  DCookie  |------------------------&gt;|  DObject  |</span><br><span class="line">    +-----------+   +-----------+  :                  :   +-----------+</span><br><span class="line">                                   :                  :</span><br><span class="line">In the above illustration, ICookie and IObject represent indices and DCookie and DObject represent data storage objects. Indices may have representation in multiple caches, but currently, non-index objects may not. Objects of any type may also be entirely unrepresented.</span><br><span class="line"></span><br><span class="line">As far as the netfs API goes, the netfs is only actually permitted to see pointers to the cookies. The cookies themselves and any objects attached to those cookies are hidden from it.</span><br></pre></td></tr></table></figure>

<h2 id="对象管理状态机"><a href="#对象管理状态机" class="headerlink" title="对象管理状态机"></a>对象管理状态机</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Within FS-Cache, each active object is managed by its own individual state machine. The state for an object is kept in the fscache_object struct, in object-&gt;state. A cookie may point to a set of objects that are in different states.</span><br><span class="line"></span><br><span class="line">Each state has an action associated with it that is invoked when the machine wakes up in that state. There are four logical sets of states:</span><br><span class="line"></span><br><span class="line">* Preparation: states that wait for the parent objects to become ready. The representations are hierarchical, and it is expected that an object must be created or accessed with respect to its parent object.</span><br><span class="line">* Initialisation: states that perform lookups in the cache and validate what’s found and that create on disk any missing metadata.</span><br><span class="line">* Normal running: states that allow netfs operations on objects to proceed and that update the state of objects.</span><br><span class="line">*  Termination: states that detach objects from their netfs cookies, that delete objects from disk, that handle disk and system errors and that free up in-memory resources.</span><br><span class="line">  </span><br><span class="line">In most cases, transitioning between states is in response to signalled events. When a state has finished processing, it will usually set the mask of events in which it is interested (object-&gt;event_mask) and relinquish the worker thread. Then when an event is raised (by calling fscache_raise_event()), if the event is not masked, the object will be queued for processing (by calling fscache_enqueue_object()).</span><br></pre></td></tr></table></figure>

<h2 id="Provision-of-CPU-Time"><a href="#Provision-of-CPU-Time" class="headerlink" title="Provision of CPU Time"></a>Provision of CPU Time</h2><p>The work to be done by the various states was given CPU time by the threads of the slow work facility. This was used in preference to the workqueue facility because:</p>
<p>Threads may be completely occupied for very long periods of time by a particular work item. These state actions may be doing sequences of synchronous, journalled disk accesses (lookup, mkdir, create, setxattr, getxattr, truncate, unlink, rmdir, rename).</p>
<p>Threads may do little actual work, but may rather spend a lot of time sleeping on I/O. This means that single-threaded and 1-per-CPU-threaded workqueues don’t necessarily have the right numbers of threads.</p>
<h2 id="Locking-Simplification"><a href="#Locking-Simplification" class="headerlink" title="Locking Simplification"></a>Locking Simplification</h2><p>Because only one worker thread may be operating on any particular object’s state machine at once, this simplifies the locking, particularly with respect to disconnecting the netfs’s representation of a cache object (fscache_cookie) from the cache backend’s representation (fscache_object) - which may be requested from either end.</p>
<h2 id="状态集合"><a href="#状态集合" class="headerlink" title="状态集合"></a>状态集合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">The Set of States</span><br><span class="line">The object state machine has a set of states that it can be in. There are preparation states in which the object sets itself up and waits for its parent object to transit to a state that allows access to its children:</span><br><span class="line"></span><br><span class="line">1. State FSCACHE_OBJECT_INIT.</span><br><span class="line"></span><br><span class="line">Initialise the object and wait for the parent object to become active. In the cache, it is expected that it will not be possible to look an object up from the parent object, until that parent object itself has been looked up.</span><br><span class="line"></span><br><span class="line">There are initialisation states in which the object sets itself up and accesses disk for the object metadata:</span><br><span class="line"></span><br><span class="line">2. State FSCACHE_OBJECT_LOOKING_UP.</span><br><span class="line"></span><br><span class="line">Look up the object on disk, using the parent as a starting point. FS-Cache expects the cache backend to probe the cache to see whether this object is represented there, and if it is, to see if it’s valid (coherency management).</span><br><span class="line"></span><br><span class="line">The cache should call fscache_object_lookup_negative() to indicate lookup failure for whatever reason, and should call fscache_obtained_object() to indicate success.</span><br><span class="line"></span><br><span class="line">At the completion of lookup, FS-Cache will let the netfs go ahead with read operations, no matter whether the file is yet cached. If not yet cached, read operations will be immediately rejected with ENODATA until the first known page is uncached - as to that point there can be no data to be read out of the cache for that file that isn’t currently also held in the pagecache.</span><br><span class="line"></span><br><span class="line">3. State FSCACHE_OBJECT_CREATING.</span><br><span class="line"></span><br><span class="line">Create an object on disk, using the parent as a starting point. This happens if the lookup failed to find the object, or if the object’s coherency data indicated what’s on disk is out of date. In this state, FS-Cache expects the cache to create</span><br><span class="line"></span><br><span class="line">The cache should call fscache_obtained_object() if creation completes successfully, fscache_object_lookup_negative() otherwise.</span><br><span class="line"></span><br><span class="line">At the completion of creation, FS-Cache will start processing write operations the netfs has queued for an object. If creation failed, the write ops will be transparently discarded, and nothing recorded in the cache.</span><br><span class="line"></span><br><span class="line">There are some normal running states in which the object spends its time servicing netfs requests:</span><br><span class="line"></span><br><span class="line">4. State FSCACHE_OBJECT_AVAILABLE.</span><br><span class="line"></span><br><span class="line">A transient state in which pending operations are started, child objects are permitted to advance from FSCACHE_OBJECT_INIT state, and temporary lookup data is freed.</span><br><span class="line"></span><br><span class="line">5. State FSCACHE_OBJECT_ACTIVE.</span><br><span class="line"></span><br><span class="line">The normal running state. In this state, requests the netfs makes will be passed on to the cache.</span><br><span class="line"></span><br><span class="line">6. State FSCACHE_OBJECT_INVALIDATING.</span><br><span class="line"></span><br><span class="line">The object is undergoing invalidation. When the state comes here, it discards all pending read, write and attribute change operations as it is going to clear out the cache entirely and reinitialise it. It will then continue to the FSCACHE_OBJECT_UPDATING state.</span><br><span class="line"></span><br><span class="line">7. State FSCACHE_OBJECT_UPDATING.</span><br><span class="line"></span><br><span class="line">The state machine comes here to update the object in the cache from the netfs’s records. This involves updating the auxiliary data that is used to maintain coherency.</span><br><span class="line"></span><br><span class="line">And there are terminal states in which an object cleans itself up, deallocates memory and potentially deletes stuff from disk:</span><br><span class="line"></span><br><span class="line">8. State FSCACHE_OBJECT_LC_DYING.</span><br><span class="line"></span><br><span class="line">The object comes here if it is dying because of a lookup or creation error. This would be due to a disk error or system error of some sort. Temporary data is cleaned up, and the parent is released.</span><br><span class="line"></span><br><span class="line">9. State FSCACHE_OBJECT_DYING.</span><br><span class="line"></span><br><span class="line">The object comes here if it is dying due to an error, because its parent cookie has been relinquished by the netfs or because the cache is being withdrawn.</span><br><span class="line"></span><br><span class="line">Any child objects waiting on this one are given CPU time so that they too can destroy themselves. This object waits for all its children to go away before advancing to the next state.</span><br><span class="line"></span><br><span class="line">10. State FSCACHE_OBJECT_ABORT_INIT.</span><br><span class="line"></span><br><span class="line">The object comes to this state if it was waiting on its parent in FSCACHE_OBJECT_INIT, but its parent died. The object will destroy itself so that the parent may proceed from the FSCACHE_OBJECT_DYING state.</span><br><span class="line"></span><br><span class="line">11. State FSCACHE_OBJECT_RELEASING.</span><br><span class="line"></span><br><span class="line">12. State FSCACHE_OBJECT_RECYCLING.</span><br><span class="line"></span><br><span class="line">The object comes to one of these two states when dying once it is rid of all its children, if it is dying because the netfs relinquished its cookie. In the first state, the cached data is expected to persist, and in the second it will be deleted.</span><br><span class="line"></span><br><span class="line">13. State FSCACHE_OBJECT_WITHDRAWING.</span><br><span class="line"></span><br><span class="line">The object transits to this state if the cache decides it wants to withdraw the object from service, perhaps to make space, but also due to error or just because the whole cache is being withdrawn.</span><br><span class="line"></span><br><span class="line">14. State FSCACHE_OBJECT_DEAD.</span><br><span class="line"></span><br><span class="line">The object transits to this state when the in-memory object record is ready to be deleted. The object processor shouldn’t ever see an object in this state.</span><br></pre></td></tr></table></figure>

<h2 id="CacheFiles介绍"><a href="#CacheFiles介绍" class="headerlink" title="CacheFiles介绍"></a>CacheFiles介绍</h2><p>CacheFiles,是属于Linux Kernel的一个模块，主要用于缓存已经挂载的文件系统，CacheFiles 是一个缓存后端，当一个文件系统挂载到本地时，可以基于CacheFiles做一个缓存目录，CacheFi 使用一个用户空间的守护进程进行cache管理，例如收割陈旧的节点和剔除，这个守护进程被称为cachefilesd</p>
<p>缓存的文件系统和数据完整性与后端服务的文件系统一样好，由于不同文件系统的日志记录接口都是特殊定义的，因此CacheFiles不会尝试记录任文件系统日志</p>
<p>CacheFiles 会创建一个混杂的字符设备”/dev/cachefiles”,用于与守护进程进行通信，这个设备一次打开只能做一次事情，当它打开时，至少存在部分缓存，守护进程打开 并发送指令用于控制缓存，CacheFiles目前只能用于一个单独的缓存</p>
<p>CacheFiles会尝试维护文件系统一定比例的空闲空间，可能会通过剔除部分cache用户缩小cache的大小，用于释放空间，这就意味着可以在同一介质上存放灵活的实时数据，可能会扩展来使用空闲的空间，也可能收缩</p>
<h2 id="Requiremenets"><a href="#Requiremenets" class="headerlink" title="Requiremenets"></a>Requiremenets</h2><p>使用CacheFiles 需要以下依赖</p>
<ul>
<li>dnotify: 对文件信号进行监听</li>
<li>extended attribute（xattrs）</li>
<li>openat() and friends</li>
<li>bmap() support on files in the filesystem (FIBMAP ioctl)</li>
<li>the use of bmap() to detect a partial page at the end of the file</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>配置文件 /etc/cachefilesd.conf,配置文件的主要内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">brun &lt;N&gt;%, bcull &lt;N&gt;%, bstop &lt;N&gt;%, frun &lt;N&gt;%, fcull &lt;N&gt;%, fstop &lt;N&gt;%</span><br><span class="line">Configure the culling limits. Optional. See the section on culling The defaults are 7% (run), 5% (cull) and 1% (stop) respectively.</span><br><span class="line"></span><br><span class="line">The commands beginning with a ‘b’ are file space (block) limits, those beginning with an ‘f’ are file count limits(也可以限制文件数量).</span><br><span class="line"></span><br><span class="line">dir &lt;path&gt; 存放缓存的根目录</span><br><span class="line">Specify the directory containing the root of the cache. Mandatory.</span><br><span class="line">tag &lt;name&gt; </span><br><span class="line">Specify a tag to FS-Cache to use in distinguishing multiple caches. Optional. The default is “CacheFiles”.</span><br><span class="line">debug &lt;mask&gt;  用于开启日志</span><br><span class="line">Specify a numeric bitmask to control debugging in the kernel module. Optional. The default is zero (all off). The following values can be OR’d into the mask to collect various information:</span><br><span class="line"></span><br><span class="line">1	Turn on trace of function entry (_enter() macros)</span><br><span class="line">2	Turn on trace of function exit (_leave() macros)</span><br><span class="line">4	Turn on trace of internal debug points (_debug())</span><br><span class="line">This mask can also be set through sysfs, eg:</span><br><span class="line"></span><br><span class="line">echo 5 &gt;&#x2F;sys&#x2F;modules&#x2F;cachefiles&#x2F;parameters&#x2F;debug</span><br></pre></td></tr></table></figure>

<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>启动守护进程，该守护进程打开 cache 设备（/dev/cachefiles）,配置cache，并开始进行cache，此时cache绑定fscache，cache开始运行。具体的启动命令和参数如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">The daemon is run as follows:</span><br><span class="line"></span><br><span class="line">&#x2F;sbin&#x2F;cachefilesd [-d]* [-s] [-n] [-f &lt;configfile&gt;]</span><br><span class="line">The flags are:</span><br><span class="line"></span><br><span class="line">-d</span><br><span class="line">Increase the debugging level. This can be specified multiple times and is cumulative with itself.</span><br><span class="line">-s</span><br><span class="line">Send messages to stderr instead of syslog.</span><br><span class="line">-n</span><br><span class="line">Don’t daemonise and go into background.</span><br><span class="line">-f &lt;configfile&gt;</span><br><span class="line">Use an alternative configuration file rather than the default one.</span><br></pre></td></tr></table></figure>

<h2 id="缓存剔除"><a href="#缓存剔除" class="headerlink" title="缓存剔除"></a>缓存剔除</h2><p>缓存偶尔需要进行清理，用于释放空间，这里主要将近期未被使用的cache进行清理，基于文件的访问时间进行判断，如果空目录没有在使用也会被清理。Cache的清理是基于配置的当前文件系统的block比例和文件比例，主要有6个限制，如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">brun, frun</span><br><span class="line">If the amount of free space and the number of available files in the cache rises above both these limits, then culling is turned off.当缓存中空闲的block和file 都高于该值时，不进行缓存剔除</span><br><span class="line">bcull, fcull</span><br><span class="line">If the amount of available space or the number of available files in the cache falls below either of these limits, then culling is started.当缓存中可以使用的block或者files 有一个低于该值时，进行缓存剔除</span><br><span class="line">bstop, fstop</span><br><span class="line">If the amount of available space or the number of available files in the cache falls below either of these limits, then no further allocation of disk space or files is permitted until culling has raised things above these limits again.当缓存中可以使用的block或者files有一个低于该值时，除非缓存剔除机制进行了缓存剔除，否则不会再分配磁盘空间，</span><br></pre></td></tr></table></figure>
<p>通常配置是这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 &lt;&#x3D; bstop &lt; bcull &lt; brun &lt; 100</span><br><span class="line">0 &lt;&#x3D; fstop &lt; fcull &lt; frun &lt; 100</span><br></pre></td></tr></table></figure>

<p>需要注意，这些值是表示的可以使用的空间和文件，并不是100 减去使用df 查看的信息，用户空间的守护进程扫描cache，来建立一个需要提出的对象表，基于最少使用原则进行剔除。“ A new scan of the cache is started as soon as space is made in the table”，如果对象的atimes(最后访问时间)发生了变化，不会进行剔除，或者内核模块通知说该文件仍然在使用，也不会删除该cache</p>
<h2 id="缓存结构"><a href="#缓存结构" class="headerlink" title="缓存结构"></a>缓存结构</h2><p>会存在两个目录 </p>
<ul>
<li>cache/</li>
<li>graveyard/</li>
</ul>
<p>活动的cache 对象会存放在 cache/ 目录。CacheFile的内核模块会将不再使用或者剔除的对象移动到graveyard 目录，守护进程会在graveyard进行删除，守护进程使用dnotify来监控graveyard目录，然后会将graveyard存在的对象删除。</p>
<ul>
<li><p>CacheFiles 模块将索引对象使用目录的方式进行表示，目录名称可能是”I….”或者”J….”</p>
</li>
<li><p>没有子对象的数据对象会以文件的方式进行表示，有子对象的数据对象会以目录的形式进行表示，文件名称可能是”D…”或者”E….”。如果表示目录，那么会有一个叫”data”的文件在该目录，用户真实的保存数据</p>
</li>
</ul>
<ul>
<li>特殊的对象，通数据对象类似，不过文件名是以”S….”或者”T…”的形式</li>
</ul>
<p>如果一个对象有子对象，那么他会以目录的形式表示，在该目录下会有一系列子目录，子目录的名称以@+子对象的哈希值命名，如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;INDEX    &#x2F;INDEX     &#x2F;INDEX                            &#x2F;DATA FILES</span><br><span class="line">&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">cache&#x2F;@4a&#x2F;I03nfs&#x2F;@30&#x2F;Ji000000000000000--fHg8hi8400</span><br><span class="line">cache&#x2F;@4a&#x2F;I03nfs&#x2F;@30&#x2F;Ji000000000000000--fHg8hi8400&#x2F;@75&#x2F;Es0g000w...DB1ry</span><br><span class="line">cache&#x2F;@4a&#x2F;I03nfs&#x2F;@30&#x2F;Ji000000000000000--fHg8hi8400&#x2F;@75&#x2F;Es0g000w...N22ry</span><br><span class="line">cache&#x2F;@4a&#x2F;I03nfs&#x2F;@30&#x2F;Ji000000000000000--fHg8hi8400&#x2F;@75&#x2F;Es0g000w...FP1ry</span><br></pre></td></tr></table></figure>

<p>如果文件名称太长，超过了NAME_MAX的大小，那么会被分成多分，第一份被用于创建嵌套目录，最后一份会位于最后一个目录，每个中间目录的名称会以”+”作为前缀，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">J1223&#x2F;@23&#x2F;+xy...z&#x2F;+kl...m&#x2F;Epqr</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Note that keys are raw data, and not only may they exceed NAME_MAX in size, they may also contain things like ‘&#x2F;’ and NUL characters, and so they may not be suitable for turning directly into a filename.</span><br><span class="line"></span><br><span class="line">To handle this, CacheFiles will use a suitably printable filename directly and “base-64” encode ones that aren’t directly suitable. The two versions of object filenames indicate the encoding:</span><br><span class="line"></span><br><span class="line">OBJECT TYPE	PRINTABLE	ENCODED</span><br><span class="line">Index	“I…”	“J…”</span><br><span class="line">Data	“D…”	“E…”</span><br><span class="line">Special	“S…”	“T…”</span><br><span class="line">Intermediate directories are always “@” or “+” as appropriate.</span><br><span class="line"></span><br><span class="line">Each object in the cache has an extended attribute label that holds the object type ID (required to distinguish special objects) and the auxiliary data from the netfs. The latter is used to detect stale objects in the cache and update or retire them.</span><br><span class="line"></span><br><span class="line">Note that CacheFiles will erase from the cache any file it doesn’t recognise or any file of an incorrect type (such as a FIFO file or a device file).</span><br></pre></td></tr></table></figure>

<h2 id="转载的阅读摘要"><a href="#转载的阅读摘要" class="headerlink" title="转载的阅读摘要"></a>转载的阅读摘要</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install cachefilesd; </span><br><span class="line"></span><br><span class="line">挂载命令：直接mount服务端共享的目录到本地的&#x2F;mnt目录，必须使用-o fsc参数选项;</span><br><span class="line"></span><br><span class="line">All access to files under &#x2F;mount&#x2F;point will go through the cache, unless the file is opened for direct I&#x2F;O or writing; </span><br><span class="line"></span><br><span class="line">Opening a file from a shared file system for direct I&#x2F;O automatically bypasses the cache. This is because this type of access must be direct to the server.</span><br><span class="line"></span><br><span class="line">To avoid coherency management problems between superblocks, all NFS superblocks that wish to cache data have unique Level 2 keys. Normally, two NFS mounts with same source volume and options share a superblock, and thus share the caching, even if they mount different directories within that volume.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Opening a file from a shared file system for writing will not work on NFS version 2 and 3.  因为没有足够的维持并发写的一致性信息；</span><br><span class="line"></span><br><span class="line">Furthermore, this release of FS-Cache only caches regular NFS files. FS-Cache will not cache directories, symlinks, device files, FIFOs and sockets. 其只对文件数据进行cache的操作。</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-1404859281731123"
     data-ad-slot="6219253750"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/02/07/NFS-%E7%A1%AC%E6%8C%82%E8%BD%BD%E5%92%8C%E8%BD%AF%E6%8C%82%E8%BD%BD/" rel="next" title="NFS 硬挂载和软挂载">
                <i class="fa fa-chevron-left"></i> NFS 硬挂载和软挂载
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/03/01/GPUDirect-Technologies/" rel="prev" title="GPUDirect Technologies">
                GPUDirect Technologies <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">78</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:wangdk789@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#FS-Cache"><span class="nav-number">1.</span> <span class="nav-text">FS Cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel-内部的Cache-管理"><span class="nav-number">2.</span> <span class="nav-text">Kernel 内部的Cache 管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象管理状态机"><span class="nav-number">3.</span> <span class="nav-text">对象管理状态机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Provision-of-CPU-Time"><span class="nav-number">4.</span> <span class="nav-text">Provision of CPU Time</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Locking-Simplification"><span class="nav-number">5.</span> <span class="nav-text">Locking Simplification</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态集合"><span class="nav-number">6.</span> <span class="nav-text">状态集合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CacheFiles介绍"><span class="nav-number">7.</span> <span class="nav-text">CacheFiles介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Requiremenets"><span class="nav-number">8.</span> <span class="nav-text">Requiremenets</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">9.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动服务"><span class="nav-number">10.</span> <span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存剔除"><span class="nav-number">11.</span> <span class="nav-text">缓存剔除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存结构"><span class="nav-number">12.</span> <span class="nav-text">缓存结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#转载的阅读摘要"><span class="nav-number">13.</span> <span class="nav-text">转载的阅读摘要</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DavidStack</span>

  <!-- <div class="beian">
  </div> -->
 
  <div class="BbeiAn-info">
    鲁ICP备 -
    <a target="_blank"  href="https://beian.miit.gov.cn">16023683号-1</a>
  </div>


  
</div>









        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>

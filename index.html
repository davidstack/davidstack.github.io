<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"damonyi.cc","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="雾里云里">
<meta property="og:type" content="website">
<meta property="og:title" content="云里雾里">
<meta property="og:url" content="http://damonyi.cc/index.html">
<meta property="og:site_name" content="云里雾里">
<meta property="og:description" content="雾里云里">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://damonyi.cc/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<title>云里雾里</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">云里雾里</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">雾里云里</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/12/05/%E8%B0%88%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/05/%E8%B0%88%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F/" class="post-title-link" itemprop="url">谈云计算与云原生</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-12-05 08:40:08 / 修改时间：21:16:41" itemprop="dateCreated datePublished" datetime="2020-12-05T08:40:08+08:00">2020-12-05</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="云计算中的IAAS-PAAS-SAAS"><a href="#云计算中的IAAS-PAAS-SAAS" class="headerlink" title="云计算中的IAAS/PAAS/SAAS"></a>云计算中的IAAS/PAAS/SAAS</h2><p>云计算的概念提出者是IBM，但是IBM并没有很好的落地的产品，对于在线图书商店AWS，却有可以落地的场景，买了大量服务器，但是在图书销售淡季，造成了资源的浪费，因此逐渐有了目前云计算的领导者AWS，对于云计算相关工作者来说，我们<br>对AWS最深的印象时公有云NO.1，尝尝会忽略人家盈利最多的在线商城。</p>
<p>云计算刚提出的时候是提出了三个层次，即IAAS、PAAS、SAAS，这三个层次我们可以认为是云计算能力不同范围的概括，如下图所示：</p>
<p><img src="/2020/12/05/%E8%B0%88%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F/cloud1.png" alt="avatar"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/12/05/%E8%B0%88%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/12/01/Linux%E7%9A%84tempfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/01/Linux%E7%9A%84tempfs/" class="post-title-link" itemprop="url">Linux的tempfs</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-01 08:23:56" itemprop="dateCreated datePublished" datetime="2020-12-01T08:23:56+08:00">2020-12-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-12-05 11:03:47" itemprop="dateModified" datetime="2020-12-05T11:03:47+08:00">2020-12-05</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>807</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>###tempfs简介</p>
<ol>
<li><p>tmpfs 是 Linux/Unix 系统上的一种基于内存的文件系统，即 tmpfs 使用内存或 swap 分区来存储文件。Linux 内核中的 VM 子系统负责在后台管理虚拟内存资源 Virtual Memory，即 RAM 和 swap 资源，透明地将 RAM 页移动到交换分区或从交换分区到 RAM 页，tmpfs 文件系统需要 VM 子系统的页面来存储文件。tmpfs 自己并不知道这些页面是在交换分区还是在 RAM 中；做这种决定是 VM 子系统的工作。tmpfs 文件系统所知道的就是它正在使用某种形式的虚拟内存。</p>
</li>
<li><p>由于 tmpfs 是基于内存的，因此速度是相当快的。另外 tmpfs 使用的 VM 资源是动态的，当删除 tmpfs 中文件，tmpfs 文件系统驱动程序会动态地减小文件系统并释放 VM 资源，当然在其中创建文件时也会动态的分配VM资源。另外，tmpfs 不具备持久性，重启后数据不保留。</p>
</li>
</ol>
<p>在Linux主机上，查看常用tempfs的目录如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# df -h</span><br><span class="line">Filesystem                  Size  Used Avail Use% Mounted on</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root     442G   78G  364G  18% &#x2F;</span><br><span class="line">devtmpfs                     94G     0   94G   0% &#x2F;dev</span><br><span class="line">tmpfs                        94G     0   94G   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                        94G  1.2G   93G   2% &#x2F;run</span><br><span class="line">tmpfs                        94G     0   94G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br></pre></td></tr></table></figure>
<p>1.其中/run 目录主要存放的是自系统启动以来描述系统信息的文件。比较常见的用途是 daemon 进程将自己的 pid 保存到这个目录。</p>
<p>2./dev/shm/ 是 Linux 下一个非常有用的目录，它的意思是 Shared memory，也就是共享内存。由于它在内存上，所以所有系统进程都能共享该目录。默认情况下它的大小是内存的一半</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/11/17/kubernetes-apps%E5%88%A0%E9%99%A4%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/17/kubernetes-apps%E5%88%A0%E9%99%A4%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">kubernetes apps删除流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-17 09:52:08" itemprop="dateCreated datePublished" datetime="2020-11-17T09:52:08+08:00">2020-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-19 09:51:52" itemprop="dateModified" datetime="2020-11-19T09:51:52+08:00">2020-11-19</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>13 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>##问题描述<br>最近遇到了好几个Kubernetes集群出现了删除Statefulset时，Pod未被删除的问题，经过定位是开发同事，基于farbric 的k8s api进行删除statefulset的操作<br>，调用了删除statefulset的接口后，又调用了删除pod的接口，但是都是使用的默认删除方式，非级联删除（Orphan策略），这在某些情况下，可能只是调用了删除statefulset的接口，但是未调用删除Pod的接口，就会<br>出现Pod未被删除的，此时Pod的metadat内可能仍然存在，但是kube-controller-manager中的garbargecollector会将该Pode的ownerreference移除，但是label中仍然带有controller-revision-hash和statefulset的信息，如下图所示<br><img src="/2020/11/17/kubernetes-apps%E5%88%A0%E9%99%A4%E6%B5%81%E7%A8%8B/pod1.png" alt="avatar"></p>
<p>对于正常的属于Statefulset的Pod标识如下所示：</p>
<p><img src="/2020/11/17/kubernetes-apps%E5%88%A0%E9%99%A4%E6%B5%81%E7%A8%8B/pod2.png" alt="avatar"></p>
<p>借此机会对Statefulset删除的源码进行了分析，原以为是由Statefulset-controller 进行控制，但是看了一下代码，发现Statefulset-controller只是用来控制副本数的变化，但是对于Statefulset的删除，并不做任何处理，statefulset-controller的如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; If the StatefulSet is being deleted, don&#39;t do anything other than updating</span><br><span class="line">&#x2F;&#x2F; status.</span><br><span class="line">if set.DeletionTimestamp !&#x3D; nil &#123;</span><br><span class="line">	return &amp;status, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##Kubernetes资源删除的方式<br>Kubernetes 在删除资源时，存在级联删除和非级联删除<br>###控制垃圾收集器删除 Dependent<br>####级联删除<br>当删除对象时，可以指定是否该对象的 Dependent 也自动删除掉。自动删除 Dependent 也称为级联删除。Kubernetes 中有两种级联删除的模式：background 模式和 foreground 模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete statefulset  -n de2ca8d1-94b4-4faa-8077-e9374ca9db4e 5bagk2rivkjno --cascade&#x3D;true </span><br></pre></td></tr></table></figure>
<blockquote>
<p>Background 级联删除,在 background 级联删除 模式下，Kubernetes 会立即删除 Owner 对象，然后垃圾收集器会在后台删除这些 Dependent。<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   curl -X DELETE 127.0.0.1:8080&#x2F;apis&#x2F;extensions&#x2F;v1beta1&#x2F;namespaces&#x2F;default&#x2F;replicasets&#x2F;my-repset \</span><br><span class="line">-d &#39;&#123;&quot;kind&quot;:&quot;DeleteOptions&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;propagationPolicy&quot;:&quot;Background&quot;&#125;&#39; \</span><br><span class="line">-H &quot;Content-Type: application&#x2F;json&quot;</span><br></pre></td></tr></table></figure><br>Foreground 级联删除m在 foreground 级联删除 模式下，根对象首先进入 “删除中” 状态。该对象会设置deletionTimestamp 字段对象的 metadata.finalizers 字段包含了值 “foregroundDeletion”，对象仍然可以通过 REST API 可见，一旦被设置为 “删除中” 状态，垃圾收集器会删除对象的所有 Dependent。垃圾收集器删除了所有 “Blocking” 的 Dependent（对象的 ownerReference.blockOwnerDeletion=true）之后，它会删除 Owner 对象。<br>如果一个对象的ownerReferences 字段被一个 Controller（例如 Deployment 或 ReplicaSet）设置，blockOwnerDeletion 会被自动设置，没必要手动修改这个字段。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE localhost:8080&#x2F;apis&#x2F;extensions&#x2F;v1beta1&#x2F;namespaces&#x2F;default&#x2F;replicasets&#x2F;my-repset \</span><br><span class="line">-d &#39;&#123;&quot;kind&quot;:&quot;DeleteOptions&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;propagationPolicy&quot;:&quot;Foreground&quot;&#125;&#39; \</span><br><span class="line">-H &quot;Content-Type: application&#x2F;json&quot;</span><br></pre></td></tr></table></figure>

<p>####非级联删除<br>如果删除对象时，不自动删除它的 Dependent，这些 Dependent 被称作是原对象的 孤儿(Orphan),可以使用以下命令实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete statefulset  -n de2ca8d1-94b4-4faa-8077-e9374ca9db4e 5bagk2rivkjno --cascade&#x3D;false </span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE 127.0.0.1:8080&#x2F;apis&#x2F;extensions&#x2F;v1beta1&#x2F;namespaces&#x2F;default&#x2F;replicasets&#x2F;my-repset \</span><br><span class="line">-d &#39;&#123;&quot;kind&quot;:&quot;DeleteOptions&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;propagationPolicy&quot;:&quot;Orphan&quot;&#125;&#39; \</span><br><span class="line">-H &quot;Content-Type: application&#x2F;json&quot;</span><br></pre></td></tr></table></figure>
<p>##Kubernetes 删除apps流程分析<br>删除流程中几个重要的过程包括 kube-apiserver 提供的rest服务</p>
<ol>
<li><p>通过调用rest api实现etcd数据库中，app对象的状态更新，包括增加deletetimestamp和finalizer自带，触发更新事件</p>
</li>
<li><p>kube-controller-manager收到了apps状态的更新事件，通过更新内置的graph（集群内资源依赖附属关系的图）和garbagecollector进行资源极其附属的删除，这里是只在etcd数据库删除</p>
</li>
<li><p>kubelet收到第1步中的资源删除事件，进行底层资源的删除和回收</p>
</li>
</ol>
<p>###kube-apiserver<br>kube-apiserver在启动时会基于go-restful将rest服务的handler 进行加载，主要如下所示：<br>pkg/master/master.go</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; InstallAPIs will install the APIs for the restStorageProviders if they are enabled.</span><br><span class="line">func (m *Master) InstallAPIs(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter, restStorageProviders ...RESTStorageProvider) &#123;</span><br><span class="line">	apiGroupsInfo :&#x3D; []*genericapiserver.APIGroupInfo&#123;&#125;</span><br><span class="line"></span><br><span class="line">	for _, restStorageBuilder :&#x3D; range restStorageProviders &#123;</span><br><span class="line">		groupName :&#x3D; restStorageBuilder.GroupName()</span><br><span class="line">		if !apiResourceConfigSource.AnyVersionForGroupEnabled(groupName) &#123;</span><br><span class="line">			klog.V(1).Infof(&quot;Skipping disabled API group %q.&quot;, groupName)</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		apiGroupInfo, enabled :&#x3D; restStorageBuilder.NewRESTStorage(apiResourceConfigSource, restOptionsGetter)</span><br><span class="line">		if !enabled &#123;</span><br><span class="line">			klog.Warningf(&quot;Problem initializing API group %q, skipping.&quot;, groupName)</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		klog.V(1).Infof(&quot;Enabling API group %q.&quot;, groupName)</span><br><span class="line"></span><br><span class="line">		if postHookProvider, ok :&#x3D; restStorageBuilder.(genericapiserver.PostStartHookProvider); ok &#123;</span><br><span class="line">			name, hook, err :&#x3D; postHookProvider.PostStartHook()</span><br><span class="line">			if err !&#x3D; nil &#123;</span><br><span class="line">				klog.Fatalf(&quot;Error building PostStartHook: %v&quot;, err)</span><br><span class="line">			&#125;</span><br><span class="line">			m.GenericAPIServer.AddPostStartHookOrDie(name, hook)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		apiGroupsInfo &#x3D; append(apiGroupsInfo, &amp;apiGroupInfo)</span><br><span class="line">	&#125;</span><br><span class="line">    #集成API</span><br><span class="line">	if err :&#x3D; m.GenericAPIServer.InstallAPIGroups(apiGroupsInfo...); err !&#x3D; nil &#123;</span><br><span class="line">		klog.Fatalf(&quot;Error in registering group versions: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要的调用链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k8s.io&#x2F;apiserver&#x2F;pkg&#x2F;server&#x2F;genericapiserver.go:InstallAPIGroups()</span><br><span class="line">k8s.io&#x2F;apiserver&#x2F;pkg&#x2F;server&#x2F;genericapiserver.go:installAPIResources()</span><br><span class="line">k8s.io&#x2F;apiserver&#x2F;pkg&#x2F;endpoints&#x2F;groupversion.go:InstallREST()</span><br><span class="line">k8s.io&#x2F;apiserver&#x2F;pkg&#x2F;endpoints&#x2F;installer.go:Install()</span><br><span class="line">k8s.io&#x2F;apiserver&#x2F;pkg&#x2F;endpoints&#x2F;installer.go:registerResourceHandlers()</span><br></pre></td></tr></table></figure>
<p>rest注册的核心函数：将rest请求直接映射为etcd存储的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">staging&#x2F;src&#x2F;k8s.io&#x2F;apiserver&#x2F;pkg&#x2F;endpoints&#x2F;installer.go:183  registerResourceHandlers()</span><br></pre></td></tr></table></figure>
<p>删除的rest请求对应的处理请求在这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   .....</span><br><span class="line">actions &#x3D; appendIf(actions, action&#123;&quot;GET&quot;, itemPath, nameParams, namer, false&#125;, isGetter)</span><br><span class="line">	if getSubpath &#123;</span><br><span class="line">		actions &#x3D; appendIf(actions, action&#123;&quot;GET&quot;, itemPath + &quot;&#x2F;&#123;path:*&#125;&quot;, proxyParams, namer, false&#125;, isGetter)</span><br><span class="line">	&#125;</span><br><span class="line">	actions &#x3D; appendIf(actions, action&#123;&quot;PUT&quot;, itemPath, nameParams, namer, false&#125;, isUpdater)</span><br><span class="line">	actions &#x3D; appendIf(actions, action&#123;&quot;PATCH&quot;, itemPath, nameParams, namer, false&#125;, isPatcher)</span><br><span class="line">	#删除的处理函数</span><br><span class="line">	actions &#x3D; appendIf(actions, action&#123;&quot;DELETE&quot;, itemPath, nameParams, namer, false&#125;, isGracefulDeleter)</span><br><span class="line">	.....</span><br></pre></td></tr></table></figure>

<p>该接口的定义如下所示,即Delete函数可能直接删除数据，也可能异步删除资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; GracefulDeleter knows how to pass deletion options to allow delayed deletion of a</span><br><span class="line">&#x2F;&#x2F; RESTful object.</span><br><span class="line">type GracefulDeleter interface &#123;</span><br><span class="line">	&#x2F;&#x2F; Delete finds a resource in the storage and deletes it.</span><br><span class="line">	&#x2F;&#x2F; If options are provided, the resource will attempt to honor them or return an invalid</span><br><span class="line">	&#x2F;&#x2F; request error.</span><br><span class="line">	&#x2F;&#x2F; Although it can return an arbitrary error value, IsNotFound(err) is true for the</span><br><span class="line">	&#x2F;&#x2F; returned error value err when the specified resource is not found.</span><br><span class="line">	&#x2F;&#x2F; Delete *may* return the object that was deleted, or a status object indicating additional</span><br><span class="line">	&#x2F;&#x2F; information about deletion.</span><br><span class="line">	&#x2F;&#x2F; It also returns a boolean which is set to true if the resource was instantly</span><br><span class="line">	&#x2F;&#x2F; deleted or false if it will be deleted asynchronously.</span><br><span class="line">	Delete(ctx genericapirequest.Context, name string, options *metav1.DeleteOptions) (runtime.Object, bool, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个比较重要的Delete函数，用于在Delete之前做一些业务处理，就包括了我们前面重点提到的设置deletetimestamp 和finalizers字段，对于Statefulset特有的增删改查的预处理，代码都归档在了k8s.io\kubernetes\pkg\registry\apps\statefulset目录，但是对于通用的增删改查预处理操作<br>，代码被归档在了这里 k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/registry/rest/,其中通用的BeforeDelete归档在了staging/src/k8s.io/apiserver/pkg/registry/rest/delete.go:BeforeDelete()<br>其中核心的Delete函数 在staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go:Delete()，重点关注下面的代码段,设置删除策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">var preconditions storage.Preconditions</span><br><span class="line">if options.Preconditions !&#x3D; nil &#123;</span><br><span class="line">	preconditions.UID &#x3D; options.Preconditions.UID</span><br><span class="line">	preconditions.ResourceVersion &#x3D; options.Preconditions.ResourceVersion</span><br><span class="line">&#125;</span><br><span class="line">#调用BeforeDelete获取是否需要graceful 进行删除</span><br><span class="line">graceful, pendingGraceful, err :&#x3D; rest.BeforeDelete(e.DeleteStrategy, ctx, obj, options)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">	return nil, false, err</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#x2F;&#x2F; Handle combinations of graceful deletion and finalization by issuing</span><br><span class="line">&#x2F;&#x2F; the correct updates.</span><br><span class="line">#设置finalizer，为orphan或者foregroundDeletion策略</span><br><span class="line">shouldUpdateFinalizers, _ :&#x3D; deletionFinalizersForGarbageCollection(ctx, e, accessor, options)</span><br><span class="line">&#x2F;&#x2F; TODO: remove the check, because we support no-op updates now.</span><br><span class="line">if graceful || pendingFinalizers || shouldUpdateFinalizers &#123;</span><br><span class="line">    #在etcd数据库更新资源的metadata信息</span><br><span class="line">	err, ignoreNotFound, deleteImmediately, out, lastExisting &#x3D; e.updateForGracefulDeletionAndFinalizers(ctx, name, key, options, preconditions, obj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; !deleteImmediately covers all cases where err !&#x3D; nil. We keep both to be future-proof.</span><br><span class="line">if !deleteImmediately || err !&#x3D; nil &#123;</span><br><span class="line">	return out, false, err</span><br><span class="line">&#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>###kube-controller-manager<br>kube-controller-manager内有一个GarbageCollector用于完成资源的清理删除工作，启动的时候首先会运行一个dependencyGraphBuilder 用于构建集群资源的依赖关系图谱，这个graphbuild 会获取集群的全部资源，并根根据资源的metadata信息构建关系图谱<br>，并基于事件监听更新 关系图谱</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pkg&#x2F;controller&#x2F;garbagecollector&#x2F;graph_builder.go:startMonitors()</span><br><span class="line">func (gb *GraphBuilder) startMonitors() &#123;</span><br><span class="line">	gb.monitorLock.Lock()</span><br><span class="line">	defer gb.monitorLock.Unlock()</span><br><span class="line"></span><br><span class="line">	if !gb.running &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; we&#39;re waiting until after the informer start that happens once all the controllers are initialized.  This ensures</span><br><span class="line">	&#x2F;&#x2F; that they don&#39;t get unexpected events on their work queues.</span><br><span class="line">	&lt;-gb.informersStarted</span><br><span class="line">    </span><br><span class="line">    #定义需要为哪些资源建立关系图谱，每个都基于informer进行监听，对于garbargecollect 中的graph，只是获取哪些允许进行删除的资源pkg&#x2F;controller&#x2F;garbagecollector&#x2F;garbagecollector.go:GetDeletableResources() </span><br><span class="line">	monitors :&#x3D; gb.monitors</span><br><span class="line">	started :&#x3D; 0</span><br><span class="line">	for _, monitor :&#x3D; range monitors &#123;</span><br><span class="line">		if monitor.stopCh &#x3D;&#x3D; nil &#123;</span><br><span class="line">			monitor.stopCh &#x3D; make(chan struct&#123;&#125;)</span><br><span class="line">			gb.sharedInformers.Start(gb.stopCh)</span><br><span class="line">			go monitor.Run()</span><br><span class="line">			started++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<p>graph_build 中会处理收到的资源状态更新事件，将产生事件的对象放到缓存队列内，主要pkg/controller/garbagecollector/graph_builder.go:processGraphChanges()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Dequeueing an event from graphChanges, updating graph, populating dirty_queue.</span><br><span class="line">func (gb *GraphBuilder) processGraphChanges() bool &#123;</span><br><span class="line">	item, quit :&#x3D; gb.graphChanges.Get()</span><br><span class="line">	....</span><br><span class="line">	case (event.eventType &#x3D;&#x3D; addEvent || event.eventType &#x3D;&#x3D; updateEvent) &amp;&amp; found:</span><br><span class="line">		&#x2F;&#x2F; handle changes in ownerReferences</span><br><span class="line">		added, removed, changed :&#x3D; referencesDiffs(existingNode.owners, accessor.GetOwnerReferences())</span><br><span class="line">		if len(added) !&#x3D; 0 || len(removed) !&#x3D; 0 || len(changed) !&#x3D; 0 &#123;</span><br><span class="line">			&#x2F;&#x2F; check if the changed dependency graph unblock owners that are</span><br><span class="line">			&#x2F;&#x2F; waiting for the deletion of their dependents.</span><br><span class="line">			gb.addUnblockedOwnersToDeleteQueue(removed, changed)</span><br><span class="line">			&#x2F;&#x2F; update the node itself</span><br><span class="line">			existingNode.owners &#x3D; accessor.GetOwnerReferences()</span><br><span class="line">			&#x2F;&#x2F; Add the node to its new owners&#39; dependent lists.</span><br><span class="line">			gb.addDependentToOwners(existingNode, added)</span><br><span class="line">			&#x2F;&#x2F; remove the node from the dependent list of node that are no longer in</span><br><span class="line">			&#x2F;&#x2F; the node&#39;s owners list.</span><br><span class="line">			gb.removeDependentFromOwners(existingNode, removed)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if beingDeleted(accessor) &#123;</span><br><span class="line">			existingNode.markBeingDeleted()</span><br><span class="line">		&#125;</span><br><span class="line">		gb.processTransitions(event.oldObj, accessor, existingNode)</span><br><span class="line">	case event.eventType &#x3D;&#x3D; deleteEvent:</span><br><span class="line">		if !found &#123;</span><br><span class="line">			klog.V(5).Infof(&quot;%v doesn&#39;t exist in the graph, this shouldn&#39;t happen&quot;, accessor.GetUID())</span><br><span class="line">			return true</span><br><span class="line">		&#125;</span><br><span class="line">		&#x2F;&#x2F; removeNode updates the graph</span><br><span class="line">		gb.removeNode(existingNode)</span><br><span class="line">		existingNode.dependentsLock.RLock()</span><br><span class="line">		defer existingNode.dependentsLock.RUnlock()</span><br><span class="line">		if len(existingNode.dependents) &gt; 0 &#123;</span><br><span class="line">			gb.absentOwnerCache.Add(accessor.GetUID())</span><br><span class="line">		&#125;</span><br><span class="line">		for dep :&#x3D; range existingNode.dependents &#123;</span><br><span class="line">		     #将需要删除的资源加入到attemptToDelete队列</span><br><span class="line">			gb.attemptToDelete.Add(dep)</span><br><span class="line">		&#125;</span><br><span class="line">		for _, owner :&#x3D; range existingNode.owners &#123;</span><br><span class="line">			ownerNode, found :&#x3D; gb.uidToNode.Read(owner.UID)</span><br><span class="line">			if !found || !ownerNode.isDeletingDependents() &#123;</span><br><span class="line">				continue</span><br><span class="line">			&#125;</span><br><span class="line">			&#x2F;&#x2F; this is to let attempToDeleteItem check if all the owner&#39;s</span><br><span class="line">			&#x2F;&#x2F; dependents are deleted, if so, the owner will be deleted.</span><br><span class="line">			#将需要删除的资源加入到attemptToDelete队列</span><br><span class="line">			gb.attemptToDelete.Add(ownerNode)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pkg/controller/garbagecollector/garbagecollector.go:attemptToDeleteWorker() 处理每个删除对象的事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">func (gc *GarbageCollector) attemptToDeleteItem(item *node) error &#123;</span><br><span class="line">....</span><br><span class="line">   #在这里出进行处理，当发现需要删除Statefulset时，先判断是否需要进行删除该Statefulset的附属资源，先进行附属资源的删除</span><br><span class="line">	&#x2F;&#x2F; attemptToOrphanWorker() into attemptToDeleteItem() as well.</span><br><span class="line">	if item.isDeletingDependents() &#123;</span><br><span class="line">		return gc.processDeletingDependentsItem(item)</span><br><span class="line">	&#125;</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">		switch &#123;</span><br><span class="line">		case hasOrphanFinalizer(latest):</span><br><span class="line">			&#x2F;&#x2F; if an existing orphan finalizer is already on the object, honor it.</span><br><span class="line">			policy &#x3D; metav1.DeletePropagationOrphan</span><br><span class="line">		case hasDeleteDependentsFinalizer(latest):</span><br><span class="line">			&#x2F;&#x2F; if an existing foreground finalizer is already on the object, honor it.</span><br><span class="line">			policy &#x3D; metav1.DeletePropagationForeground</span><br><span class="line">		default:</span><br><span class="line">			&#x2F;&#x2F; otherwise, default to background.</span><br><span class="line">			policy &#x3D; metav1.DeletePropagationBackground</span><br><span class="line">		&#125;</span><br><span class="line">		#这里会将Statefulset的POd 在数据库中直接删除</span><br><span class="line">		klog.V(2).Infof(&quot;delete object %s with propagation policy %s&quot;, item.identity, policy)</span><br><span class="line">		return gc.deleteObject(item.identity, &amp;policy)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#完成附属资源的删除</span><br><span class="line">&#x2F;&#x2F; process item that&#39;s waiting for its dependents to be deleted</span><br><span class="line">func (gc *GarbageCollector) processDeletingDependentsItem(item *node) error &#123;</span><br><span class="line">	blockingDependents :&#x3D; item.blockingDependents()</span><br><span class="line">	if len(blockingDependents) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">		klog.V(2).Infof(&quot;remove DeleteDependents finalizer for item %s&quot;, item.identity)</span><br><span class="line">		#在etcd内移除pod的finakuzed字段，会同时将该资源在数据库删除</span><br><span class="line">		return gc.removeFinalizer(item, metav1.FinalizerDeleteDependents)</span><br><span class="line">	&#125;</span><br><span class="line">	for _, dep :&#x3D; range blockingDependents &#123;</span><br><span class="line">		if !dep.isDeletingDependents() &#123;</span><br><span class="line">			klog.V(2).Infof(&quot;adding %s to attemptToDelete, because its owner %s is deletingDependents&quot;, dep.identity, item.identity)</span><br><span class="line">			gc.attemptToDelete.Add(dep)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##kubelet<br>kubelet主要完成资源的释放,主要的删除Pod的处理逻辑，在kubelet的主函数syncpod中，当发现是删除pod的事件时，立即处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">func (kl *Kubelet) syncPod(o syncPodOptions) error &#123;</span><br><span class="line">	&#x2F;&#x2F; pull out the required options</span><br><span class="line">	pod :&#x3D; o.pod</span><br><span class="line">	mirrorPod :&#x3D; o.mirrorPod</span><br><span class="line">	podStatus :&#x3D; o.podStatus</span><br><span class="line">	updateType :&#x3D; o.updateType</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; if we want to kill a pod, do it now!</span><br><span class="line">	if updateType &#x3D;&#x3D; kubetypes.SyncPodKill &#123;</span><br><span class="line">		killPodOptions :&#x3D; o.killPodOptions</span><br><span class="line">		if killPodOptions &#x3D;&#x3D; nil || killPodOptions.PodStatusFunc &#x3D;&#x3D; nil &#123;</span><br><span class="line">			return fmt.Errorf(&quot;kill pod options are required if update type is kill&quot;)</span><br><span class="line">		&#125;</span><br><span class="line">		apiPodStatus :&#x3D; killPodOptions.PodStatusFunc(pod, podStatus)</span><br><span class="line">		kl.statusManager.SetPodStatus(pod, apiPodStatus)</span><br><span class="line">		&#x2F;&#x2F; we kill the pod with the specified grace period since this is a termination</span><br><span class="line">		if err :&#x3D; kl.killPod(pod, nil, podStatus, killPodOptions.PodTerminationGracePeriodSecondsOverride); err !&#x3D; nil &#123;</span><br><span class="line">			kl.recorder.Eventf(pod, v1.EventTypeWarning, events.FailedToKillPod, &quot;error killing pod: %v&quot;, err)</span><br><span class="line">			&#x2F;&#x2F; there was an error killing the pod, so we return that error directly</span><br><span class="line">			utilruntime.HandleError(err)</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/11/11/ngc-cuda11%E9%95%9C%E5%83%8F%E8%BF%90%E8%A1%8Cmpi%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/11/ngc-cuda11%E9%95%9C%E5%83%8F%E8%BF%90%E8%A1%8Cmpi%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">ngc cuda11镜像运行mpi任务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-11-11 11:27:03 / 修改时间：11:31:00" itemprop="dateCreated datePublished" datetime="2020-11-11T11:27:03+08:00">2020-11-11</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>285</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ngc官网的cuda 11镜像如果运行MPI任务，以太网使用以下命令提交训练任务，否则会出现以下错误</p>
<p> <img src="/2020/11/11/ngc-cuda11%E9%95%9C%E5%83%8F%E8%BF%90%E8%A1%8Cmpi%E4%BB%BB%E5%8A%A1/ucxerror.png" alt="avatar"><br>这是由于镜像内置了ucx 组件，需要IB的支持，如果没有IB的话，会报错，建议使用一下命令运行mpi任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun --oversubscribe --allow-run-as-root -np 2 -mca pml ob1  python &#x2F;inspur&#x2F;models&#x2F;horovod&#x2F;tensorflow_mnist.py  --data_dir&#x3D;&#x2F;MNIST_data</span><br></pre></td></tr></table></figure>
<p>mpi这块积累不多，只记录这个错误了，后续深入后，再详细研究</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/10/10/GPU-%E7%9B%B8%E5%85%B3%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/10/10/GPU-%E7%9B%B8%E5%85%B3%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">GPU 相关的基础知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-10 14:19:59" itemprop="dateCreated datePublished" datetime="2020-10-10T14:19:59+08:00">2020-10-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-11 11:31:00" itemprop="dateModified" datetime="2020-11-11T11:31:00+08:00">2020-11-11</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>691</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>整理了认为了解GPU，比较重要的几个概念<br>###CPU与GPU的区别<br>CPU需要很强的通用性来处理各种不同的数据类型，还需要进行多种逻辑判断，引入大量的分支跳转和中断处理。GPU面对的则是类型高度统一的、相互无依赖的大规模数据和不需要被打断的纯净的计算环境，如<br>下图所示（绿色的是计算单元，橙红色的是存储单元，橙黄色的是控制单元），与CPU擅长逻辑控制、串行的运算、通用类型数据运算不同，GPU擅长的是大规模并发计算，GPU的工作部分计算量大，但没有什么技术含量,<br>而且需要重复很多次。CPU与GPU相比就类似 教授和小学生，教授积分微分都会算，小学生只会算加减乘除。唯一的限制是，运行在GPU的计算任务可以拆分为多个相同的简单小任务，而且是相互独立的。现在的GPU也能做一些<br>稍微复制的工作，相当于升级成初中生高中生的水平，但是还需要CPU配合才可以，终究还是需要靠GPU来管理。</p>
<p> GPU上适合运行计算密集型的程序和易于并行的程序</p>
<p><img src="/2020/10/10/GPU-%E7%9B%B8%E5%85%B3%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/cpugpu.jpg" alt="avatar"></p>
<p>###SP SM Thread Block grid warp<br>SP(streaming processor):最基本的处理单元，最终的指令和任务都是在SP上执行，GPU的并行计算，即多个SP同时做处理，一个SP 对应一个thread<br>warp：SM调度和执行的基础概念，同时也是一个硬件概念，一个SM中的SP会分成几个warp（SM中的SP进行分组）<br>SM（streaming multiprocessor）:多个SP加上一些其他资源组成SM，其他资源包括存储资源、共享内存、寄存器</p>
<p>###GPU Memory</p>
<p>###GPU P2P</p>
<p>###RDMA</p>
<p>###CUDA</p>
<p>###NVLINK</p>
<p>###NCCL</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/10/06/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/10/06/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-06 17:50:58" itemprop="dateCreated datePublished" datetime="2020-10-06T17:50:58+08:00">2020-10-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-09-11 19:16:06" itemprop="dateModified" datetime="2020-09-11T19:16:06+08:00">2020-09-11</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>367</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/com-sun-image-codec-jpeg-does-not-exist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/com-sun-image-codec-jpeg-does-not-exist/" class="post-title-link" itemprop="url">com.sun.image.codec.jpeg does not exist</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:56:50 / 修改时间：20:02:22" itemprop="dateCreated datePublished" datetime="2020-09-21T19:56:50+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>一个项目在windows下执行mvn package正常，但是放在Linux环境下，会出现找不到com.sun.image.codec的问题，如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] COMPILATION ERROR : </span><br><span class="line">[INFO] -------------------------------------------------------------</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController2.java:[24,40] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController2.java:[25,40] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController.java:[25,32] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController.java:[26,32] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[INFO] 4 errors </span><br><span class="line">[INFO] -------------------------------------------------------------</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Reactor Summary:</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] ztzx 1.0.0 ......................................... SUCCESS [  0.007 s]</span><br><span class="line">[INFO] ztzx.service ....................................... FAILURE [02:11 min]</span><br><span class="line">[INFO] ztzx.web 1.0.0 ..................................... SKIPPED</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 02:11 min</span><br><span class="line">[INFO] Finished at: 2018-08-06T01:51:45Z</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.1:compile (default-compile) on project ztzx.service: Compilation failure: Compilation failure: </span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController2.java:[24,40] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController2.java:[25,40] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController.java:[25,32] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] &#x2F;home&#x2F;ztzx&#x2F;ztzx.service&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;telchina&#x2F;ztzx&#x2F;common&#x2F;controller&#x2F;UploadController.java:[26,32] package com.sun.image.codec.jpeg does not exist</span><br><span class="line">[ERROR] -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http:&#x2F;&#x2F;cwiki.apache.org&#x2F;confluence&#x2F;display&#x2F;MAVEN&#x2F;MojoFailureException</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] After correcting the problems, you can resume the build with the command</span><br><span class="line">[ERROR]   mvn &lt;goals&gt; -rf :ztzx.service </span><br></pre></td></tr></table></figure>

<h3 id="分析一"><a href="#分析一" class="headerlink" title="分析一"></a>分析一</h3><p>按照Java官方的解释,sun.image.codec这个package已经被deprecated，建议不要使用，看官方的解释： Why Developers Should Not Write Programs That Call ‘sun’ Packages The java.*, javax.* and org.* packages documented in the Java Platform Standard Edition API Specification make up the official, supported, public interface. If a Java program directly calls only API in these packages, it will operate on all Java-compatible platforms, regardless of the underlying OS platform. The sun.* packages are not part of the supported, public interface. A Java program that directly calls into sun.* packages is not guaranteed to work on all Java-compatible platforms. In fact, such a program is not guaranteed to work even in future versions on the same platform. Each company that implements the Java platform will do so in their own private way. The classes in sun.* are present in the JDK to support Oracle’s implementation of the Java platform: the sun.* classes are what make the Java platform classes work “under the covers” for Oracle’s JDK. These classes will not in general be present on another vendor’s Java platform. If your Java program asks for a class “sun.package.Foo” by name, it may fail with ClassNotFoundError, and you will have lost a major advantage of developing in Java. Technically, nothing prevents your program from calling into sun.* by name. From one release to another, these classes may be removed, or they may be moved from one package to another, and it’s fairly likely that their interface (method names and signatures) will change. (From Oracle’s point of view, since we are committed to maintaining the Java platform, we need to be able to change sun.* to refine and enhance the platform.) In this case, even if you are willing to run only on Oracle’s implementation, you run the risk of a new version of the implementation breaking your program. In general, writing java programs that rely on sun.* is risky: those classes are not portable, and are not supported<br>可以这样理解，Java已经被Oracle收购多年，里面再去出现sun的package算怎么回事。。O(∩_∩)O哈哈~，当然你还是可以去使用的，可以在pom.xml 经配置了下面的参数，排除无法引入jar包的问题，这个方法并不能解决我在Linux无法进行构建的的问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">                   &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">                   &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">                   &lt;version&gt;3.1&lt;&#x2F;version&gt;</span><br><span class="line">                   &lt;configuration&gt;</span><br><span class="line">                       &lt;source&gt;$&#123;jdkVersion&#125;&lt;&#x2F;source&gt;</span><br><span class="line">                       &lt;target&gt;$&#123;jdkVersion&#125;&lt;&#x2F;target&gt;</span><br><span class="line">                       &lt;compilerArguments&gt;</span><br><span class="line">                           &lt;verbose &#x2F;&gt;</span><br><span class="line">                           &lt;bootclasspath&gt;$&#123;JAVA_HOME&#125;&#x2F;jre&#x2F;lib&#x2F;rt.jar$&#123;path.separator&#125;$&#123;JAVA_HOME&#125;&#x2F;jre&#x2F;lib&#x2F;jce.jar&lt;&#x2F;bootclasspath&gt;</span><br><span class="line">                       &lt;&#x2F;compilerArguments&gt;</span><br><span class="line">                   &lt;&#x2F;configuration&gt;</span><br><span class="line">               &lt;&#x2F;plugin&gt; </span><br></pre></td></tr></table></figure>

<h3 id="分析二"><a href="#分析二" class="headerlink" title="分析二"></a>分析二</h3><p>查看mvn仓库信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@30e8e1cd5962:&#x2F;home&#x2F;ztzx# mvn -version</span><br><span class="line">Apache Maven 3.5.3 (3383c37e1f9e9b3bc3df5050c29c8aff9f295297; 2018-02-24T19:49:05Z)</span><br><span class="line">Maven home: &#x2F;usr&#x2F;share&#x2F;maven</span><br><span class="line">Java version: 1.8.0_91, vendor: Oracle Corporation</span><br><span class="line">Java home: &#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-8-openjdk-amd64&#x2F;jre</span><br><span class="line">Default locale: en, platform encoding: UTF-8</span><br><span class="line">OS name: &quot;linux&quot;, version: &quot;3.10.0-693.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot; </span><br><span class="line">&#96;&#96;&#96;查看Java 信息&#96;&#96;&#96;</span><br><span class="line">root@30e8e1cd5962:&#x2F;home&#x2F;ztzx# java -version</span><br><span class="line">openjdk version &quot;1.8.0_91&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_91-8u91-b14-1~bpo8+1-b14)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.91-b14, mixed mode) </span><br></pre></td></tr></table></figure>
<p>与windows的运行环境相比，出Java的小版本不同外，还有一个区别，就是Oracle Java与OpenJdk的区别，google资料，发现OpenJdk已经在1.7版本移除了该package。<a target="_blank" rel="noopener" href="http://jira.icesoft.org/browse/PDF-332?jql=project%20=%20PDF%20AND%20fixVersion%20=%205.1%20ORDER%20BY%20updated%20DESC,%20priority%20DESC,%20created%20ASC">OpenJdk移除jepg的package</a>，将Linux 默认的OpenJdk替换为Oracle的Jdk，即可以解决问题</p>
<h3 id="其他解决方法"><a href="#其他解决方法" class="headerlink" title="其他解决方法"></a>其他解决方法</h3><p>JPEGImageEncoder类是SUN公司私有类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">一般出现在这样的代码段中：</span><br><span class="line">    FileOutputStream out &#x3D; new FileOutputStream(dstName);</span><br><span class="line">     JPEGImageEncoder encoder &#x3D; JPEGCodec.createJPEGEncoder(out);</span><br><span class="line">     encoder.encode(dstImage);</span><br><span class="line"></span><br><span class="line">改写成：</span><br><span class="line"></span><br><span class="line">    String formatName &#x3D; dstName.substring(dstName.lastIndexOf(&quot;.&quot;) + 1);</span><br><span class="line">     &#x2F;&#x2F;FileOutputStream out &#x3D; new FileOutputStream(dstName);</span><br><span class="line">     &#x2F;&#x2F;JPEGImageEncoder encoder &#x3D; JPEGCodec.createJPEGEncoder(out);</span><br><span class="line">     &#x2F;&#x2F;encoder.encode(dstImage);</span><br><span class="line">     ImageIO.write(dstImage, &#x2F;*&quot;GIF&quot;*&#x2F; formatName &#x2F;* format desired *&#x2F; , new File(dstName) &#x2F;* target *&#x2F; ); </span><br></pre></td></tr></table></figure>
<p>都使用统一的ImageIO进行图像格式文件的读写，没有必要使用过时的实现类JPEGImageEncoder类。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">DevOps 理解整理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:54:28 / 修改时间：19:59:12" itemprop="dateCreated datePublished" datetime="2020-09-21T19:54:28+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="传统的软件开发流程"><a href="#传统的软件开发流程" class="headerlink" title="传统的软件开发流程"></a>传统的软件开发流程</h1><p><img src="/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/uploads/image/20170922/1506070794227148.png" alt="image.png" title="1506070794227148.png"></p>
<p>  存在的问题：</p>
<p>1、 资源获取和环境准备效率低，缺少标准化化、自主的化的服务能力</p>
<p>2、 从代码开发到环境运行的流程不顺畅，开发人员不清楚最终的软件会如何部署和运行，测试人员不了解软件测试的重点和风险点在什么地方，运维人员不清楚软件架构的高可用设计是如何实现的，部门之间基本靠非常零碎、极易过时的文档或者口头沟通来交换信息</p>
<p>在产品研发的起始阶段，忙于需求分析、架构设计、代码实现，以上两个问题被大多数人认为比较容易处理。等到快上线的时候，出现上线失败或者临时方案上线</p>
<h1 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h1><p>DevOps理念： 提倡开发、测试、IT运维之间的高度协同，从而完成高频率部署的同时，提高生产环境的可靠性、稳定性、弹性、安全性</p>
<p>开发与IT运维：产品的价值在于业务（定义需求）和客户（交付价值）之间</p>
<p>DevOPs本身不能完全被工具和软件来简单的定义和量化，但工具和软件是实现DevOps的一个重要组成部分 </p>
<p>解决的问题：</p>
<p>1、 一些关于产品改善和创新的想法很难落地，设计到一些遗留系统的配合：调整、部署、扩展。新的服务或者应用构建、很难快速上线，被卡在了生产环境部署阶段</p>
<p>2、 不同种类的应用、服务的部署方式和流程不一致，运维团队很难为大量不同技术栈的团队提供快速响应。</p>
<p>3、 微服务的兴起，交付团队难以做到快速集成和部署。运维团队对微服务的部署方式不理解，不能适配新架构下的交付模式，开发团队大多关注代码和架构，对于产品如何在能在生产环境稳定运行、需要考虑哪些安全性和可持续性的因素并不是很了解。开发阶段，系统的架构和依赖环境都是开发者决定，对生产环境的关注度不高。部署、发布阶段，运维人员会考虑如何构建一套稳定的基础设施，又如何去部署和运维开发的产品。</p>
<h2 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h2><p>持续集成是一种软件项目管理方法，依据资产库（源码、类库）等的变更自动完成编译、测试、部署和反馈。持续集成已经广泛用于现代软件开发流程中，能够带来的好处：快速发现错误和促进代码分支的集成。</p>
<p>带来的价值：</p>
<p>   1、提高软件质量：每天或者每周进行多次集成，并进行测试，有利于发现软件缺陷，最终提高软件质量</p>
<p>   2、减少重复劳动：自动化工具编译代码、打包、上传、部署、测试，无需太多人工干预，让开发者更多精力专注于软件逻辑实现</p>
<p>   3、增强项目的预见性：每次操作会记录详细的输入输出结果，为后续产品缺陷是否收敛提供数据支撑。通过这些数据分析增加项目的预见性。</p>
<p>  4、增强团队对产品的信息</p>
<p>如何做到产品的持续集成</p>
<p>1、 统一代码库</p>
<p>2、 自动构建工具</p>
<p>3、 自动测试脚本</p>
<p>4、 开发向代码库主干提交代码</p>
<p>5、 自动触发构建工具</p>
<p>6、 高速构建服务器、快速完成构建作业</p>
<p>7、 上传软件到测试环境触发自动测试脚本</p>
<p>8、 执行结果分析与展示</p>
<p>9、 自动部署到演练环境</p>
<p><img src="/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/uploads/image/20170922/1506070830595640.png" alt="image.png" title="1506070830595640.png"></p>
<p>                                                                                                  持续集成流程</p>
<h2 id="持续交付"><a href="#持续交付" class="headerlink" title="持续交付"></a>持续交付</h2><p>持续交付是指周期性地将新版本软件交给质量运营团队或者用户，测试与评审。如果代码通过评审，代码进入生产阶段，持续交付的核心是不管有多少更新，软件始终可以交付价值</p>
<p>1、 快速发布产品特性：缩短编码、测试、上线、交付的迭代周期，使每个步骤出现的问题得到快速响应，在产品上的体现就是缩短软件功能发布周期，从而可以更好的应对业务需求的变化</p>
<p>2、 高质量的软件发布标准：软件交付过程实现标准化，整个交付过程可重复，过程进度可视化</p>
<p>3、 提供团队协作效率</p>
<p><img src="/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/uploads/image/20170922/1506070853309847.png" alt="image.png" title="1506070853309847.png"></p>
<p>                                                                                               持续交付流程</p>
<h2 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h2><p>1、负载均衡</p>
<p>2、升级回滚</p>
<p>灰度发布本质是选取部分用户或者区域发布产品新特性。A/B测试安一定的策略选定一部分用户继续用A，而另一部分用户开始用B，产品可以通过使用B的用户反馈决策是否扩大发布范围，最终达到产品新特性向所有用户全量发布</p>
<h2 id="应用编排"><a href="#应用编排" class="headerlink" title="应用编排"></a>应用编排</h2><p>应用通常有多个组件或者模块，基于Kubernetes 部署应用</p>
<h2 id="DevOps流水线"><a href="#DevOps流水线" class="headerlink" title="DevOps流水线"></a>DevOps流水线</h2><p> <img src="/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/1506070880431917.png" alt="avatar"><br>  <img src="/2020/09/21/DevOps-%E7%90%86%E8%A7%A3%E6%95%B4%E7%90%86/1506070894349245.png" alt="avatar"></p>
<h2 id="DevOps与Kubernetes"><a href="#DevOps与Kubernetes" class="headerlink" title="DevOps与Kubernetes"></a>DevOps与Kubernetes</h2><h3 id="Kubernetes对DevOps的影响"><a href="#Kubernetes对DevOps的影响" class="headerlink" title="Kubernetes对DevOps的影响"></a>Kubernetes对DevOps的影响</h3><p>DevOps并不是一个新概念，前期是没有好的工具来辅助DevOps的发展，虚拟机、IAAS管理不能解决应用管理的多样化需求。</p>
<p>应用管理的需求：</p>
<p>1、 应用运行环境、应用版本功能的不确定性，导致运维需要适配不同的运行环境，定制多种应用编译部署脚本，容器的出现解决了这个问题</p>
<p>2、 基于容器的应用不断增多，产生了对容器集群管理的需求—Kubernetes</p>
<p>3、应用升级回滚对容器集群管理的需求—Kubernetes</p>
<p>  4、应用的生命周期管理可以完全由Kubernetes管理，用户将更多精力放到代码开发</p>
<h3 id="持续集成工具Jenkis与Kubernetes"><a href="#持续集成工具Jenkis与Kubernetes" class="headerlink" title="持续集成工具Jenkis与Kubernetes"></a>持续集成工具Jenkis与Kubernetes</h3><p> Jenkins与Kubernetes结合：基于Kubernetes部署Jenkins Master。在Jenkins Master 安装Kubernetes Plugin，并下载Jenkins Slave 镜像。Jenkins的任务通过Jenkins Plugin 转化为Kubernetes Pod 模板，Kubernetes 根据Pod 模板自动拉起Slave容器，Slave容器会自动加入Jenkins 集群。Jenkins 执行任务时，自动调度Job到某个Slave容器，任务结束后，Jenkins自动删除相关街道，并销毁对应容器，实现资源释放。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Discuz-%E8%AE%BA%E5%9D%9B%E8%AF%84%E8%AE%BA%E5%9B%9E%E5%A4%8D%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Discuz-%E8%AE%BA%E5%9D%9B%E8%AF%84%E8%AE%BA%E5%9B%9E%E5%A4%8D%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">Discuz 论坛评论回复代码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:52:58 / 修改时间：19:59:12" itemprop="dateCreated datePublished" datetime="2020-09-21T19:52:58+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>         本来想着刷下积分，换点礼品，结果居然好有限制。附上代码。更新代码，增加摇一摇赚取浪花的功能。找了台服务器，摇浪花啦。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">#-\*-coding:utf-8-\*-</span><br><span class="line">import urllib2, urllib, cookielib</span><br><span class="line">import re</span><br><span class="line">import getpass</span><br><span class="line">import sqlite3</span><br><span class="line">import urlparse</span><br><span class="line">import random</span><br><span class="line">import time</span><br><span class="line">import PyV8</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">class Discuz:</span><br><span class="line">    def \_\_init\_\_(self,user,pwd,args):</span><br><span class="line">        self.username &#x3D; user</span><br><span class="line">        self.password &#x3D; pwd</span><br><span class="line">        self.args &#x3D; args</span><br><span class="line">        self.regex &#x3D; &#123;</span><br><span class="line">            &#39;loginreg&#39;:&#39;&lt;input\\s\*type&#x3D;&quot;hidden&quot;\\s\*name&#x3D;&quot;formhash&quot;\\s\*value&#x3D;&quot;(\[\\w\\W\]+?)&quot;\\s\*\\&#x2F;&gt;&#39;,</span><br><span class="line">            #input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;formhash&quot; value&#x3D;&quot;7f420ac4&quot;</span><br><span class="line">            &#39;replyreg&#39;:&#39;&lt;input\\s\*type&#x3D;&quot;hidden&quot;\\s\*name&#x3D;&quot;formhash&quot;\\s\*value&#x3D;&quot;(\[\\w\\W\]+?)&quot;\\s\*\\&#x2F;&gt;&#39;,</span><br><span class="line">            &#39;tidreg&#39;: &#39;&lt;tbody\\s\*id&#x3D;&quot;normalthread\_\\d+&quot;&gt;\[\\s\\S\]+?&lt;span\\s\*id&#x3D;&quot;thread\_(\\d+)&quot;&gt;&#39;,</span><br><span class="line">            &#39;subform&#39;:&#39;&lt;a href&#x3D;&quot;forum.php\\?mod&#x3D;forumdisplay&amp;fid&#x3D;\\d+&quot;&gt;\\S+&lt;&#x2F;a&gt;&#39;,</span><br><span class="line">            &#39;topidreg&#39;:&#39;&lt;a href&#x3D;&quot;forum.php\\?mod&#x3D;viewthread&amp;tid&#x3D;\\d+&amp;extra&#x3D;page%3D1&quot; onclick&#x3D;&quot;atarget\\(this\\)&quot; class&#x3D;&quot;s xst&quot;&gt;\\S+&lt;&#x2F;a&gt;&#39;</span><br><span class="line">        &#125;</span><br><span class="line">        self.subform&#x3D;\[&#39;OpenStack&#39;,u&#39;云服务&#39;,u&#39;云管理&#39;,&#39;hadoop&#39;,&#39;storm&#39;,&#39;spark&#39;\]</span><br><span class="line">        self.conn &#x3D; None</span><br><span class="line">        self.cur &#x3D; None</span><br><span class="line">        self.islogin &#x3D; False</span><br><span class="line">        self.login()</span><br><span class="line">        self.InitDB()</span><br><span class="line"></span><br><span class="line">    def login(self):</span><br><span class="line">        try:</span><br><span class="line">            loginPage &#x3D; urllib2.urlopen(self.args\[&#39;loginurl&#39;\]).read()</span><br><span class="line">            print &#39;start login...&#39;</span><br><span class="line">            cj &#x3D; cookielib.CookieJar()</span><br><span class="line">            opener &#x3D; urllib2.build\_opener(urllib2.HTTPCookieProcessor(cj))</span><br><span class="line">            user\_agent &#x3D; &#39;Mozilla&#x2F;4.0 (compatible; MSIE 6.0; Windows NT 5.1; Mozilla&#x2F;4.0 \\</span><br><span class="line">                    (compatible; MSIE 6.0; Windows NT 5.1; SV1) ; .NET CLR 2.0.507&#39;</span><br><span class="line">            opener.addheaders &#x3D; \[(&#39;User-agent&#39;, user\_agent)\]</span><br><span class="line">            urllib2.install\_opener(opener)</span><br><span class="line">            logindata &#x3D; urllib.urlencode(&#123;</span><br><span class="line">                &#39;cookietime&#39;:    2592000,</span><br><span class="line">               # &#39;formhash&#39;: formhash,</span><br><span class="line">                &#39;loginfield&#39;:&#39;username&#39;,</span><br><span class="line">                &#39;username&#39;:    self.username,</span><br><span class="line">                &#39;password&#39;:    self.password,</span><br><span class="line">                &#39;quickforward&#39;:    &#39;yes&#39;,</span><br><span class="line">                &#39;fastloginfield&#39;:&#39;username&#39;,</span><br><span class="line">                &#39;handlekey&#39;:&#39;ls&#39;,</span><br><span class="line">                &#39;referer&#39;: self.args\[&#39;referer&#39;\]</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">            request &#x3D; urllib2.Request(self.args\[&#39;loginsubmiturl&#39;\],logindata)</span><br><span class="line">            response &#x3D; urllib2.urlopen(request)</span><br><span class="line">            self.islogin &#x3D; True</span><br><span class="line">            print &#39;login success...&#39;</span><br><span class="line">        except Exception,e:</span><br><span class="line">                print &#39;loggin error: %s&#39; % e</span><br><span class="line"></span><br><span class="line">    def PostReply(self, fid, tid, topicUrl,content):</span><br><span class="line">        try:</span><br><span class="line">            if self.islogin:</span><br><span class="line">                temp&#x3D;self.args\[&#39;replysubmiturl&#39;\]</span><br><span class="line">                replysubmiturl &#x3D; temp %(fid,tid)</span><br><span class="line">                response &#x3D; urllib2.urlopen(topicUrl)</span><br><span class="line">                content11 &#x3D; response.read()</span><br><span class="line">               # print content11</span><br><span class="line">                # update url</span><br><span class="line">                url&#x3D;self.getNewUrlFromJs(content11);</span><br><span class="line">                newTopicUrl&#x3D; self.args\[&#39;redirectBaseUrl&#39;\]+url</span><br><span class="line">                response &#x3D; urllib2.urlopen(newTopicUrl)</span><br><span class="line">                content11 &#x3D; response.read()</span><br><span class="line">                formhashs &#x3D; re.search(self.regex\[&#39;replyreg&#39;\], content11)</span><br><span class="line">                formhash&#x3D; formhashs.group(1)</span><br><span class="line">                print formhash</span><br><span class="line">                replydata &#x3D; urllib.urlencode(&#123;</span><br><span class="line">                    &#39;formhash&#39;: formhash,</span><br><span class="line">                    &#39;message&#39;: content,</span><br><span class="line">                    &#39;subject&#39;: &#39;&#39;,</span><br><span class="line">                    &#39;usesig&#39;:&#39;1&#39;</span><br><span class="line">                &#125;)</span><br><span class="line">                request &#x3D; urllib2.Request(replysubmiturl,replydata)</span><br><span class="line">                response &#x3D; urllib2.urlopen(request)</span><br><span class="line">                print &#39;reply success for \[%s\]&#39; % topicUrl</span><br><span class="line">            else:</span><br><span class="line">                print &#39;user not login&#39;</span><br><span class="line">        except Exception, e:</span><br><span class="line">                print &#39;reply error: %s&#39; % e</span><br><span class="line"></span><br><span class="line">    def GetSubForms(self):</span><br><span class="line">        if self.islogin:</span><br><span class="line">            fidurl &#x3D; self.args\[&#39;fidurl&#39;\]</span><br><span class="line">            response &#x3D; urllib2.urlopen(fidurl)</span><br><span class="line">            content &#x3D; response.read()</span><br><span class="line">            soup &#x3D; BeautifulSoup(content,&quot;html.parser&quot;)</span><br><span class="line">            h1userSoupList&#x3D;soup.findAll(name&#x3D;&quot;a&quot;, attrs&#x3D;&#123;&quot;href&quot;:re.compile(r&quot;forum.php\\?mod&#x3D;forumdisplay&amp;fid&#x3D;\\d+&quot;)&#125;)</span><br><span class="line">            subformDicts&#x3D;&#123;&#125;</span><br><span class="line">            for subform in h1userSoupList:</span><br><span class="line">                if subform.get\_text() in self.subform:</span><br><span class="line">                   # subforms.append(self.args\[&#39;baseUrl&#39;\]+subform\[&quot;href&quot;\])</span><br><span class="line">                    url&#x3D;self.args\[&#39;baseUrl&#39;\]+subform\[&quot;href&quot;\]</span><br><span class="line">                    result&#x3D;urlparse.urlparse(url)</span><br><span class="line">                    params&#x3D;urlparse.parse\_qs(result.query,True)</span><br><span class="line">                    tag&#x3D; params\[&#39;fid&#39;\]\[0\]</span><br><span class="line">                    subformDicts\[tag\]&#x3D;url</span><br><span class="line">            return subformDicts</span><br><span class="line">        else:</span><br><span class="line">            print &#39;Error Please Login...&#39;</span><br><span class="line"></span><br><span class="line">    def getNewUrlFromJs(self,js):</span><br><span class="line">       js&#x3D;js\[31:-9\]</span><br><span class="line">       for st in \[&#39;window&#39;,&#39;location&#39;,&quot;&#39;assign&#39;&quot;,&quot;&#39;href&#39;&quot;,&quot;&#39;replace&#39;&quot;\]:</span><br><span class="line">            equal&#x3D;re.findall(&#39;\[\_A-Za-z0-9 &#x3D;\]+%s;&#39;%st,js)</span><br><span class="line">            if equal&#x3D;&#x3D;\[\]:</span><br><span class="line">                continue</span><br><span class="line">            else:</span><br><span class="line">               equal&#x3D;equal\[0\]</span><br><span class="line">               var&#x3D;equal.split(&#39;&#x3D;&#39;)\[0\].strip()</span><br><span class="line">               js&#x3D;js.replace(equal,&#39;&#39;)</span><br><span class="line">               js&#x3D;js.replace(var,st)</span><br><span class="line">               js&#x3D;js.replace(&quot;\[&#39;%s&#39;\]&quot;%st.strip(&quot;&#39;&quot;),&#39;.%s&#39;%st.strip(&quot;&#39;&quot;))</span><br><span class="line">       if re.findall(&#39;window\\.href&#x3D;.+&#39;,js)!&#x3D;\[\]:</span><br><span class="line">           js&#x3D;js.replace(re.findall(&#39;window\\.href&#x3D;.+&#39;,js)\[0\],&#39;&#39;)</span><br><span class="line">       js&#x3D;js.replace(&#39;location.href&#x3D;&#39;,&#39;&#39;).replace(&#39;location.replace&#39;,&#39;&#39;).replace(&#39;location.assign&#39;,&#39;&#39;)</span><br><span class="line">       ctxt2 &#x3D; PyV8.JSContext()</span><br><span class="line">       ctxt2.enter()</span><br><span class="line">       return ctxt2.eval(js)</span><br><span class="line"></span><br><span class="line">    def haveAGoodLuck(self):</span><br><span class="line">        luckurl&#x3D;&#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;&#x2F;plugin.php?id&#x3D;yinxingfei\_zzza:yinxingfei\_zzza\_hall&amp;yjjs&#x3D;yes&#39;</span><br><span class="line">        response &#x3D; urllib2.urlopen(luckurl)</span><br><span class="line">        content &#x3D; response.read()</span><br><span class="line">        formhashs &#x3D; re.search(self.regex\[&#39;replyreg&#39;\], content)</span><br><span class="line">        formhash&#x3D; formhashs.group(1)</span><br><span class="line">        soup &#x3D; BeautifulSoup(content,&quot;html.parser&quot;)</span><br><span class="line">        submitUrl2&#x3D;&#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;&#x2F;plugin.php?id&#x3D;yinxingfei\_zzza:yinxingfei\_zzza\_post&#39;</span><br><span class="line">        replydata &#x3D; urllib.urlencode(&#123;</span><br><span class="line">                    &#39;formhash&#39;: formhash</span><br><span class="line">                &#125;)</span><br><span class="line">        request &#x3D; urllib2.Request(submitUrl2,replydata)</span><br><span class="line">        response &#x3D; urllib2.urlopen(request)</span><br><span class="line"> </span><br><span class="line">    def visitUser(self):</span><br><span class="line">        baseUrl&#x3D;&#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;?%s&#39;</span><br><span class="line">        for i in range(1,10):</span><br><span class="line">            randNum&#x3D;random.randint(1, 200)</span><br><span class="line">            visitUrl&#x3D;baseUrl %(randNum)</span><br><span class="line">            response &#x3D; urllib2.urlopen(visitUrl)</span><br><span class="line">            content &#x3D; response.read()</span><br><span class="line">            print visitUrl</span><br><span class="line">    def InitDB(self):</span><br><span class="line">        self.conn &#x3D; sqlite3.connect(&#39;data.db&#39;)</span><br><span class="line">        self.cur &#x3D; self.conn.cursor()</span><br><span class="line">        sql &#x3D; &#39;&#39;&#39;create table if not exists post (</span><br><span class="line">            fid text,</span><br><span class="line">            tid text,</span><br><span class="line">            replied integer)&#39;&#39;&#39;</span><br><span class="line">        self.cur.execute(sql)</span><br><span class="line">        self.conn.commit()</span><br><span class="line"></span><br><span class="line">    def getTopicList(self,sunFormUrl):</span><br><span class="line">         topicDis&#x3D;&#123;&#125;</span><br><span class="line">         if self.islogin:</span><br><span class="line">            fidurl &#x3D; sunFormUrl</span><br><span class="line">            response &#x3D; urllib2.urlopen(fidurl)</span><br><span class="line">            content &#x3D; response.read()</span><br><span class="line">            soup &#x3D; BeautifulSoup(content,&quot;html.parser&quot;)</span><br><span class="line">            h1userSoupList&#x3D;soup.findAll(name&#x3D;&quot;a&quot;, attrs&#x3D;&#123;&quot;href&quot;: re.compile(r&quot;forum.php\\?mod&#x3D;viewthread\\&amp;&quot;),&quot;onclick&quot;:&quot;atarget(this)&quot;&#125;)</span><br><span class="line">            for topic in h1userSoupList:</span><br><span class="line">                 #topics.append(self.args\[&#39;baseUrl&#39;\]+topic\[&quot;href&quot;\])</span><br><span class="line">                 url&#x3D;self.args\[&#39;baseUrl&#39;\]+topic\[&quot;href&quot;\]</span><br><span class="line">                 result&#x3D;urlparse.urlparse(url)</span><br><span class="line">                 params&#x3D;urlparse.parse\_qs(result.query,True)</span><br><span class="line">                 topicDis\[params\[&#39;tid&#39;\]\[0\]\]&#x3D;url</span><br><span class="line">            return topicDis</span><br><span class="line">         else:</span><br><span class="line">             print &#39;user doest not login&#39;</span><br><span class="line"></span><br><span class="line">if \_\_name\_\_ &#x3D;&#x3D; &#39;\_\_main\_\_&#39;:</span><br><span class="line">    #username &#x3D; raw\_input(&#39;username:&#39;).strip()</span><br><span class="line">    #password &#x3D; getpass.getpass(&#39;password:&#39;).strip()</span><br><span class="line">    args &#x3D; &#123;</span><br><span class="line">            &#39;loginurl&#39;: &#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;forum.php&#39;,</span><br><span class="line">            &#39;loginsubmiturl&#39;: &#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;member.php?mod&#x3D;logging&amp;action&#x3D;login&amp;loginsubmit&#x3D;yes&amp;infloat&#x3D;yes&amp;lssubmit&#x3D;yes&amp;inajax&#x3D;1&#39;,</span><br><span class="line">            &#39;fidurl&#39;: &#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;forum.php&#39;,</span><br><span class="line">            &#39;tidurl&#39;: &#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;thread-%s-1-1.html&#39;,</span><br><span class="line">            &#39;replysubmiturl&#39;: &#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;&#x2F;forum.php?mod&#x3D;post&amp;action&#x3D;reply&amp;fid&#x3D;%s&amp;tid&#x3D;%s&amp;extra&#x3D;&amp;replysubmit&#x3D;yes&amp;infloat&#x3D;yes&amp;handlekey&#x3D;fastpost&amp;inajax&#x3D;1&#39;,</span><br><span class="line">            &#39;referer&#39;:&#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;forum.php&#39; ,</span><br><span class="line">            &#39;baseUrl&#39;:&#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;iop&#x2F;&#39;,</span><br><span class="line">             &#39;redirectBaseUrl&#39;: &#39;http:&#x2F;&#x2F;bbs.iop365.com&#x2F;&#39;&#125;</span><br><span class="line">    userInfo&#x3D;&#123;&#39;wangdk&#39;:&#39;\*\*\*\*&#39;&#125;</span><br><span class="line">    for (username,password) in userInfo.items():</span><br><span class="line">        dz &#x3D; Discuz(username, password,args)</span><br><span class="line">        subforms &#x3D; dz.GetSubForms()</span><br><span class="line">        dz.visitUser()</span><br><span class="line">        topicNum&#x3D;0</span><br><span class="line">        allTopics&#x3D;&#123;&#125;</span><br><span class="line">        for fid in subforms:</span><br><span class="line">          topics&#x3D;dz.getTopicList(subforms\[fid\])</span><br><span class="line">          for tid in topics:</span><br><span class="line">               topicNum&#x3D;topicNum+1</span><br><span class="line">               allTopics\[topicNum\]&#x3D;&#123;&#39;fid&#39;:fid,&#39;tid&#39;:tid,&#39;topicUrl&#39;:topics\[tid\]&#125;</span><br><span class="line">        randNum&#x3D;random.randint(1, topicNum)</span><br><span class="line">        print  &#39;good luck time&#x3D;%s&#39;,time.strftime( &quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime() )</span><br><span class="line">        dz.PostReply(allTopics\[randNum\]\[&#39;fid&#39;\],allTopics\[randNum\]\[&#39;tid&#39;\],allTopics\[randNum\]\[&#39;topicUrl&#39;\],&#39;guanshui,haha&#39;)</span><br><span class="line">        print &#39;topicUrl %s&#39;,allTopics\[randNum\]\[&#39;topicUrl&#39;\]</span><br><span class="line">        dz.haveAGoodLuck()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://damonyi.cc/2020/09/21/Docker%E4%BB%A5%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0Pipework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="雾里云里">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云里雾里">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/09/21/Docker%E4%BB%A5%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0Pipework/" class="post-title-link" itemprop="url">Docker以网络插件方式实现Pipework</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-09-21 19:48:54 / 修改时间：19:59:12" itemprop="dateCreated datePublished" datetime="2020-09-21T19:48:54+08:00">2020-09-21</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  Docker目前提供了多种网络模式，但是相信大部分运维人员还是比较相信物理网络，所以就想着将容器的网络配置成物理网络。可以看到开源项目<a target="_blank" rel="noopener" href="https://github.com/jpetazzo/pipework">Pipework</a>，当然 Pipework的功能比较强大，这里我只关注容器使用物理网络的实现，如果你手动去配置容器的IP，可以只需要以下几个步骤：</p>
<p>1、创建网桥并配置，将eth0绑定到网桥br0，Docker Daemon 监听br0</p>
<p>2、启动容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net&#x3D;none --name web  10.110.17.138:5000&#x2F;library&#x2F;tomcat:7.0.67-jre7</span><br></pre></td></tr></table></figure>
<p>3、创建Container对应的网络命名空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;run&#x2F;netns</span><br><span class="line">ln -s &#x2F;proc&#x2F;1381&#x2F;ns&#x2F;net &#x2F;var&#x2F;run&#x2F;netns&#x2F;1381</span><br></pre></td></tr></table></figure>
<p>4、容器配置网卡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip link add veth-a type veth peer name veth-b</span><br><span class="line">brctl addif br0 veth-a</span><br><span class="line">ip link set veth-a up</span><br><span class="line">ip link set veth-b netns 1381</span><br><span class="line">ip netns exec 1381 ip link set dev veth-b name eth0 </span><br><span class="line">ip netns exec 1381 ip link set eth0 up</span><br><span class="line">ip netns exec 1381 ip addr add 10.110.17.94&#x2F;24 dev eth0 </span><br><span class="line">ip netns exec 1381 ip route del default</span><br><span class="line">ip netns exec 1381 ip route add default via 10.110.17.254</span><br></pre></td></tr></table></figure>
<p>    不是很复杂，业务系统可以定义一个脚本执行就OK，但是我们再开发使用过程中发现，当我们想着将这种网络模式运用到Compose时，却发现用不了，但是Compose支持Docker 的网络插件机制，所以就需要考虑使用<a target="_blank" rel="noopener" href="https://github.com/docker/libnetwork/blob/master/docs/remote.md">Docker的网络插件机制</a>实现。参考了<a target="_blank" rel="noopener" href="https://github.com/weaveworks/weave">Weave</a>和<a target="_blank" rel="noopener" href="https://github.com/gopher-net/docker-ovs-plugin">ovs-plugin</a>的实现方式，整理出了Docker使用物理网络的插件<a target="_blank" rel="noopener" href="https://github.com/davidstack/docker-network-plugin-local.git">docker-network-plugin-local</a>，当然github上开源的仅仅是网络配置OK，和我们生产环境上的肯定有所区别，不过大家可以参考，在这里说一下几处关键代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func (driver \*PipeNetworkDriver) CreateNetwork(createNetworkRequest \*network.CreateNetworkRequest) error &#123;</span><br><span class="line">	GlobalEndPointCache.Mutex.Lock()</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		GlobalEndPointCache.Mutex.Unlock()</span><br><span class="line">	&#125;()</span><br><span class="line">	gateway, mask, \_ :&#x3D; getGatewayIP(createNetworkRequest)</span><br><span class="line">	networkInfo :&#x3D; NetworkInfo&#123;BridgeName: &quot;br0&quot;,</span><br><span class="line">		Gateway:            gateway,</span><br><span class="line">		GatewayMask:        mask,</span><br><span class="line">		ContainerInterface: &quot;eth1&quot;,</span><br><span class="line">		MTU:                1500,</span><br><span class="line">		NetWorkId:          createNetworkRequest.NetworkID,</span><br><span class="line">	&#125;</span><br><span class="line">	GlobalEndPointCache.EndPoints &#x3D; make(map\[string\]\*EndPoint)</span><br><span class="line">	GlobalEndPointCache.Network &#x3D; &amp;networkInfo</span><br><span class="line">	driver.UpdateCacheFile()</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 此处是命令行执行docker network create 时调用的API，这个插件是将网络信息缓存到了本地，其他什么也没有做（如果你想在集群环境中使用，可以修改此处，将网络信息保存到Etcd数据库）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func (driver \*PipeNetworkDriver) CreateEndpoint(createEndpointRequest \*network.CreateEndpointRequest) (\*network.CreateEndpointResponse, error) &#123;</span><br><span class="line">	fmt.Println(&quot;create endpoint&quot;)</span><br><span class="line">	GlobalEndPointCache.Mutex.Lock()</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		GlobalEndPointCache.Mutex.Unlock()</span><br><span class="line">	&#125;()</span><br><span class="line">	endPointId :&#x3D; createEndpointRequest.EndpointID</span><br><span class="line">	ipaddress :&#x3D; createEndpointRequest.Interface.Address</span><br><span class="line">	vethPairTag :&#x3D; truncateID(endPointId)</span><br><span class="line">	vethPariA :&#x3D; vethPairTag + &quot;-a&quot;</span><br><span class="line">	vethPariB :&#x3D; vethPairTag + &quot;-b&quot;</span><br><span class="line">	endPoint :&#x3D; EndPoint&#123;EndpointID: endPointId,</span><br><span class="line">		Address:      ipaddress,</span><br><span class="line">		VethName:     vethPariA,</span><br><span class="line">		VethPeerName: vethPariB&#125;</span><br><span class="line">	GlobalEndPointCache.EndPoints\[endPointId\] &#x3D; &amp;endPoint</span><br><span class="line">	driver.UpdateCacheFile()</span><br><span class="line">	return nil, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>此处是在创建容器时，指定driver时调用的API，该插件只是定义了需要创建的link 对（veth pair），然后缓存起来</p>
<pre><code>func (driver \*PipeNetworkDriver) Join(joinRequest \*network.JoinRequest) (\*network.JoinResponse, error) &#123;
    fmt.Println(&quot;joing....&quot;)
    fmt.Println(&quot;NetworkID is &quot;, joinRequest.NetworkID)
    fmt.Println(&quot;SandboxKey is &quot;, joinRequest.SandboxKey)

    GlobalEndPointCache.Mutex.Lock()
    defer func() &#123;
        GlobalEndPointCache.Mutex.Unlock()
    &#125;()
    //query from cache
    endPointInfo := GlobalEndPointCache.EndPoints\[joinRequest.EndpointID\]
    fmt.Println(&quot;vethPairA is &quot;, endPointInfo.VethName)
    fmt.Println(&quot;vethPairB is &quot;, endPointInfo.VethPeerName)

    localVethPair := vethPair(endPointInfo.VethName, endPointInfo.VethPeerName)
    if err := netlink.LinkAdd(localVethPair); err != nil &#123;
        fmt.Println(&quot;failed to create the veth pair named: \[ %v \] error: \[ %s \] &quot;, localVethPair, err)
        return nil, err
    &#125;
    fmt.Println(&quot;localVethPair.Name is &quot;, localVethPair.Name)
    // 2. add vethPariA to bridge and set up
    createdLink, linkErr := netlink.LinkByName(localVethPair.Name)
    if linkErr != nil &#123;
        fmt.Println(&quot;find link failed&quot;, linkErr)
        return nil, linkErr
    &#125;
    netinterface := net.Interface&#123;Index: createdLink.Attrs().Index,
        Name:         createdLink.Attrs().Name,
        MTU:          createdLink.Attrs().MTU,
        Flags:        createdLink.Attrs().Flags,
        HardwareAddr: createdLink.Attrs().HardwareAddr&#125;

    br, err := tenus.BridgeFromName(GlobalEndPointCache.Network.BridgeName)
    if err != nil &#123;
        fmt.Println(&quot;use exist bridge failed&quot;, err)
        return nil, err
    &#125;

    if err = br.AddSlaveIfc(&amp;netinterface); err != nil &#123;
        fmt.Println(&quot;add interface to bridge failed&quot;, err)
    &#125;
    err = netlink.LinkSetUp(createdLink)
    if err != nil &#123;
        fmt.Println(&quot;Error enabling  Veth local iface: \[ %v \]&quot;, localVethPair)
        return nil, err
    &#125;
    response := network.JoinResponse&#123;InterfaceName: network.InterfaceName&#123;SrcName: endPointInfo.VethPeerName,
        DstPrefix: &quot;eth&quot;&#125;,
        Gateway: GlobalEndPointCache.Network.Gateway,
    &#125;
    GlobalEndPointCache.EndPoints\[joinRequest.EndpointID\].SandboxKey = joinRequest.SandboxKey
    driver.UpdateCacheFile()
    return &amp;response, nil
&#125;</code></pre>
<p>        <br>此处代码也是在docker 创建/启动容器时调用的API，该API完成link对的创建，并未改link（在容器内部的部分）配置IP，定义网卡名称，此处最重要的是返回值中将正确的vethpari那么返回，docker daemon会将veth pair加入到容器的网络空间 （PS：开始验证的时候，一直尝试自己将这个veth pair加入到命名空间，总是不成功，后来才发现，Docker Daemon 已经把这件事干了）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">205k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:06</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
